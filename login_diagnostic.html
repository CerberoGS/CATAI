<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DiagnÃ³stico de Login - CATAI</title>
  <script src="static/js/config-portable.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 2rem; }
    .card { max-width: 800px; padding: 1.5rem; border: 1px solid #ddd; border-radius: 8px; margin: 0 auto; }
    .test-section { margin: 1rem 0; padding: 1rem; border: 1px solid #eee; border-radius: 6px; }
    .test-section h3 { margin-top: 0; color: #333; }
    .success { color: #0b5; font-weight: bold; }
    .error { color: #b00; font-weight: bold; }
    .warning { color: #f80; font-weight: bold; }
    button { margin: 0.5rem 0.5rem 0.5rem 0; padding: 0.6rem 1rem; background:#0b5; color:white; border:none; border-radius:6px; cursor:pointer; }
    button:hover { background: #0a4; }
    pre { background: #f5f5f5; padding: 1rem; border-radius: 4px; overflow-x: auto; font-size: 0.9em; }
    .status { padding: 0.5rem; border-radius: 4px; margin: 0.5rem 0; }
    .status.success { background: #d4edda; border: 1px solid #c3e6cb; }
    .status.error { background: #f8d7da; border: 1px solid #f5c6cb; }
    .status.warning { background: #fff3cd; border: 1px solid #ffeaa7; }
  </style>
</head>
<body>
  <div class="card">
    <h1>ğŸ”§ DiagnÃ³stico de Login - CATAI</h1>
    <p>Esta pÃ¡gina diagnostica problemas con el sistema de login.</p>
    
    <div class="test-section">
      <h3>ğŸ§ª Tests de DiagnÃ³stico</h3>
      <button onclick="runLoginDiagnostic()">ğŸ” Ejecutar DiagnÃ³stico Completo</button>
      <button onclick="testUltraSimple()">âš¡ Test Ultra Simple</button>
      <button onclick="testConfigSimple()">âš™ï¸ Probar Config Simple</button>
      <button onclick="testHtaccess()">ğŸ”§ Test .htaccess</button>
      <button onclick="testMinimalRequire()">ğŸ” Test Require MÃ­nimo</button>
      <button onclick="testConfigSimpleLoad()">âš™ï¸ Test Config Simple Load</button>
      <button onclick="createTestUser()">ğŸ‘¤ Crear Usuario de Prueba</button>
      <button onclick="updateTestUserPassword()">ğŸ”‘ Actualizar ContraseÃ±a de Usuario</button>
      <button onclick="testLoginWithUser()">ğŸ” Test Login con Usuario</button>
      <button onclick="testWithJwt()">ğŸ« Test con JWT</button>
      <button onclick="testComplexEndpoint()">ğŸ”§ Test Endpoint Complejo</button>
      <button onclick="testUltraSimpleComplex()">âš¡ Test Ultra Simple Complejo</button>
      <button onclick="testIndividualFiles()">ğŸ“ Test Archivos Individuales</button>
      <button onclick="testNoRequire()">ğŸš« Test Sin Require</button>
      <button onclick="testCleanBuffer()">ğŸ§¹ Test Buffer Limpio</button>
      <button onclick="testDeepDiagnostic()">ğŸ”¬ DiagnÃ³stico Profundo</button>
      <button onclick="testDeepDiagnosticV2()">ğŸ”¬ DiagnÃ³stico Profundo V2</button>
      <button onclick="testStepByStep()">ğŸ” Test Paso a Paso</button>
      <button onclick="testAuthDebug()">ğŸ”§ Debug de Auth</button>
      <button onclick="testLoginEndpoint()">ğŸ” Probar Endpoint de Login</button>
      <button onclick="testRegisterEndpoint()">ğŸ“ Probar Endpoint de Registro</button>
      <button onclick="clearResults()">ğŸ—‘ï¸ Limpiar Resultados</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    function clearResults() {
      document.getElementById('results').innerHTML = '';
    }

    function addResult(title, content, type = 'info') {
      const results = document.getElementById('results');
      const div = document.createElement('div');
      div.className = `test-section status ${type}`;
      div.innerHTML = `<h3>${title}</h3><pre>${content}</pre>`;
      results.appendChild(div);
    }

    async function runLoginDiagnostic() {
      addResult('ğŸ” Ejecutando DiagnÃ³stico...', 'Iniciando tests de diagnÃ³stico...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_login_diagnostic_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… DiagnÃ³stico Completado', JSON.stringify(data, null, 2), 'success');
          
          // AnÃ¡lisis especÃ­fico
          const analysis = analyzeDiagnostic(data.diagnostic);
          addResult('ğŸ“Š AnÃ¡lisis de Resultados', analysis, 'info');
        } else {
          addResult('âŒ Error en DiagnÃ³stico', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n', `Error: ${error.message}`, 'error');
      }
    }

    function analyzeDiagnostic(diagnostic) {
      let analysis = '';
      
      // AnÃ¡lisis de configuraciÃ³n
      if (diagnostic.config) {
        analysis += 'ğŸ“‹ CONFIGURACIÃ“N:\n';
        analysis += `- Base URL: ${diagnostic.config.base_url}\n`;
        analysis += `- API Base URL: ${diagnostic.config.api_base_url}\n`;
        analysis += `- DB Host: ${diagnostic.config.db_host}\n`;
        analysis += `- JWT Secret: ${diagnostic.config.jwt_secret_set ? 'CONFIGURADO' : 'NO CONFIGURADO'}\n\n`;
      }

      // AnÃ¡lisis de base de datos
      if (diagnostic.database) {
        analysis += 'ğŸ—„ï¸ BASE DE DATOS:\n';
        analysis += `- ConexiÃ³n: ${diagnostic.database.db_connection}\n`;
        if (diagnostic.database.error) {
          analysis += `- Error: ${diagnostic.database.error}\n`;
        }
        analysis += '\n';
      }

      // AnÃ¡lisis de tabla users
      if (diagnostic.users_table) {
        analysis += 'ğŸ‘¥ TABLA USERS:\n';
        analysis += `- Existe: ${diagnostic.users_table.table_exists ? 'SÃ' : 'NO'}\n`;
        if (diagnostic.users_table.user_count !== undefined) {
          analysis += `- Usuarios: ${diagnostic.users_table.user_count}\n`;
        }
        if (diagnostic.users_table.error) {
          analysis += `- Error: ${diagnostic.users_table.error}\n`;
        }
        analysis += '\n';
      }

      // AnÃ¡lisis de JWT
      if (diagnostic.jwt_functions) {
        analysis += 'ğŸ” JWT:\n';
        analysis += `- jwt_sign: ${diagnostic.jwt_functions.jwt_sign}\n`;
        analysis += `- jwt_verify: ${diagnostic.jwt_functions.jwt_verify || 'NO PROBADO'}\n`;
        if (diagnostic.jwt_functions.error) {
          analysis += `- Error: ${diagnostic.jwt_functions.error}\n`;
        }
        analysis += '\n';
      }

      // Recomendaciones
      analysis += 'ğŸ’¡ RECOMENDACIONES:\n';
      if (diagnostic.database?.db_connection === 'FAILED') {
        analysis += '- Verificar credenciales de base de datos en config.php\n';
      }
      if (!diagnostic.users_table?.table_exists) {
        analysis += '- Verificar que la tabla users existe en la base de datos\n';
      }
      if (diagnostic.jwt_functions?.jwt_sign === 'FUNCTION_NOT_FOUND') {
        analysis += '- Verificar que jwt.php estÃ¡ incluido correctamente\n';
      }
      if (diagnostic.config?.jwt_secret_set === false) {
        analysis += '- Configurar JWT_SECRET en config.php\n';
      }

      return analysis;
    }

    async function testLoginEndpoint() {
      addResult('ğŸ” Probando Endpoint de Login...', 'Enviando request de prueba...', 'info');
      
      try {
        const testData = {
          email: 'test@example.com',
          password: 'testpassword'
        };

        const response = await fetch(ConfigPortable.getApiUrl('auth_login.php'), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(testData)
        });

        const data = await response.json();
        
        if (response.status === 401 && data.error === 'invalid_credentials') {
          addResult('âœ… Endpoint de Login Funciona', 'El endpoint responde correctamente (credenciales invÃ¡lidas esperadas)', 'success');
        } else if (response.status === 500) {
          addResult('âŒ Error HTTP 500 en Login', JSON.stringify(data, null, 2), 'error');
        } else {
          addResult('âš ï¸ Respuesta Inesperada', JSON.stringify(data, null, 2), 'warning');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n', `Error: ${error.message}`, 'error');
      }
    }

    async function testUltraSimple() {
      addResult('âš¡ Probando Test Ultra Simple...', 'Verificando que PHP funciona...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_ultra_simple_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test Ultra Simple Funciona', JSON.stringify(data, null, 2), 'success');
        } else {
          addResult('âŒ Error en Test Ultra Simple', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Test Ultra Simple', `Error: ${error.message}`, 'error');
      }
    }

    async function testConfigSimple() {
      addResult('âš™ï¸ Probando Config Simple...', 'Verificando configuraciÃ³n bÃ¡sica...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_config_simple_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Config Simple Funciona', JSON.stringify(data, null, 2), 'success');
        } else {
          addResult('âŒ Error en Config Simple', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Config', `Error: ${error.message}`, 'error');
      }
    }

    async function testHtaccess() {
      addResult('ğŸ”§ Probando .htaccess...', 'Verificando configuraciÃ³n de rewrite...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_htaccess_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test .htaccess Completado', JSON.stringify(data, null, 2), 'success');
          
          // AnÃ¡lisis especÃ­fico del .htaccess
          if (data.htaccess_status === 'ISSUES_DETECTED') {
            addResult('âš ï¸ Problemas Detectados en .htaccess', data.rewrite_issues.join('\n'), 'warning');
          } else {
            addResult('âœ… .htaccess Configurado Correctamente', 'No se detectaron problemas de rewrite', 'success');
          }
        } else {
          addResult('âŒ Error en Test .htaccess', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en .htaccess', `Error: ${error.message}`, 'error');
      }
    }

    async function testMinimalRequire() {
      addResult('ğŸ” Probando Require MÃ­nimo...', 'Verificando problemas con require_once...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_minimal_require_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test Require MÃ­nimo Completado', JSON.stringify(data, null, 2), 'success');
          
          // AnÃ¡lisis especÃ­fico
          if (data.results) {
            const analysis = analyzeMinimalRequire(data.results);
            addResult('ğŸ“Š AnÃ¡lisis Require MÃ­nimo', analysis, 'info');
          }
        } else {
          addResult('âŒ Error en Test Require MÃ­nimo', JSON.stringify(data, null, 2), 'error');
          
          if (data.failed_at_test) {
            addResult('ğŸš¨ FallÃ³ en Test: ' + data.failed_at_test, `Error: ${data.error}`, 'error');
          }
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Require MÃ­nimo', `Error: ${error.message}`, 'error');
      }
    }

    async function testConfigSimpleLoad() {
      addResult('âš™ï¸ Probando Config Simple Load...', 'Verificando carga de config simplificado...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_config_simple_load_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Config Simple Load Funciona', JSON.stringify(data, null, 2), 'success');
        } else {
          addResult('âŒ Error en Config Simple Load', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Config Simple Load', `Error: ${error.message}`, 'error');
      }
    }

    async function createTestUser() {
      addResult('ğŸ‘¤ Creando Usuario de Prueba...', 'Creando usuario test@example.com...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('create_test_user_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Usuario de Prueba Creado', JSON.stringify(data, null, 2), 'success');
          
          if (data.action === 'created') {
            addResult('ğŸ‰ Nuevo Usuario Creado', `Email: ${data.credentials.email}\nPassword: ${data.credentials.password}`, 'success');
          } else {
            addResult('â„¹ï¸ Usuario Ya ExistÃ­a', `ID: ${data.user.id}\nEmail: ${data.user.email}`, 'info');
          }
        } else {
          addResult('âŒ Error Creando Usuario', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n Creando Usuario', `Error: ${error.message}`, 'error');
      }
    }

    async function updateTestUserPassword() {
      addResult('ğŸ”‘ Actualizando ContraseÃ±a de Usuario...', 'Actualizando contraseÃ±a del usuario test@example.com...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('update_test_user_password_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… ContraseÃ±a Actualizada', JSON.stringify(data, null, 2), 'success');
          
          if (data.password_test) {
            const test = data.password_test;
            addResult('ğŸ“Š Resultados de ActualizaciÃ³n', 
              `Hash actualizado: ${test.hash_updated ? 'âœ…' : 'âŒ'}\n` +
              `ContraseÃ±a vÃ¡lida: ${test.password_valid ? 'âœ…' : 'âŒ'}\n` +
              `Email: ${data.credentials.email}\n` +
              `Password: ${data.credentials.password}`, 'info');
          }
        } else {
          addResult('âŒ Error Actualizando ContraseÃ±a', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n Actualizando ContraseÃ±a', `Error: ${error.message}`, 'error');
      }
    }

    async function testLoginWithUser() {
      addResult('ğŸ” Probando Login con Usuario...', 'Verificando login con usuario de prueba...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_login_with_user_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Login con Usuario Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.login_test) {
            const test = data.login_test;
            addResult('ğŸ“Š Resultados del Test', 
              `Usuario encontrado: ${test.user_found ? 'âœ…' : 'âŒ'}\n` +
              `ContraseÃ±a vÃ¡lida: ${test.password_valid ? 'âœ…' : 'âŒ'}\n` +
              `Usuario activo: ${test.user_active ? 'âœ…' : 'âŒ'}\n` +
              `JWT creado: ${test.jwt_created ? 'âœ…' : 'âŒ'}`, 'info');
          }
        } else {
          addResult('âŒ Error en Login con Usuario', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Login con Usuario', `Error: ${error.message}`, 'error');
      }
    }

    async function testWithJwt() {
      addResult('ğŸ« Probando Test con JWT...', 'Verificando carga de archivos complejos con JWT...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_with_jwt_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test con JWT Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.file_loading) {
            const loading = data.file_loading;
            addResult('ğŸ“ Carga de Archivos', 
              `helpers.php: ${loading.helpers_loaded ? 'âœ…' : 'âŒ'}\n` +
              `db.php: ${loading.db_loaded ? 'âœ…' : 'âŒ'}\n` +
              `jwt.php: ${loading.jwt_loaded ? 'âœ…' : 'âŒ'}`, 'info');
            
            if (loading.helpers_error) {
              addResult('âš ï¸ Error en helpers.php', loading.helpers_error, 'warning');
            }
            if (loading.db_error) {
              addResult('âš ï¸ Error en db.php', loading.db_error, 'warning');
            }
            if (loading.jwt_error) {
              addResult('âš ï¸ Error en jwt.php', loading.jwt_error, 'warning');
            }
          }
          
          if (data.functions_exist) {
            const functions = data.functions_exist;
            addResult('ğŸ”§ Funciones Disponibles', 
              `json_out: ${functions.json_out ? 'âœ…' : 'âŒ'}\n` +
              `read_json_body: ${functions.read_json_body ? 'âœ…' : 'âŒ'}\n` +
              `jwt_sign: ${functions.jwt_sign ? 'âœ…' : 'âŒ'}\n` +
              `jwt_verify_hs256: ${functions.jwt_verify_hs256 ? 'âœ…' : 'âŒ'}\n` +
              `require_user: ${functions.require_user ? 'âœ…' : 'âŒ'}\n` +
              `db: ${functions.db ? 'âœ…' : 'âŒ'}`, 'info');
          }
          
          if (data.diagnosis) {
            const diag = data.diagnosis;
            addResult('ğŸ” DiagnÃ³stico Final', 
              `Todos los archivos cargados: ${diag.all_files_loaded ? 'âœ…' : 'âŒ'}\n` +
              `Todas las funciones existen: ${diag.all_functions_exist ? 'âœ…' : 'âŒ'}\n` +
              `Listo para endpoints complejos: ${diag.ready_for_complex_endpoints ? 'âœ…' : 'âŒ'}`, 
              diag.ready_for_complex_endpoints ? 'success' : 'warning');
          }
        } else {
          addResult('âŒ Error en Test con JWT', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Test con JWT', `Error: ${error.message}`, 'error');
      }
    }

    async function testComplexEndpoint() {
      addResult('ğŸ”§ Probando Test Endpoint Complejo...', 'Verificando carga completa de archivos con output...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_complex_endpoint_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test Endpoint Complejo Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.file_loading_tests) {
            const loading = data.file_loading_tests;
            addResult('ğŸ“ Tests de Carga de Archivos', 
              `config.php: ${loading.config_loaded ? 'âœ…' : 'âŒ'}\n` +
              `helpers.php: ${loading.helpers_loaded ? 'âœ…' : 'âŒ'}\n` +
              `db.php: ${loading.db_loaded ? 'âœ…' : 'âŒ'}\n` +
              `jwt.php: ${loading.jwt_loaded ? 'âœ…' : 'âŒ'}`, 'info');
            
            if (loading.config_error) {
              addResult('âš ï¸ Error en config.php', loading.config_error, 'warning');
            }
            if (loading.helpers_error) {
              addResult('âš ï¸ Error en helpers.php', loading.helpers_error, 'warning');
            }
            if (loading.db_error) {
              addResult('âš ï¸ Error en db.php', loading.db_error, 'warning');
            }
            if (loading.jwt_error) {
              addResult('âš ï¸ Error en jwt.php', loading.jwt_error, 'warning');
            }
          }
          
          if (data.function_tests) {
            const functions = data.function_tests;
            addResult('ğŸ”§ Tests de Funciones', 
              `require_user: ${functions.require_user_test ? 'âœ…' : 'âŒ'}\n` +
              `json_out: ${functions.json_out_test ? 'âœ…' : 'âŒ'}`, 'info');
            
            if (functions.require_user_error) {
              addResult('âš ï¸ Error en require_user', functions.require_user_error, 'warning');
            }
            if (functions.json_out_error) {
              addResult('âš ï¸ Error en json_out', functions.json_out_error, 'warning');
            }
          }
          
          if (data.output_analysis) {
            const output = data.output_analysis;
            addResult('ğŸ“Š AnÃ¡lisis de Output', 
              `config.php output: ${output.config_has_output ? 'âš ï¸' : 'âœ…'}\n` +
              `helpers.php output: ${output.helpers_has_output ? 'âš ï¸' : 'âœ…'}\n` +
              `db.php output: ${output.db_has_output ? 'âš ï¸' : 'âœ…'}\n` +
              `jwt.php output: ${output.jwt_has_output ? 'âš ï¸' : 'âœ…'}\n` +
              `Total output length: ${output.total_output_length}`, 'info');
          }
          
          if (data.diagnosis) {
            const diag = data.diagnosis;
            addResult('ğŸ” DiagnÃ³stico Final Complejo', 
              `Todos los archivos cargan: ${diag.all_files_load_successfully ? 'âœ…' : 'âŒ'}\n` +
              `Todas las funciones funcionan: ${diag.all_functions_work ? 'âœ…' : 'âŒ'}\n` +
              `Sin output inesperado: ${diag.no_unexpected_output ? 'âœ…' : 'âŒ'}\n` +
              `Listo para endpoints complejos: ${diag.ready_for_complex_endpoints ? 'âœ…' : 'âŒ'}`, 
              diag.ready_for_complex_endpoints ? 'success' : 'warning');
          }
        } else {
          addResult('âŒ Error en Test Endpoint Complejo', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Test Endpoint Complejo', `Error: ${error.message}`, 'error');
      }
    }

    async function testUltraSimpleComplex() {
      addResult('âš¡ Probando Test Ultra Simple Complejo...', 'Verificando carga bÃ¡sica de archivos...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_ultra_simple_complex_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test Ultra Simple Complejo Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.file_loading) {
            const loading = data.file_loading;
            addResult('ğŸ“ Carga de Archivos', 
              `config.php: ${loading.config_loaded ? 'âœ…' : 'âŒ'}\n` +
              `helpers.php: ${loading.helpers_loaded ? 'âœ…' : 'âŒ'}\n` +
              `db.php: ${loading.db_loaded ? 'âœ…' : 'âŒ'}\n` +
              `jwt.php: ${loading.jwt_loaded ? 'âœ…' : 'âŒ'}`, 'info');
            
            if (loading.config_error) {
              addResult('âš ï¸ Error en config.php', loading.config_error, 'warning');
            }
            if (loading.helpers_error) {
              addResult('âš ï¸ Error en helpers.php', loading.helpers_error, 'warning');
            }
            if (loading.db_error) {
              addResult('âš ï¸ Error en db.php', loading.db_error, 'warning');
            }
            if (loading.jwt_error) {
              addResult('âš ï¸ Error en jwt.php', loading.jwt_error, 'warning');
            }
          }
          
          if (data.functions_exist) {
            const functions = data.functions_exist;
            addResult('ğŸ”§ Funciones Disponibles', 
              `json_out: ${functions.json_out ? 'âœ…' : 'âŒ'}\n` +
              `require_user: ${functions.require_user ? 'âœ…' : 'âŒ'}\n` +
              `db: ${functions.db ? 'âœ…' : 'âŒ'}`, 'info');
          }
          
          if (data.diagnosis) {
            const diag = data.diagnosis;
            addResult('ğŸ” DiagnÃ³stico Final', 
              `Todos los archivos cargan: ${diag.all_files_loaded ? 'âœ…' : 'âŒ'}\n` +
              `Todas las funciones existen: ${diag.all_functions_exist ? 'âœ…' : 'âŒ'}\n` +
              `Listo para endpoints complejos: ${diag.ready_for_complex_endpoints ? 'âœ…' : 'âŒ'}`, 
              diag.ready_for_complex_endpoints ? 'success' : 'warning');
          }
        } else {
          addResult('âŒ Error en Test Ultra Simple Complejo', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Test Ultra Simple Complejo', `Error: ${error.message}`, 'error');
      }
    }

    async function testIndividualFiles() {
      addResult('ğŸ“ Probando Test Archivos Individuales...', 'Verificando cada archivo por separado...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_individual_files_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test Archivos Individuales Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.results) {
            const results = data.results;
            
            // Config
            addResult('âš™ï¸ Config.php', 
              `Cargado: ${results.config.loaded ? 'âœ…' : 'âŒ'}\n` +
              `Tipo: ${results.config.type || 'N/A'}\n` +
              `Claves: ${results.config.keys ? results.config.keys.length : 0}`, 
              results.config.loaded ? 'success' : 'error');
            
            if (results.config.error) {
              addResult('âš ï¸ Error en config.php', results.config.error, 'warning');
            }
            
            // Helpers
            addResult('ğŸ”§ Helpers.php', 
              `Cargado: ${results.helpers.loaded ? 'âœ…' : 'âŒ'}\n` +
              `json_out: ${results.helpers.functions?.json_out ? 'âœ…' : 'âŒ'}\n` +
              `require_user: ${results.helpers.functions?.require_user ? 'âœ…' : 'âŒ'}\n` +
              `read_json_body: ${results.helpers.functions?.read_json_body ? 'âœ…' : 'âŒ'}`, 
              results.helpers.loaded ? 'success' : 'error');
            
            if (results.helpers.error) {
              addResult('âš ï¸ Error en helpers.php', results.helpers.error, 'warning');
            }
            
            // DB
            addResult('ğŸ—„ï¸ DB.php', 
              `Cargado: ${results.db.loaded ? 'âœ…' : 'âŒ'}\n` +
              `db function: ${results.db.functions?.db ? 'âœ…' : 'âŒ'}`, 
              results.db.loaded ? 'success' : 'error');
            
            if (results.db.error) {
              addResult('âš ï¸ Error en db.php', results.db.error, 'warning');
            }
            
            // JWT
            addResult('ğŸ« JWT.php', 
              `Cargado: ${results.jwt.loaded ? 'âœ…' : 'âŒ'}\n` +
              `jwt_sign: ${results.jwt.functions?.jwt_sign ? 'âœ…' : 'âŒ'}\n` +
              `jwt_verify: ${results.jwt.functions?.jwt_verify ? 'âœ…' : 'âŒ'}\n` +
              `jwt_decode_user: ${results.jwt.functions?.jwt_decode_user ? 'âœ…' : 'âŒ'}`, 
              results.jwt.loaded ? 'success' : 'error');
            
            if (results.jwt.error) {
              addResult('âš ï¸ Error en jwt.php', results.jwt.error, 'warning');
            }
          }
          
          if (data.summary) {
            const summary = data.summary;
            addResult('ğŸ“Š Resumen Final', 
              `config.php: ${summary.config_loaded ? 'âœ…' : 'âŒ'}\n` +
              `helpers.php: ${summary.helpers_loaded ? 'âœ…' : 'âŒ'}\n` +
              `db.php: ${summary.db_loaded ? 'âœ…' : 'âŒ'}\n` +
              `jwt.php: ${summary.jwt_loaded ? 'âœ…' : 'âŒ'}\n` +
              `Todos cargados: ${summary.all_loaded ? 'âœ…' : 'âŒ'}`, 
              summary.all_loaded ? 'success' : 'warning');
          }
        } else {
          addResult('âŒ Error en Test Archivos Individuales', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Test Archivos Individuales', `Error: ${error.message}`, 'error');
      }
    }

    async function testNoRequire() {
      addResult('ğŸš« Probando Test Sin Require...', 'Verificando PHP bÃ¡sico sin require_once...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_no_require_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test Sin Require Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.php_info) {
            const php = data.php_info;
            addResult('ğŸ˜ InformaciÃ³n PHP', 
              `Funcionando: ${php.working ? 'âœ…' : 'âŒ'}\n` +
              `VersiÃ³n: ${php.version}\n` +
              `Memoria: ${php.memory_limit}\n` +
              `Output Buffer: ${php.output_buffer_active ? 'âš ï¸' : 'âœ…'}`, 'info');
          }
          
          if (data.json_test) {
            const json = data.json_test;
            addResult('ğŸ“„ Test JSON', 
              `Funcionando: ${json.working ? 'âœ…' : 'âŒ'}\n` +
              `Valor: ${json.test_value}`, 'info');
          }
          
          if (data.file_tests) {
            const files = data.file_tests;
            addResult('ğŸ“ Test Archivos', 
              `config.php existe: ${files.config_exists ? 'âœ…' : 'âŒ'}\n` +
              `config.php legible: ${files.config_readable ? 'âœ…' : 'âŒ'}\n` +
              `TamaÃ±o: ${files.config_size} bytes\n` +
              `Ruta: ${files.config_path}`, 'info');
          }
          
          if (data.syntax_test) {
            const syntax = data.syntax_test;
            addResult('ğŸ”§ Test Sintaxis', 
              `Funcionando: ${syntax.working ? 'âœ…' : 'âŒ'}`, 'info');
          }
          
          if (data.diagnosis) {
            const diag = data.diagnosis;
            addResult('ğŸ” DiagnÃ³stico Final', 
              `PHP funcionando: ${diag.php_working ? 'âœ…' : 'âŒ'}\n` +
              `JSON funcionando: ${diag.json_working ? 'âœ…' : 'âŒ'}\n` +
              `Archivos accesibles: ${diag.files_accessible ? 'âœ…' : 'âŒ'}\n` +
              `Sintaxis OK: ${diag.syntax_ok ? 'âœ…' : 'âŒ'}\n` +
              `Sin output buffer: ${diag.no_output_buffer ? 'âœ…' : 'âŒ'}\n` +
              `Listo para require: ${diag.ready_for_require ? 'âœ…' : 'âŒ'}`, 
              diag.ready_for_require ? 'success' : 'warning');
          }
        } else {
          addResult('âŒ Error en Test Sin Require', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Test Sin Require', `Error: ${error.message}`, 'error');
      }
    }

    async function testCleanBuffer() {
      addResult('ğŸ§¹ Probando Test Buffer Limpio...', 'Limpiando output buffer y probando archivos...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_clean_buffer_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test Buffer Limpio Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.buffer_status) {
            const buffer = data.buffer_status;
            addResult('ğŸ§¹ Estado del Buffer', 
              `Nivel inicial: ${buffer.initial_level}\n` +
              `Buffer limpio: ${buffer.buffer_clean ? 'âœ…' : 'âŒ'}`, 'info');
          }
          
          if (data.file_loading) {
            const loading = data.file_loading;
            addResult('ğŸ“ Carga de Archivos', 
              `config.php: ${loading.config_loaded ? 'âœ…' : 'âŒ'}\n` +
              `helpers.php: ${loading.helpers_loaded ? 'âœ…' : 'âŒ'}\n` +
              `db.php: ${loading.db_loaded ? 'âœ…' : 'âŒ'}\n` +
              `jwt.php: ${loading.jwt_loaded ? 'âœ…' : 'âŒ'}`, 'info');
            
            if (loading.config_error) {
              addResult('âš ï¸ Error en config.php', loading.config_error, 'warning');
            }
            if (loading.helpers_error) {
              addResult('âš ï¸ Error en helpers.php', loading.helpers_error, 'warning');
            }
            if (loading.db_error) {
              addResult('âš ï¸ Error en db.php', loading.db_error, 'warning');
            }
            if (loading.jwt_error) {
              addResult('âš ï¸ Error en jwt.php', loading.jwt_error, 'warning');
            }
          }
          
          if (data.functions_exist) {
            const functions = data.functions_exist;
            addResult('ğŸ”§ Funciones Disponibles', 
              `json_out: ${functions.json_out ? 'âœ…' : 'âŒ'}\n` +
              `require_user: ${functions.require_user ? 'âœ…' : 'âŒ'}\n` +
              `db: ${functions.db ? 'âœ…' : 'âŒ'}\n` +
              `jwt_sign: ${functions.jwt_sign ? 'âœ…' : 'âŒ'}\n` +
              `jwt_verify: ${functions.jwt_verify ? 'âœ…' : 'âŒ'}`, 'info');
          }
          
          if (data.diagnosis) {
            const diag = data.diagnosis;
            addResult('ğŸ” DiagnÃ³stico Final', 
              `Buffer limpio: ${diag.buffer_clean ? 'âœ…' : 'âŒ'}\n` +
              `Todos los archivos cargan: ${diag.all_files_loaded ? 'âœ…' : 'âŒ'}\n` +
              `Todas las funciones existen: ${diag.all_functions_exist ? 'âœ…' : 'âŒ'}\n` +
              `Listo para endpoints complejos: ${diag.ready_for_complex_endpoints ? 'âœ…' : 'âŒ'}`, 
              diag.ready_for_complex_endpoints ? 'success' : 'warning');
          }
        } else {
          addResult('âŒ Error en Test Buffer Limpio', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Test Buffer Limpio', `Error: ${error.message}`, 'error');
      }
    }

    async function testDeepDiagnostic() {
      addResult('ğŸ”¬ Ejecutando DiagnÃ³stico Profundo...', 'AnÃ¡lisis completo con manejo de errores fatales...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_deep_diagnostic_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… DiagnÃ³stico Profundo Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.results) {
            const results = data.results;
            
            // PHP BÃ¡sico
            if (results.php_basic) {
              const php = results.php_basic;
              addResult('ğŸ˜ PHP BÃ¡sico', 
                `Funcionando: ${php.working ? 'âœ…' : 'âŒ'}\n` +
                `VersiÃ³n: ${php.version}\n` +
                `Memoria: ${php.memory_limit}\n` +
                `Output Buffer: ${php.output_buffer_level}`, 'info');
            }
            
            // Test JSON
            if (results.json_test) {
              const json = results.json_test;
              addResult('ğŸ“„ Test JSON', 
                `Funcionando: ${json.working ? 'âœ…' : 'âŒ'}\n` +
                `Resultado: ${json.result}\n` +
                `Error: ${json.error || 'Ninguno'}`, 'info');
            }
            
            // VerificaciÃ³n de Archivos
            if (results.file_checks) {
              const files = results.file_checks;
              addResult('ğŸ“ VerificaciÃ³n de Archivos', 
                `config.php: ${files['config.php'].exists ? 'âœ…' : 'âŒ'} (${files['config.php'].size} bytes)\n` +
                `helpers.php: ${files['helpers.php'].exists ? 'âœ…' : 'âŒ'} (${files['helpers.php'].size} bytes)\n` +
                `db.php: ${files['db.php'].exists ? 'âœ…' : 'âŒ'} (${files['db.php'].size} bytes)\n` +
                `jwt.php: ${files['jwt.php'].exists ? 'âœ…' : 'âŒ'} (${files['jwt.php'].size} bytes)`, 'info');
            }
            
            // AnÃ¡lisis de Config
            if (results.config_analysis) {
              const config = results.config_analysis;
              if (config.syntax_check) {
                addResult('ğŸ”§ Sintaxis de config.php', 
                  `VÃ¡lida: ${config.syntax_check.valid ? 'âœ…' : 'âŒ'}\n` +
                  `Resultado: ${config.syntax_check.result}`, 'info');
              }
              if (config.include_test) {
                const include = config.include_test;
                addResult('ğŸ“¦ Carga de config.php', 
                  `Ã‰xito: ${include.success ? 'âœ…' : 'âŒ'}\n` +
                  `Output capturado: ${include.output_length} bytes\n` +
                  `Tipo de datos: ${include.config_type}\n` +
                  `Claves: ${include.config_keys ? include.config_keys.join(', ') : 'N/A'}`, 'info');
                if (!include.success) {
                  addResult('âš ï¸ Error en config.php', 
                    `Error: ${include.error}\n` +
                    `Archivo: ${include.file}\n` +
                    `LÃ­nea: ${include.line}`, 'warning');
                }
              }
            }
            
            // AnÃ¡lisis de Funciones
            if (results.function_analysis) {
              const func = results.function_analysis;
              if (func.helpers_loaded) {
                const helpers = func.helpers_loaded;
                addResult('ğŸ“š Carga de helpers.php', 
                  `Ã‰xito: ${helpers.success ? 'âœ…' : 'âŒ'}\n` +
                  `Output capturado: ${helpers.output_length} bytes`, 'info');
                if (!helpers.success) {
                  addResult('âš ï¸ Error en helpers.php', 
                    `Error: ${helpers.error}\n` +
                    `Archivo: ${helpers.file}\n` +
                    `LÃ­nea: ${helpers.line}`, 'warning');
                }
              }
              if (func.functions_after_helpers) {
                const functions = func.functions_after_helpers;
                addResult('ğŸ”§ Funciones DespuÃ©s de helpers.php', 
                  `json_out: ${functions.json_out ? 'âœ…' : 'âŒ'}\n` +
                  `require_user: ${functions.require_user ? 'âœ…' : 'âŒ'}\n` +
                  `getApiUrl: ${functions.getApiUrl ? 'âœ…' : 'âŒ'}`, 'info');
              }
            }
          }
          
          if (data.diagnosis) {
            const diag = data.diagnosis;
            addResult('ğŸ” DiagnÃ³stico Final', 
              `PHP funcionando: ${diag.php_working ? 'âœ…' : 'âŒ'}\n` +
              `JSON funcionando: ${diag.json_working ? 'âœ…' : 'âŒ'}\n` +
              `Archivos accesibles: ${diag.files_accessible ? 'âœ…' : 'âŒ'}\n` +
              `Sintaxis config OK: ${diag.config_syntax_ok ? 'âœ…' : 'âŒ'}\n` +
              `Config cargable: ${diag.config_loadable ? 'âœ…' : 'âŒ'}\n` +
              `Helpers cargable: ${diag.helpers_loadable ? 'âœ…' : 'âŒ'}\n` +
              `Listo para endpoints complejos: ${diag.ready_for_complex_endpoints ? 'âœ…' : 'âŒ'}`, 
              diag.ready_for_complex_endpoints ? 'success' : 'warning');
          }
        } else {
          addResult('âŒ Error en DiagnÃ³stico Profundo', JSON.stringify(data, null, 2), 'error');
          
          if (data.fatal_error) {
            addResult('ğŸ’€ Error Fatal Detectado', 
              `Tipo: ${data.fatal_error.type}\n` +
              `Mensaje: ${data.fatal_error.message}\n` +
              `Archivo: ${data.fatal_error.file}\n` +
              `LÃ­nea: ${data.fatal_error.line}`, 'error');
          }
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en DiagnÃ³stico Profundo', `Error: ${error.message}`, 'error');
      }
    }

    async function testDeepDiagnosticV2() {
      addResult('ğŸ”¬ Ejecutando DiagnÃ³stico Profundo V2...', 'AnÃ¡lisis completo SIN shell_exec()...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_deep_diagnostic_safe_v2.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… DiagnÃ³stico Profundo V2 Exitoso', JSON.stringify(data, null, 2), 'success');
          
          if (data.results) {
            const results = data.results;
            
            // PHP BÃ¡sico
            if (results.php_basic) {
              const php = results.php_basic;
              addResult('ğŸ˜ PHP BÃ¡sico', 
                `Funcionando: ${php.working ? 'âœ…' : 'âŒ'}\n` +
                `VersiÃ³n: ${php.version}\n` +
                `Memoria: ${php.memory_limit}\n` +
                `Output Buffer: ${php.output_buffer_level}\n` +
                `Funciones deshabilitadas: ${php.disabled_functions || 'Ninguna'}`, 'info');
            }
            
            // Test JSON
            if (results.json_test) {
              const json = results.json_test;
              addResult('ğŸ“„ Test JSON', 
                `Funcionando: ${json.working ? 'âœ…' : 'âŒ'}\n` +
                `Resultado: ${json.result}\n` +
                `Error: ${json.error || 'Ninguno'}`, 'info');
            }
            
            // VerificaciÃ³n de Archivos
            if (results.file_checks) {
              const files = results.file_checks;
              addResult('ğŸ“ VerificaciÃ³n de Archivos', 
                `config.php: ${files['config.php'].exists ? 'âœ…' : 'âŒ'} (${files['config.php'].size} bytes, ${files['config.php'].permissions})\n` +
                `helpers.php: ${files['helpers.php'].exists ? 'âœ…' : 'âŒ'} (${files['helpers.php'].size} bytes, ${files['helpers.php'].permissions})\n` +
                `db.php: ${files['db.php'].exists ? 'âœ…' : 'âŒ'} (${files['db.php'].size} bytes, ${files['db.php'].permissions})\n` +
                `jwt.php: ${files['jwt.php'].exists ? 'âœ…' : 'âŒ'} (${files['jwt.php'].size} bytes, ${files['jwt.php'].permissions})`, 'info');
            }
            
            // AnÃ¡lisis de Config
            if (results.config_analysis) {
              const config = results.config_analysis;
              if (config.syntax_check) {
                addResult('ğŸ”§ Sintaxis de config.php', 
                  `VÃ¡lida: ${config.syntax_check.valid ? 'âœ…' : 'âŒ'}\n` +
                  `MÃ©todo: ${config.syntax_check.method}\n` +
                  `Tokens: ${config.syntax_check.token_count}\n` +
                  `Error: ${config.syntax_check.error || 'Ninguno'}`, 'info');
              }
              if (config.file_analysis) {
                const file = config.file_analysis;
                addResult('ğŸ“„ AnÃ¡lisis de config.php', 
                  `TamaÃ±o: ${file.size} bytes\n` +
                  `Termina con nueva lÃ­nea: ${file.ends_with_newline ? 'âœ…' : 'âŒ'}\n` +
                  `Termina con punto y coma: ${file.ends_with_semicolon ? 'âœ…' : 'âŒ'}\n` +
                  `Tiene tag de apertura: ${file.has_opening_tag ? 'âœ…' : 'âŒ'}\n` +
                  `Tiene tag de cierre: ${file.has_closing_tag ? 'âœ…' : 'âŒ'}`, 'info');
              }
              if (config.include_test) {
                const include = config.include_test;
                addResult('ğŸ“¦ Carga de config.php', 
                  `Ã‰xito: ${include.success ? 'âœ…' : 'âŒ'}\n` +
                  `Output capturado: ${include.output_length} bytes\n` +
                  `Tipo de datos: ${include.config_type}\n` +
                  `Claves: ${include.config_keys ? include.config_keys.join(', ') : 'N/A'}\n` +
                  `Cantidad: ${include.config_count}`, 'info');
                if (!include.success) {
                  addResult('âš ï¸ Error en config.php', 
                    `Error: ${include.error}\n` +
                    `Archivo: ${include.file}\n` +
                    `LÃ­nea: ${include.line}`, 'warning');
                }
              }
            }
            
            // AnÃ¡lisis de Funciones
            if (results.function_analysis) {
              const func = results.function_analysis;
              
              if (func.helpers_loaded) {
                const helpers = func.helpers_loaded;
                addResult('ğŸ“š Carga de helpers.php', 
                  `Ã‰xito: ${helpers.success ? 'âœ…' : 'âŒ'}\n` +
                  `Output capturado: ${helpers.output_length} bytes`, 'info');
                if (!helpers.success) {
                  addResult('âš ï¸ Error en helpers.php', 
                    `Error: ${helpers.error}\n` +
                    `Archivo: ${helpers.file}\n` +
                    `LÃ­nea: ${helpers.line}`, 'warning');
                }
              }
              
              if (func.functions_after_helpers) {
                const functions = func.functions_after_helpers;
                addResult('ğŸ”§ Funciones DespuÃ©s de helpers.php', 
                  `json_out: ${functions.json_out ? 'âœ…' : 'âŒ'}\n` +
                  `require_user: ${functions.require_user ? 'âœ…' : 'âŒ'}\n` +
                  `getApiUrl: ${functions.getApiUrl ? 'âœ…' : 'âŒ'}\n` +
                  `json_error: ${functions.json_error ? 'âœ…' : 'âŒ'}\n` +
                  `read_json_body: ${functions.read_json_body ? 'âœ…' : 'âŒ'}`, 'info');
              }
              
              if (func.db_loaded) {
                const db = func.db_loaded;
                addResult('ğŸ—„ï¸ Carga de db.php', 
                  `Ã‰xito: ${db.success ? 'âœ…' : 'âŒ'}\n` +
                  `Output capturado: ${db.output_length} bytes`, 'info');
                if (!db.success) {
                  addResult('âš ï¸ Error en db.php', 
                    `Error: ${db.error}\n` +
                    `Archivo: ${db.file}\n` +
                    `LÃ­nea: ${db.line}`, 'warning');
                }
              }
              
              if (func.functions_after_db) {
                const functions = func.functions_after_db;
                addResult('ğŸ”§ Funciones DespuÃ©s de db.php', 
                  `db: ${functions.db ? 'âœ…' : 'âŒ'}\n` +
                  `PDO disponible: ${functions.pdo_available ? 'âœ…' : 'âŒ'}`, 'info');
              }
              
              if (func.jwt_loaded) {
                const jwt = func.jwt_loaded;
                addResult('ğŸ« Carga de jwt.php', 
                  `Ã‰xito: ${jwt.success ? 'âœ…' : 'âŒ'}\n` +
                  `Output capturado: ${jwt.output_length} bytes`, 'info');
                if (!jwt.success) {
                  addResult('âš ï¸ Error en jwt.php', 
                    `Error: ${jwt.error}\n` +
                    `Archivo: ${jwt.file}\n` +
                    `LÃ­nea: ${jwt.line}`, 'warning');
                }
              }
              
              if (func.functions_after_jwt) {
                const functions = func.functions_after_jwt;
                addResult('ğŸ”§ Funciones DespuÃ©s de jwt.php', 
                  `jwt_sign: ${functions.jwt_sign ? 'âœ…' : 'âŒ'}\n` +
                  `jwt_verify: ${functions.jwt_verify ? 'âœ…' : 'âŒ'}\n` +
                  `jwt_verify_hs256: ${functions.jwt_verify_hs256 ? 'âœ…' : 'âŒ'}`, 'info');
              }
            }
          }
          
          if (data.diagnosis) {
            const diag = data.diagnosis;
            addResult('ğŸ” DiagnÃ³stico Final', 
              `PHP funcionando: ${diag.php_working ? 'âœ…' : 'âŒ'}\n` +
              `JSON funcionando: ${diag.json_working ? 'âœ…' : 'âŒ'}\n` +
              `Archivos accesibles: ${diag.files_accessible ? 'âœ…' : 'âŒ'}\n` +
              `Sintaxis config OK: ${diag.config_syntax_ok ? 'âœ…' : 'âŒ'}\n` +
              `Config cargable: ${diag.config_loadable ? 'âœ…' : 'âŒ'}\n` +
              `Helpers cargable: ${diag.helpers_loadable ? 'âœ…' : 'âŒ'}\n` +
              `DB cargable: ${diag.db_loadable ? 'âœ…' : 'âŒ'}\n` +
              `JWT cargable: ${diag.jwt_loadable ? 'âœ…' : 'âŒ'}\n` +
              `Listo para endpoints complejos: ${diag.ready_for_complex_endpoints ? 'âœ…' : 'âŒ'}`, 
              diag.ready_for_complex_endpoints ? 'success' : 'warning');
          }
        } else {
          addResult('âŒ Error en DiagnÃ³stico Profundo V2', JSON.stringify(data, null, 2), 'error');
          
          if (data.fatal_error) {
            addResult('ğŸ’€ Error Fatal Detectado', 
              `Tipo: ${data.fatal_error.type}\n` +
              `Mensaje: ${data.fatal_error.message}\n` +
              `Archivo: ${data.fatal_error.file}\n` +
              `LÃ­nea: ${data.fatal_error.line}`, 'error');
          }
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en DiagnÃ³stico Profundo V2', `Error: ${error.message}`, 'error');
      }
    }

    function analyzeMinimalRequire(results) {
      let analysis = '';
      
      if (results.file_exists) {
        analysis += 'ğŸ“ ARCHIVO CONFIG:\n';
        analysis += `- Existe: ${results.file_exists.exists ? 'âœ…' : 'âŒ'}\n`;
        analysis += `- Legible: ${results.file_exists.readable ? 'âœ…' : 'âŒ'}\n`;
        analysis += `- TamaÃ±o: ${results.file_exists.size} bytes\n\n`;
      }

      if (results.php_syntax) {
        analysis += 'ğŸ”§ PHP:\n';
        analysis += `- VersiÃ³n: ${results.php_syntax.php_version}\n`;
        analysis += `- Memoria: ${results.php_syntax.memory_limit}\n`;
        analysis += `- Tiempo: ${results.php_syntax.max_execution_time}s\n\n`;
      }

      if (results.load_config) {
        analysis += 'âš™ï¸ CARGA CONFIG:\n';
        analysis += `- Ã‰xito: ${results.load_config.success ? 'âœ…' : 'âŒ'}\n`;
        if (results.load_config.success) {
          analysis += `- Tipo: ${results.load_config.config_type}\n`;
          analysis += `- Claves: ${results.load_config.config_keys?.length || 0}\n`;
          analysis += `- Output: ${results.load_config.output_length} chars\n`;
        } else {
          analysis += `- Error: ${results.load_config.error}\n`;
        }
        analysis += '\n';
      }

      if (results.encoding) {
        analysis += 'ğŸ“ ENCODING:\n';
        analysis += `- TamaÃ±o: ${results.encoding.file_size} bytes\n`;
        analysis += `- BOM: ${results.encoding.has_bom ? 'âŒ (tiene BOM)' : 'âœ… (sin BOM)'}\n`;
        analysis += `- Primeros chars: ${results.encoding.first_chars}\n`;
        analysis += `- Ãšltimos chars: ${results.encoding.last_chars}\n\n`;
      }

      // Recomendaciones
      analysis += 'ğŸ’¡ RECOMENDACIONES:\n';
      if (results.file_exists && !results.file_exists.exists) {
        analysis += '- Verificar que config.php existe en api/\n';
      }
      if (results.file_exists && !results.file_exists.readable) {
        analysis += '- Verificar permisos de lectura de config.php\n';
      }
      if (results.load_config && !results.load_config.success) {
        analysis += '- Verificar sintaxis PHP en config.php\n';
      }
      if (results.encoding && results.encoding.has_bom) {
        analysis += '- Eliminar BOM del archivo config.php\n';
      }

      return analysis;
    }

    async function testStepByStep() {
      addResult('ğŸ” Ejecutando Test Paso a Paso...', 'Verificando cada dependencia por separado...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_step_by_step_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Test Paso a Paso Completado', JSON.stringify(data, null, 2), 'success');
          
          // AnÃ¡lisis especÃ­fico de los pasos
          const analysis = analyzeStepByStep(data.steps);
          addResult('ğŸ“Š AnÃ¡lisis Paso a Paso', analysis, 'info');
        } else {
          addResult('âŒ Error en Test Paso a Paso', JSON.stringify(data, null, 2), 'error');
          
          // AnÃ¡lisis del error
          if (data.failed_at_step) {
            addResult('ğŸš¨ FallÃ³ en Paso ' + data.failed_at_step, `Error: ${data.error}`, 'error');
          }
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Test Paso a Paso', `Error: ${error.message}`, 'error');
      }
    }

    function analyzeStepByStep(steps) {
      let analysis = '';
      
      if (steps) {
        analysis += 'ğŸ“‹ PASOS EJECUTADOS:\n';
        Object.entries(steps).forEach(([stepKey, step]) => {
          const status = step.status === 'SUCCESS' ? 'âœ…' : 'âŒ';
          analysis += `${status} ${step.description}\n`;
          
          if (step.status === 'FAILED' && step.error) {
            analysis += `   Error: ${step.error}\n`;
          }
        });
        analysis += '\n';
      }

      // Recomendaciones
      analysis += 'ğŸ’¡ RECOMENDACIONES:\n';
      if (steps) {
        Object.entries(steps).forEach(([stepKey, step]) => {
          if (step.status === 'FAILED') {
            switch (stepKey) {
              case 'step_2_config':
                analysis += '- Verificar que config.php existe y es vÃ¡lido\n';
                break;
              case 'step_3_helpers':
                analysis += '- Verificar que helpers.php existe y no tiene errores de sintaxis\n';
                break;
              case 'step_4_db':
                analysis += '- Verificar que db.php existe y no tiene errores de sintaxis\n';
                break;
              case 'step_5_jwt':
                analysis += '- Verificar que jwt.php existe y no tiene errores de sintaxis\n';
                break;
              case 'step_6_database':
                analysis += '- Verificar credenciales de base de datos en config.php\n';
                break;
              case 'step_7_json_out':
                analysis += '- Verificar que la funciÃ³n json_out estÃ¡ definida en helpers.php\n';
                break;
            }
          }
        });
      }

      return analysis;
    }

    async function testAuthDebug() {
      addResult('ğŸ”§ Ejecutando Debug de Auth...', 'Verificando componentes de autenticaciÃ³n...', 'info');
      
      try {
        const response = await fetch(ConfigPortable.getApiUrl('test_auth_debug_safe.php'), {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });

        const data = await response.json();
        
        if (data.ok) {
          addResult('âœ… Debug de Auth Completado', JSON.stringify(data, null, 2), 'success');
          
          // AnÃ¡lisis especÃ­fico del debug
          const analysis = analyzeAuthDebug(data.debug);
          addResult('ğŸ“Š AnÃ¡lisis de Auth Debug', analysis, 'info');
        } else {
          addResult('âŒ Error en Debug de Auth', JSON.stringify(data, null, 2), 'error');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n en Debug', `Error: ${error.message}`, 'error');
      }
    }

    function analyzeAuthDebug(debug) {
      let analysis = '';
      
      // AnÃ¡lisis de archivos
      if (debug.files) {
        analysis += 'ğŸ“ ARCHIVOS:\n';
        Object.entries(debug.files).forEach(([file, exists]) => {
          analysis += `- ${file}: ${exists ? 'âœ…' : 'âŒ'}\n`;
        });
        analysis += '\n';
      }

      // AnÃ¡lisis de funciones
      if (debug.functions) {
        analysis += 'ğŸ”§ FUNCIONES:\n';
        Object.entries(debug.functions).forEach(([func, exists]) => {
          analysis += `- ${func}: ${exists ? 'âœ…' : 'âŒ'}\n`;
        });
        analysis += '\n';
      }

      // AnÃ¡lisis de configuraciÃ³n
      if (debug.config) {
        analysis += 'âš™ï¸ CONFIGURACIÃ“N:\n';
        analysis += `- Cargada: ${debug.config.loaded ? 'âœ…' : 'âŒ'}\n`;
        analysis += `- JWT Secret: ${debug.config.jwt_secret_set ? 'âœ…' : 'âŒ'}\n`;
        analysis += `- DB Host: ${debug.config.db_host}\n`;
        analysis += `- DB Name: ${debug.config.db_name}\n\n`;
      }

      // AnÃ¡lisis de base de datos
      if (debug.database) {
        analysis += 'ğŸ—„ï¸ BASE DE DATOS:\n';
        analysis += `- ConexiÃ³n: ${debug.database.connection}\n`;
        if (debug.database.query_test) {
          analysis += `- Query Test: ${debug.database.query_test}\n`;
        }
        if (debug.database.error) {
          analysis += `- Error: ${debug.database.error}\n`;
        }
        analysis += '\n';
      }

      // AnÃ¡lisis de JWT
      if (debug.jwt) {
        analysis += 'ğŸ” JWT:\n';
        analysis += `- jwt_sign: ${debug.jwt.sign}\n`;
        if (debug.jwt.token_length) {
          analysis += `- Token Length: ${debug.jwt.token_length}\n`;
        }
        if (debug.jwt.error) {
          analysis += `- Error: ${debug.jwt.error}\n`;
        }
        analysis += '\n';
      }

      // Recomendaciones
      analysis += 'ğŸ’¡ RECOMENDACIONES:\n';
      if (debug.files) {
        Object.entries(debug.files).forEach(([file, exists]) => {
          if (!exists) {
            analysis += `- Verificar que ${file} existe en api/\n`;
          }
        });
      }
      if (debug.functions) {
        Object.entries(debug.functions).forEach(([func, exists]) => {
          if (!exists) {
            analysis += `- Verificar que la funciÃ³n ${func} estÃ¡ definida\n`;
          }
        });
      }
      if (debug.database?.connection === 'FAILED') {
        analysis += '- Verificar credenciales de base de datos\n';
      }
      if (debug.jwt?.sign === 'FUNCTION_NOT_FOUND') {
        analysis += '- Verificar que jwt.php estÃ¡ incluido correctamente\n';
      }

      return analysis;
    }

    async function testRegisterEndpoint() {
      addResult('ğŸ“ Probando Endpoint de Registro...', 'Enviando request de prueba...', 'info');
      
      try {
        const testData = {
          email: 'test' + Date.now() + '@example.com',
          password: 'testpassword123',
          name: 'Test User'
        };

        const response = await fetch(ConfigPortable.getApiUrl('auth_register.php'), {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(testData)
        });

        const data = await response.json();
        
        if (response.status === 200 && data.token) {
          addResult('âœ… Endpoint de Registro Funciona', 'Usuario creado exitosamente', 'success');
        } else if (response.status === 500) {
          addResult('âŒ Error HTTP 500 en Registro', JSON.stringify(data, null, 2), 'error');
        } else {
          addResult('âš ï¸ Respuesta Inesperada', JSON.stringify(data, null, 2), 'warning');
        }
      } catch (error) {
        addResult('âŒ Error de ConexiÃ³n', `Error: ${error.message}`, 'error');
      }
    }

    // Ejecutar diagnÃ³stico automÃ¡ticamente al cargar
    window.addEventListener('load', () => {
      runLoginDiagnostic();
    });
  </script>
</body>
</html>
