<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>IA Test - ExtracciÃ³n de Contenido (Responses v2)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body{background:#1a1a1a;color:#fff}
    .container{background:#2d2d2d;border-radius:8px;padding:20px}
    input,textarea,select{background:#404040;color:#fff;border:2px solid #666;border-radius:6px;padding:12px}
    input:focus,textarea:focus,select:focus{border-color:#3b82f6;box-shadow:0 0 0 3px rgba(59,130,246,.3);outline:none}
    .result-box{background:#1e1e1e;border:2px solid #404040;color:#00ff00;font-family:"Courier New",monospace;font-size:13px;line-height:1.4}
    .result-label{color:#29d437;font-weight:bold;margin-bottom:8px;padding:8px 12px;background:#333;border-radius:4px;border-left:4px solid #3b82f6}
  </style>
</head>
<body class="dark">
  <div class="container mx-auto p-6 max-w-4xl">
    <h1 class="text-3xl font-bold mb-6 text-blue-400">ğŸ§  IA Test - ExtracciÃ³n de Contenido (Responses API)</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
      <div>
        <label class="block text-sm font-medium mb-2">Token de Usuario (JWT)</label>
        <input id="token" type="text" class="w-full p-3 border rounded-lg" placeholder="Bearer eyJ..." value="">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">OpenAI API Key</label>
        <input id="openaiKey" type="password" class="w-full p-3 border rounded-lg" placeholder="sk-xxxx">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">File ID (knowledge_files.id)</label>
        <input id="fileId" type="number" class="w-full p-3 border rounded-lg" placeholder="20" value="20">
      </div>
      <div>
        <label class="block text-sm font-medium mb-2">API Base</label>
        <input id="apiBase" type="text" class="w-full p-3 border rounded-lg"
               value="https://cerberogrowthsolutions.com/catai/api">
      </div>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
      <button onclick="getUserSettings()" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg">ğŸ”§ Obtener Config IA</button>
      <button onclick="getFileInfo()" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg">ğŸ“ Info del Archivo</button>
      <button onclick="buildPrompt()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-3 rounded-lg">ğŸ“ Construir Prompt</button>
      <button onclick="buildRequest()" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg">ğŸ”— Armar Consulta (muestra)</button>
      <button onclick="sendToAI()" class="bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg">ğŸš€ Extraer Contenido Real (Auto-detecta tipo)</button>
      
      <button onclick="debugExtraction()" class="bg-yellow-600 hover:bg-yellow-700 text-white p-3 rounded-lg ml-4">ğŸ” DiagnÃ³stico de ExtracciÃ³n</button>
      
      <button onclick="testMinimal()" class="bg-orange-600 hover:bg-orange-700 text-white p-3 rounded-lg ml-4">ğŸ§ª Test Minimal</button>
      
      <button onclick="testBasic()" class="bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg ml-4">ğŸ”§ Test BÃ¡sico</button>
      
      <button onclick="testDependencies()" class="bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg ml-4">ğŸ”— Test Dependencias</button>
      
      <button onclick="testConfigOnly()" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg ml-4">âš™ï¸ Test Config</button>
      <button onclick="testDbConnection()" class="bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg">ğŸ”§ Probar ConexiÃ³n DB</button>
      <button onclick="testExtractDebug()" class="bg-orange-600 hover:bg-orange-700 text-white p-3 rounded-lg">ğŸ” Debug ExtracciÃ³n</button>
      <button onclick="testSimple()" class="bg-pink-600 hover:bg-pink-700 text-white p-3 rounded-lg">ğŸ§ª Test Simple</button>
      <button onclick="testConfig()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg">âš™ï¸ Test Config</button>
      <button onclick="testAIProcessing()" class="bg-teal-600 hover:bg-teal-700 text-white p-3 rounded-lg">ğŸ§  Test IA Processing</button>
      <button onclick="testAsyncExtraction()" class="bg-cyan-600 hover:bg-cyan-700 text-white p-3 rounded-lg">âš¡ ExtracciÃ³n AsÃ­ncrona</button>
      <button onclick="testOptimizedExtraction()" class="bg-emerald-600 hover:bg-emerald-700 text-white p-3 rounded-lg">ğŸš€ ExtracciÃ³n Optimizada</button>
      <button onclick="testDebugReal()" class="bg-violet-600 hover:bg-violet-700 text-white p-3 rounded-lg">ğŸ”¬ Debug Real</button>
      <button onclick="testOpenAIConnection()" class="bg-amber-600 hover:bg-amber-700 text-white p-3 rounded-lg">ğŸ”— Test OpenAI</button>
      <button onclick="testFilesAPI()" class="bg-lime-600 hover:bg-lime-700 text-white p-3 rounded-lg">ğŸ“ Files API</button>
      <button onclick="testSimulated()" class="bg-slate-600 hover:bg-slate-700 text-white p-3 rounded-lg">ğŸ­ Simulado</button>
      <button onclick="testGemini()" class="bg-purple-600 hover:bg-purple-700 text-white p-3 rounded-lg">ğŸ’ Gemini</button>
      <button onclick="testHybrid()" class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg">ğŸ”„ HÃ­brido</button>
      <button onclick="extractUserData()" class="bg-cyan-600 hover:bg-cyan-700 text-white p-3 rounded-lg">ğŸ‘¤ Extraer Datos Usuario</button>
      <button onclick="clearResults()" class="bg-gray-600 hover:bg-gray-700 text-white p-3 rounded-lg">ğŸ—‘ï¸ Limpiar</button>
    </div>

    <!-- Indicador de Estado -->
    <div id="statusIndicator" class="mb-4 p-3 rounded-lg bg-gray-100 border border-gray-300 text-sm">
      <span class="font-semibold text-black">ğŸ“Š Estado del Sistema:</span>
      <span id="statusText" class="text-black">âœ… Listo para extracciÃ³n</span>
      <span id="cooldownTimer" class="ml-2 text-blue-600 font-mono"></span>
    </div>

    <div class="space-y-4">
      <div>
        <div class="result-label">ğŸ”§ ConfiguraciÃ³n IA del Usuario</div>
        <pre id="userSettings" class="result-box p-4 rounded-lg text-sm overflow-auto max-h-40"></pre>
      </div>
      <div>
        <div class="result-label">ğŸ“ InformaciÃ³n del Archivo</div>
        <pre id="fileInfo" class="result-box p-4 rounded-lg text-sm overflow-auto max-h-40"></pre>
      </div>
      <div>
        <div class="result-label">ğŸ“ Prompt Construido</div>
        <pre id="prompt" class="result-box p-4 rounded-lg text-sm overflow-auto max-h-40"></pre>
      </div>
      <div>
        <div class="result-label">ğŸ”— Consulta Completa (muestra)</div>
        <pre id="request" class="result-box p-4 rounded-lg text-sm overflow-auto max-h-60"></pre>
      </div>
      <div>
        <div class="result-label">ğŸš€ Resultado de la IA (respuesta del backend)</div>
        <pre id="aiResult" class="result-box p-4 rounded-lg text-sm overflow-auto max-h-60"></pre>
      </div>
    </div>
    
    <div class="mt-6">
      <div class="result-label">ğŸ“‹ Datos que se guardarÃ­an en Knowledge Base</div>
      <pre id="knowledgeBaseData" class="result-box p-4 rounded-lg text-sm overflow-auto max-h-60 bg-blue-50 border border-blue-200"></pre>
    </div>
    
    <div class="mt-6">
      <div class="result-label">ğŸ” Debug Completo - Todas las Pruebas</div>
      <div class="flex gap-2 mb-2">
        <button onclick="runAllTests()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">ğŸš€ Ejecutar ExtracciÃ³n Completa</button>
        <button onclick="copyDebugInfo()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">ğŸ“‹ Copiar Debug Info</button>
        <button onclick="clearDebugInfo()" class="px-4 py-2 bg-gray-600 text-white rounded hover:bg-gray-700">ğŸ—‘ï¸ Limpiar</button>
      </div>
      <pre id="debugInfo" class="result-box p-4 rounded-lg text-sm overflow-auto max-h-96 bg-gray-50 border border-gray-200"></pre>
    </div>
  </div>

  <script>
    const el = id => document.getElementById(id);
    const API_BASE = () => el('apiBase').value.trim();
    const getToken = () => {
      const token = el('token').value.trim();
      if (token) localStorage.setItem('ia_test_jwt', token);
      return token;
    };
    const getOpenAIKey = () => {
      const key = el('openaiKey').value.trim();
      if (key) localStorage.setItem('ia_test_openai_key', key);
      return key;
    };
    const getFileId = () => parseInt(el('fileId').value.trim(), 10);
    
    // Cargar datos guardados al cargar la pÃ¡gina
    function loadSavedData() {
      const savedToken = localStorage.getItem('ia_test_jwt');
      const savedKey = localStorage.getItem('ia_test_openai_key');
      if (savedToken) el('token').value = savedToken;
      if (savedKey) el('openaiKey').value = savedKey;
    }

    let userSettings = null, fileInfo = null, promptTxt = null;

    async function getUserSettings() {
      const token = getToken();
      if (!token) return alert('âŒ Ingresa el token (JWT)');
      try {
        el('userSettings').textContent = 'â³ Cargando configuraciÃ³n del usuario...';
        const r = await fetch(`${API_BASE()}/settings_get_safe.php`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const j = await r.json(); userSettings = j;
        
        // Mostrar quÃ© datos estamos extrayendo para la consulta
        const extractedData = {
          'ai_provider': j.settings?.ai_provider || 'NO_ENCONTRADO',
          'ai_model': j.settings?.ai_model || 'NO_ENCONTRADO',
          'source': j.source || 'NO_ENCONTRADO'
        };
        
        el('userSettings').textContent = `ğŸ“‹ CONFIGURACIÃ“N COMPLETA:\n${JSON.stringify(j, null, 2)}\n\nğŸ¯ DATOS EXTRAÃDOS PARA LA CONSULTA:\n${JSON.stringify(extractedData, null, 2)}`;
      } catch (e) { el('userSettings').textContent = `Error: ${e.message}`; }
    }

    async function getFileInfo() {
      const token = getToken(), fileId = getFileId();
      if (!token || !fileId) return alert('âŒ Ingresa token y file ID');
      try {
        el('fileInfo').textContent = 'â³ Obteniendo informaciÃ³n del archivo...';
        const r = await fetch(`${API_BASE()}/ai_summarize_probe_safe.php`, {
          method: 'POST',
          headers: { 'Content-Type':'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ file_id: fileId, knowledge_id: fileId })
        });
        const j = await r.json(); fileInfo = j;
        
        // Mostrar quÃ© datos estamos extrayendo para la consulta
        const extractedData = {
          'file_id': j.probe?.used_file_id || 'NO_ENCONTRADO',
          'original_filename': j.probe?.file?.original_filename || 'NO_ENCONTRADO',
          'file_path': j.probe?.file?.expected_path || 'NO_ENCONTRADO',
          'file_size_mb': j.probe?.file?.size_bytes ? (j.probe.file.size_bytes / 1024 / 1024).toFixed(2) : 'NO_ENCONTRADO',
          'mime_type': j.probe?.file?.mime_type || 'NO_ENCONTRADO'
        };
        
        el('fileInfo').textContent = `ğŸ“ INFORMACIÃ“N COMPLETA DEL ARCHIVO:\n${JSON.stringify(j, null, 2)}\n\nğŸ¯ DATOS EXTRAÃDOS PARA LA CONSULTA:\n${JSON.stringify(extractedData, null, 2)}`;
      } catch (e) { el('fileInfo').textContent = `Error: ${e.message}`; }
    }

    function buildPrompt() {
      if (!fileInfo || !userSettings) return alert('âŒ Primero settings + file info');
      const f = fileInfo?.probe?.file || {};
      const s = userSettings?.settings || {};
      
      promptTxt = `Eres un analista de trading experto. Analiza el siguiente documento y extrae informaciÃ³n valiosa para trading:

ARCHIVO: ${f.original_filename || 'N/A'}
TIPO: ${f.mime_type || 'N/A'}
TAMAÃ‘O: ${f.size_bytes ? (Math.round(f.size_bytes/1024/1024*100)/100) : 'N/A'} MB

Proporciona un resumen estructurado en espaÃ±ol con:
1. RESUMEN EJECUTIVO (2-3 lÃ­neas)
2. CONCEPTOS CLAVE (5-8 puntos)
3. ESTRATEGIAS DE TRADING (3-5 puntos)
4. GESTIÃ“N DE RIESGO (2-3 puntos)
5. RECOMENDACIONES (2-3 puntos)

EnfÃ³cate en informaciÃ³n prÃ¡ctica y accionable para traders.`;
      
      // Mostrar quÃ© datos estamos usando para construir el prompt
      const promptData = {
        'archivo': f.original_filename || 'NO_ENCONTRADO',
        'tipo': f.mime_type || 'NO_ENCONTRADO',
        'tamaÃ±o_mb': f.size_bytes ? (Math.round(f.size_bytes/1024/1024*100)/100) : 'NO_ENCONTRADO',
        'ai_provider': s.ai_provider || 'NO_ENCONTRADO',
        'ai_model': s.ai_model || 'NO_ENCONTRADO'
      };
      
      el('prompt').textContent = `ğŸ“ PROMPT CONSTRUIDO:\n${promptTxt}\n\nğŸ¯ DATOS USADOS PARA CONSTRUIR EL PROMPT:\n${JSON.stringify(promptData, null, 2)}`;
    }

    // Solo display: muestra cÃ³mo luce el payload correcto para /v1/responses
    function buildRequest() {
      if (!promptTxt || !userSettings) return alert('âŒ Construye el prompt');
      const model = (userSettings.settings?.ai_model) || 'gpt-4o';
      const openaiPayloadSample = {
        model,
        temperature: 0.3,
        max_output_tokens: 1800,
        text: {
          format: {
            type: 'json_schema',
            name: 'knowledge_card',
            strict: true,
            schema: {
              type: 'object',
              required: ['resumen','puntos_clave','estrategias','gestion_riesgo','recomendaciones'],
              properties: {
                resumen:        { type:'string' },
                puntos_clave:   { type:'array', items:{ type:'string' } },
                estrategias:    { type:'array', items:{ type:'string' } },
                gestion_riesgo: { type:'array', items:{ type:'string' } },
                recomendaciones:{ type:'array', items:{ type:'string' } }
              },
              additionalProperties: false
            }
          }
        },
        input: [{
          role: 'user',
          content: [
            { type:'input_text', text: 'Eres analista de trading. Resume el PDF segÃºn el esquema. No inventes; si faltan datos usa null.' },
            { type:'input_file', file_id: 'file_XXXXXXXX (ejemplo)' }
          ]
        }]
      };

      const backendRequest = {
        endpoint: `${API_BASE()}/ai_extract_content_real_v3_safe.php`,
        method: 'POST',
        headers: {
          'Authorization': getToken(),
          'X-OpenAI-Key': getOpenAIKey(),
          'Content-Type': 'application/json'
        },
        body: { file_id: getFileId() }
      };

      el('request').textContent = JSON.stringify({ backendRequest, openaiPayloadSample }, null, 2);
    }

    // Variables de control de rate limiting
    let isProcessing = false;
    let lastRequestTime = 0;
    const MIN_REQUEST_INTERVAL = 5000; // 5 segundos mÃ­nimo entre requests
    let cooldownInterval = null;

    // FunciÃ³n para actualizar el indicador de estado
    function updateStatusIndicator() {
      const statusText = el('statusText');
      const cooldownTimer = el('cooldownTimer');
      const statusIndicator = el('statusIndicator');
      
      if (isProcessing) {
        statusText.textContent = 'â³ Procesando extracciÃ³n...';
        statusIndicator.className = 'mb-4 p-3 rounded-lg bg-yellow-100 border border-yellow-300 text-sm';
        cooldownTimer.textContent = '';
      } else {
        const now = Date.now();
        const timeSinceLastRequest = now - lastRequestTime;
        const remainingTime = MIN_REQUEST_INTERVAL - timeSinceLastRequest;
        
        if (remainingTime > 0) {
          statusText.textContent = 'â³ En cooldown';
          statusIndicator.className = 'mb-4 p-3 rounded-lg bg-orange-100 border border-orange-300 text-sm';
          cooldownTimer.textContent = `(${Math.ceil(remainingTime / 1000)}s)`;
        } else {
          statusText.textContent = 'âœ… Listo para extracciÃ³n';
          statusIndicator.className = 'mb-4 p-3 rounded-lg bg-green-100 border border-green-300 text-sm';
          cooldownTimer.textContent = '';
        }
      }
    }

    // FunciÃ³n para iniciar el timer de cooldown
    function startCooldownTimer() {
      if (cooldownInterval) clearInterval(cooldownInterval);
      
      cooldownInterval = setInterval(() => {
        updateStatusIndicator();
        const now = Date.now();
        const timeSinceLastRequest = now - lastRequestTime;
        if (timeSinceLastRequest >= MIN_REQUEST_INTERVAL) {
          clearInterval(cooldownInterval);
          cooldownInterval = null;
        }
      }, 1000);
    }

    async function debugExtraction() {
      const token = getToken(), fileId = getFileId();
      if (!token || !fileId) return alert('âŒ Completa JWT Token y File ID');

      try {
        el('aiResult').textContent = 'ğŸ” INICIANDO DIAGNÃ“STICO DE EXTRACCIÃ“N...';
        el('statusText').textContent = 'ğŸ” Verificando configuraciÃ³n, archivo y conectividad...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_debug_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ” DIAGNÃ“STICO COMPLETO:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… DiagnÃ³stico completado - Revisa los resultados';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas encontrados en diagnÃ³stico';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN DIAGNÃ“STICO:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en diagnÃ³stico';
      }
    }

    async function testMinimal() {
      const token = getToken(), fileId = getFileId();
      if (!token || !fileId) return alert('âŒ Completa JWT Token y File ID');

      try {
        el('aiResult').textContent = 'ğŸ§ª INICIANDO TEST MINIMAL...';
        el('statusText').textContent = 'ğŸ§ª Test ultra-simple con solo 1000 caracteres...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_minimal_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ§ª TEST MINIMAL COMPLETO:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Test minimal completado - Revisa los resultados';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas encontrados en test minimal';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN TEST MINIMAL:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en test minimal';
      }
    }

    async function testBasic() {
      try {
        el('aiResult').textContent = 'ğŸ”§ INICIANDO TEST BÃSICO...';
        el('statusText').textContent = 'ğŸ”§ Test bÃ¡sico del servidor PHP...';
        
        const response = await fetch(`${API_BASE()}/test_basic_safe.php`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ”§ TEST BÃSICO COMPLETO:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Test bÃ¡sico completado - Servidor PHP funcionando';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas encontrados en test bÃ¡sico';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN TEST BÃSICO:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en test bÃ¡sico';
      }
    }

    async function testDependencies() {
      try {
        el('aiResult').textContent = 'ğŸ”— INICIANDO TEST DE DEPENDENCIAS...';
        el('statusText').textContent = 'ğŸ”— Verificando config.php, helpers.php, db.php, CORS, base de datos...';
        
        const response = await fetch(`${API_BASE()}/test_dependencies_safe.php`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ”— TEST DE DEPENDENCIAS COMPLETO:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Test de dependencias completado - Todas las dependencias OK';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas encontrados en dependencias';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN TEST DE DEPENDENCIAS:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en test de dependencias';
      }
    }

    async function testConfigOnly() {
      try {
        el('aiResult').textContent = 'âš™ï¸ INICIANDO TEST DE CONFIG...';
        el('statusText').textContent = 'âš™ï¸ Verificando solo config.php...';
        
        const response = await fetch(`${API_BASE()}/test_config_only_safe.php`, {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `âš™ï¸ TEST DE CONFIG COMPLETO:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Test de config completado - config.php OK';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas encontrados en config.php';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN TEST DE CONFIG:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en test de config';
      }
    }

    async function sendToAI() {
      const token = getToken(), key = getOpenAIKey(), fileId = getFileId();
      if (!token || !key || !fileId) return alert('âŒ Completa JWT, OpenAI Key y File ID');

      // Verificar rate limiting
      const now = Date.now();
      if (isProcessing) {
        return alert('â³ Ya hay una extracciÃ³n en proceso. Espera a que termine.');
      }
      
      if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
        const remaining = Math.ceil((MIN_REQUEST_INTERVAL - (now - lastRequestTime)) / 1000);
        return alert(`â³ Espera ${remaining} segundos antes de hacer otra extracciÃ³n.`);
      }

      // Marcar como procesando
      isProcessing = true;
      lastRequestTime = now;
      updateStatusIndicator();
      
      // Deshabilitar botÃ³n
      const btn = document.querySelector('button[onclick="sendToAI()"]');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'â³ Procesando ExtracciÃ³n...';
      }

      try {
        // Mostrar exactamente quÃ© estamos enviando
        const requestData = {
          'endpoint': `${API_BASE()}/ai_extract_working_safe.php`,
          'method': 'POST',
          'headers': {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          'body': { file_id: fileId }
        };
        el('aiResult').textContent = `ğŸš€ ENVIANDO REQUEST AL ENDPOINT MEJORADO:\n${JSON.stringify(requestData, null, 2)}\n\nâ³ Esperando respuesta...`;
        
        const r = await fetch(`${API_BASE()}/ai_extract_working_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,           // JWT de tu sesiÃ³n con prefijo Bearer
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        // Verificar el status de la respuesta
        if (!r.ok) {
          throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        
        // Verificar si hay contenido
        const responseText = await r.text();
        if (!responseText || responseText.trim() === '') {
          throw new Error('Respuesta vacÃ­a del servidor');
        }
        
        // Intentar parsear JSON
        let j;
        try {
          j = JSON.parse(responseText);
        } catch (parseError) {
          throw new Error(`Error al parsear JSON: ${parseError.message}. Respuesta: ${responseText.substring(0, 200)}...`);
        }
        
        // Mostrar respuesta completa
        el('aiResult').textContent = `ğŸš€ REQUEST ENVIADO AL ENDPOINT MEJORADO:\n${JSON.stringify(requestData, null, 2)}\n\nğŸ“¥ RESPUESTA RECIBIDA:\n${JSON.stringify(j, null, 2)}`;
        
        // Mostrar especÃ­ficamente quÃ© se guardarÃ­a en knowledge_base en secciÃ³n separada
        if (j.ok && j['ğŸ“‹ SIMULACIÃ“N: DATOS QUE SE GUARDARÃAN EN KNOWLEDGE_BASE']) {
          const knowledgeData = j['ğŸ“‹ SIMULACIÃ“N: DATOS QUE SE GUARDARÃAN EN KNOWLEDGE_BASE'];
          const knowledgeFilesData = j['ğŸ“‹ SIMULACIÃ“N: DATOS QUE SE ACTUALIZARÃAN EN KNOWLEDGE_FILES'];
          
          el('knowledgeBaseData').textContent = `ğŸ“‹ DATOS QUE SE GUARDARÃAN EN KNOWLEDGE_BASE:\n${JSON.stringify(knowledgeData, null, 2)}\n\nğŸ“‹ DATOS QUE SE ACTUALIZARÃAN EN KNOWLEDGE_FILES:\n${JSON.stringify(knowledgeFilesData, null, 2)}`;
        } else {
          el('knowledgeBaseData').textContent = 'No hay datos de knowledge_base para mostrar';
        }
      } catch (e) {
        el('aiResult').textContent = `âŒ ERROR EN REQUEST AL ENDPOINT MEJORADO:\n${JSON.stringify(requestData, null, 2)}\n\nğŸ’¥ ERROR:\n${e.message}`;
      } finally {
        // Restaurar botÃ³n y estado
        isProcessing = false;
        updateStatusIndicator();
        startCooldownTimer();
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ğŸš€ Extraer Contenido Real (Auto-detecta tipo)';
        }
      }
    }

    async function testDbConnection() {
      const token = getToken();
      if (!token) return alert('âŒ Completa JWT Token');

      try {
        el('aiResult').textContent = 'ğŸ”§ Probando conexiÃ³n a la base de datos...';
        
        const response = await fetch(`${API_BASE()}/test_db_reconnection_safe.php`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ”§ PRUEBA DE CONEXIÃ“N DB:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok && result.all_tests_passed) {
          el('statusText').textContent = 'âœ… ConexiÃ³n DB estable';
          el('statusIndicator').className = 'mb-4 p-3 rounded-lg bg-green-100 border border-green-300 text-sm';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas de conexiÃ³n DB';
          el('statusIndicator').className = 'mb-4 p-3 rounded-lg bg-orange-100 border border-orange-300 text-sm';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN PRUEBA DB:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error de conexiÃ³n DB';
        el('statusIndicator').className = 'mb-4 p-3 rounded-lg bg-red-100 border border-red-300 text-sm';
      }
    }

    async function testExtractDebug() {
      const token = getToken();
      const key = getOpenAIKey();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!key) return alert('âŒ Completa OpenAI API Key');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'ğŸ” Probando endpoint de extracciÃ³n...';
        
        const response = await fetch(`${API_BASE()}/test_ai_extract_debug_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-OpenAI-Key': key,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ” DEBUG EXTRACCIÃ“N:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Endpoint de extracciÃ³n funcionando';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en endpoint de extracciÃ³n';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN DEBUG EXTRACCIÃ“N:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en endpoint de extracciÃ³n';
      }
    }

    async function testSimple() {
      try {
        el('aiResult').textContent = 'ğŸ§ª Probando endpoint simple...';
        
        const response = await fetch(`${API_BASE()}/simple_test_safe.php`, {
          method: 'GET'
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ§ª TEST SIMPLE:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Servidor PHP funcionando';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en servidor PHP';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN TEST SIMPLE:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error crÃ­tico en servidor';
      }
    }

    async function testConfig() {
      try {
        el('aiResult').textContent = 'âš™ï¸ Probando configuraciÃ³n del sistema...';
        
        const response = await fetch(`${API_BASE()}/test_config_safe.php`, {
          method: 'GET'
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `âš™ï¸ TEST CONFIGURACIÃ“N:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… ConfiguraciÃ³n del sistema OK';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en configuraciÃ³n';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN TEST CONFIG:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en configuraciÃ³n';
      }
    }

    async function testAIProcessing() {
      const token = getToken();
      const key = getOpenAIKey();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!key) return alert('âŒ Completa OpenAI API Key');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'ğŸ§  Probando procesamiento de IA...';
        
        const response = await fetch(`${API_BASE()}/test_ai_processing_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-OpenAI-Key': key,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ§  TEST IA PROCESSING:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Procesamiento de IA listo';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en procesamiento de IA';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN TEST IA PROCESSING:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en procesamiento de IA';
      }
    }

    async function testAsyncExtraction() {
      const token = getToken();
      const key = getOpenAIKey();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!key) return alert('âŒ Completa OpenAI API Key');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'âš¡ Iniciando extracciÃ³n asÃ­ncrona...';
        el('statusText').textContent = 'âš¡ Procesando con timeout extendido...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_async_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-OpenAI-Key': key,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `âš¡ EXTRACCIÃ“N ASÃNCRONA:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… ExtracciÃ³n asÃ­ncrona completada';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en extracciÃ³n asÃ­ncrona';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN EXTRACCIÃ“N ASÃNCRONA:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en extracciÃ³n asÃ­ncrona';
      }
    }

    async function testOptimizedExtraction() {
      const token = getToken();
      const key = getOpenAIKey();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!key) return alert('âŒ Completa OpenAI API Key');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'ğŸš€ Iniciando extracciÃ³n optimizada...';
        el('statusText').textContent = 'ğŸš€ Procesando con lÃ­mites optimizados...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_optimized_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-OpenAI-Key': key,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸš€ EXTRACCIÃ“N OPTIMIZADA:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… ExtracciÃ³n optimizada completada';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en extracciÃ³n optimizada';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN EXTRACCIÃ“N OPTIMIZADA:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en extracciÃ³n optimizada';
      }
    }

    async function testDebugReal() {
      const token = getToken();
      const key = getOpenAIKey();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!key) return alert('âŒ Completa OpenAI API Key');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'ğŸ”¬ Iniciando debug real...';
        el('statusText').textContent = 'ğŸ”¬ Debugging extracciÃ³n real...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_debug_real_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-OpenAI-Key': key,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ”¬ DEBUG REAL:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Debug real completado';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en debug real';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN DEBUG REAL:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en debug real';
      }
    }

    async function testOpenAIConnection() {
      const token = getToken();
      const key = getOpenAIKey();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!key) return alert('âŒ Completa OpenAI API Key');

      try {
        el('aiResult').textContent = 'ğŸ”— Probando conexiÃ³n a OpenAI...';
        el('statusText').textContent = 'ğŸ”— Testeando endpoints de OpenAI...';
        
        const response = await fetch(`${API_BASE()}/test_openai_connection_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-OpenAI-Key': key,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ”— TEST OPENAI CONNECTION:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… ConexiÃ³n a OpenAI verificada';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en conexiÃ³n a OpenAI';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN TEST OPENAI:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en test de OpenAI';
      }
    }

    async function testFilesAPI() {
      const token = getToken();
      const key = getOpenAIKey();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!key) return alert('âŒ Completa OpenAI API Key');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'ğŸ“ Probando Files API...';
        el('statusText').textContent = 'ğŸ“ Testeando con Files API (no Responses)...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_files_api_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'X-OpenAI-Key': key,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ“ FILES API TEST:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… Files API funciona correctamente';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas con Files API';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN FILES API:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en Files API';
      }
    }

    async function testSimulated() {
      const token = getToken();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'ğŸ­ Probando extracciÃ³n simulada...';
        el('statusText').textContent = 'ğŸ­ Simulando sin llamadas a OpenAI...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_simulated_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ­ EXTRACCIÃ“N SIMULADA:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… ExtracciÃ³n simulada completada';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en extracciÃ³n simulada';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN EXTRACCIÃ“N SIMULADA:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en extracciÃ³n simulada';
      }
    }

    async function testGemini() {
      const token = getToken();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'ğŸ’ Probando extracciÃ³n con Gemini...';
        el('statusText').textContent = 'ğŸ’ Usando Gemini API en lugar de OpenAI...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_gemini_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ’ EXTRACCIÃ“N CON GEMINI:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… ExtracciÃ³n con Gemini completada';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas con Gemini';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN EXTRACCIÃ“N CON GEMINI:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en extracciÃ³n con Gemini';
      }
    }

    async function testHybrid() {
      const token = getToken();
      const fileId = getFileId();
      
      if (!token) return alert('âŒ Completa JWT Token');
      if (!fileId) return alert('âŒ Completa File ID');

      try {
        el('aiResult').textContent = 'ğŸ”„ Probando extracciÃ³n hÃ­brida...';
        el('statusText').textContent = 'ğŸ”„ Gemini como principal, OpenAI como fallback...';
        
        const response = await fetch(`${API_BASE()}/ai_extract_content_hybrid_safe.php`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ file_id: fileId })
        });
        
        const result = await response.json();
        
        el('aiResult').textContent = `ğŸ”„ EXTRACCIÃ“N HÃBRIDA:\n${JSON.stringify(result, null, 2)}`;
        
        if (result.ok) {
          el('statusText').textContent = 'âœ… ExtracciÃ³n hÃ­brida completada';
        } else {
          el('statusText').textContent = 'âš ï¸ Problemas en extracciÃ³n hÃ­brida';
        }
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EN EXTRACCIÃ“N HÃBRIDA:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error en extracciÃ³n hÃ­brida';
      }
    }

    async function extractUserData() {
      const token = getToken();
      if (!token) return alert('âŒ Completa JWT Token');
      
      try {
        el('aiResult').textContent = 'ğŸ‘¤ Extrayendo datos especÃ­ficos del usuario...';
        el('statusText').textContent = 'ğŸ‘¤ Obteniendo IA, modelo y API key reales...';
        
        // 1. Obtener configuraciÃ³n del usuario
        const settingsResponse = await fetch(`${API_BASE()}/settings_get_safe.php`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const settingsResult = await settingsResponse.json();
        
        // 2. Obtener API keys REALES del usuario (no enmascaradas)
        const keysResponse = await fetch(`${API_BASE()}/user_keys_get_safe.php`, {
          method: 'GET',
          headers: { 'Authorization': `Bearer ${token}` }
        });
        
        const keysResult = await keysResponse.json();
        
        // 3. Extraer API key REAL del proveedor configurado usando endpoint de prueba
        let apiKeyReal = 'NO DISPONIBLE';
        const provider = settingsResult.settings?.ai_provider;
        
        if (provider === 'gemini' && keysResult.keys?.gemini?.has) {
          // PROBAR AMBAS FUNCIONES: get_api_key_for() y decrypt_text()
          const testResponse = await fetch(`${API_BASE()}/test_api_key_functions_safe.php`, {
            method: 'POST',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ provider: 'gemini' })
          });
          
          if (testResponse.ok) {
            const testResult = await testResponse.json();
            
            // Mostrar resultados de ambas funciones
            const helperResult = testResult.test_results?.get_api_key_for;
            const decryptResult = testResult.test_results?.decrypt_text;
            
            if (helperResult?.success) {
              apiKeyReal = `HELPER: ${helperResult.key_full}`;
            } else if (decryptResult?.success) {
              apiKeyReal = `DECRYPT: ${decryptResult.key_full}`;
            } else {
              apiKeyReal = 'NO DISPONIBLE - Ambas funciones fallaron';
            }
            
            // Agregar informaciÃ³n de debug
            apiKeyReal += `\n\nğŸ” DEBUG INFO:
- Helper function: ${helperResult?.success ? 'âœ… FUNCIONA' : 'âŒ FALLA'}
- Decrypt function: ${decryptResult?.success ? 'âœ… FUNCIONA' : 'âŒ FALLA'}
- Ambas iguales: ${testResult.comparison?.both_same ? 'âœ… SÃ' : 'âŒ NO'}
- Helper key: ${helperResult?.key_preview || 'EMPTY'}
- Decrypt key: ${decryptResult?.key_preview || 'EMPTY'}`;
          }
        } else if (provider === 'openai' && keysResult.keys?.openai?.has) {
          // PROBAR AMBAS FUNCIONES: get_api_key_for() y decrypt_text()
          const testResponse = await fetch(`${API_BASE()}/test_api_key_functions_safe.php`, {
            method: 'POST',
            headers: { 
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ provider: 'openai' })
          });
          
          if (testResponse.ok) {
            const testResult = await testResponse.json();
            
            // Mostrar resultados de ambas funciones
            const helperResult = testResult.test_results?.get_api_key_for;
            const decryptResult = testResult.test_results?.decrypt_text;
            
            if (helperResult?.success) {
              apiKeyReal = `HELPER: ${helperResult.key_full}`;
            } else if (decryptResult?.success) {
              apiKeyReal = `DECRYPT: ${decryptResult.key_full}`;
            } else {
              apiKeyReal = 'NO DISPONIBLE - Ambas funciones fallaron';
            }
            
            // Agregar informaciÃ³n de debug
            apiKeyReal += `\n\nğŸ” DEBUG INFO:
- Helper function: ${helperResult?.success ? 'âœ… FUNCIONA' : 'âŒ FALLA'}
- Decrypt function: ${decryptResult?.success ? 'âœ… FUNCIONA' : 'âŒ FALLA'}
- Ambas iguales: ${testResult.comparison?.both_same ? 'âœ… SÃ' : 'âŒ NO'}
- Helper key: ${helperResult?.key_preview || 'EMPTY'}
- Decrypt key: ${decryptResult?.key_preview || 'EMPTY'}`;
          }
        }
        
        // 3. Decodificar JWT para obtener info del usuario
        const jwtPayload = JSON.parse(atob(token.split('.')[1]));
        
        // 4. Extraer datos especÃ­ficos del usuario logueado
        const userSpecificData = {
          usuario_logueado: {
            id: jwtPayload.id,
            email: jwtPayload.email
          },
          ia_configurada: {
            provider: settingsResult.settings?.ai_provider || 'No configurado',
            modelo: settingsResult.settings?.ai_model || 'No configurado'
          },
          api_key_real: {
            openai: keysResult.keys?.openai?.has ? 'CONFIGURADA' : 'NO CONFIGURADA',
            gemini: keysResult.keys?.gemini?.has ? 'CONFIGURADA' : 'NO CONFIGURADA'
          },
          api_key_actual: {
            provider_usado: provider,
            key_real: apiKeyReal
          }
        };
        
        // 5. Mostrar resultado especÃ­fico y claro
        el('aiResult').textContent = `ğŸ‘¤ DATOS ESPECÃFICOS DEL USUARIO LOGUEADO:

ğŸ”‘ USUARIO: ${userSpecificData.usuario_logueado.email} (ID: ${userSpecificData.usuario_logueado.id})

ğŸ¤– IA CONFIGURADA:
   â€¢ Provider: ${userSpecificData.ia_configurada.provider}
   â€¢ Modelo: ${userSpecificData.ia_configurada.modelo}

ğŸ” API KEYS:
   â€¢ OpenAI: ${userSpecificData.api_key_real.openai}
   â€¢ Gemini: ${userSpecificData.api_key_real.gemini}

ğŸ”‘ API KEY REAL (${userSpecificData.api_key_actual.provider_usado}):
   ${userSpecificData.api_key_actual.key_real}

ğŸ“Š DATOS COMPLETOS:
${JSON.stringify(userSpecificData, null, 2)}`;
        
        el('statusText').textContent = 'âœ… Datos especÃ­ficos del usuario extraÃ­dos';
        
      } catch (error) {
        el('aiResult').textContent = `âŒ ERROR EXTRAYENDO DATOS:\n${error.message}`;
        el('statusText').textContent = 'âŒ Error extrayendo datos del usuario';
      }
    }


    function clearResults(){
      ['userSettings','fileInfo','prompt','request','aiResult','knowledgeBaseData'].forEach(id => el(id).textContent = '');
      userSettings = fileInfo = promptTxt = null;
    }
    
    // Cargar datos guardados cuando se carga la pÃ¡gina
    document.addEventListener('DOMContentLoaded', () => {
      loadSavedData();
      updateStatusIndicator();
    });
    
    // Funciones de debug
    async function runAllTests() {
      // Verificar rate limiting para pruebas completas
      if (isProcessing) {
        return alert('â³ Ya hay una extracciÃ³n en proceso. Espera a que termine.');
      }
      
      const now = Date.now();
      if (now - lastRequestTime < MIN_REQUEST_INTERVAL) {
        const remaining = Math.ceil((MIN_REQUEST_INTERVAL - (now - lastRequestTime)) / 1000);
        return alert(`â³ Espera ${remaining} segundos antes de hacer otra extracciÃ³n.`);
      }

      // Marcar como procesando
      isProcessing = true;
      lastRequestTime = now;
      updateStatusIndicator();
      
      // Deshabilitar botÃ³n
      const btn = document.querySelector('button[onclick="runAllTests()"]');
      if (btn) {
        btn.disabled = true;
        btn.textContent = 'â³ Ejecutando Todas las Pruebas...';
      }

      try {
        const debugEl = el('debugInfo');
        debugEl.textContent = 'ğŸš€ INICIANDO EXTRACCIÃ“N COMPLETA CON ENDPOINT MEJORADO (AUTO-DETECTA TIPO + USA DATOS USUARIO + GUARDA EN DB PERMANENTEMENTE EN TABLA knowledge_base + knowledge_files + openai_file_id + TRACEABILITY + LOGS)...\n\n';
        
        // FunciÃ³n helper para delay
        const delay = (ms) => new Promise(resolve => setTimeout(resolve, ms));
        // 1. ConfiguraciÃ³n del usuario
        debugEl.textContent += '1ï¸âƒ£ CONFIGURACIÃ“N DEL USUARIO (IA + MODELO + API KEY):\n';
        await getUserSettings();
        debugEl.textContent += el('userSettings').textContent + '\n\n';
        await delay(500); // 500ms delay
        
        // 2. InformaciÃ³n del archivo
        debugEl.textContent += '2ï¸âƒ£ INFORMACIÃ“N DEL ARCHIVO (AUTO-DETECTA TIPO):\n';
        await getFileInfo();
        debugEl.textContent += el('fileInfo').textContent + '\n\n';
        await delay(500); // 500ms delay
        
        // 3. Prompt construido
        debugEl.textContent += '3ï¸âƒ£ PROMPT CONSTRUIDO (MUESTRA):\n';
        buildPrompt();
        debugEl.textContent += el('prompt').textContent + '\n\n';
        await delay(200); // 200ms delay
        
        // 4. Consulta completa
        debugEl.textContent += '4ï¸âƒ£ CONSULTA COMPLETA (MUESTRA):\n';
        buildRequest();
        debugEl.textContent += el('request').textContent + '\n\n';
        await delay(200); // 200ms delay
        
        // 5. Enviar a IA (esta es la operaciÃ³n mÃ¡s pesada)
        debugEl.textContent += '5ï¸âƒ£ ENVIANDO A IA (ENDPOINT MEJORADO - AUTO-DETECTA TIPO + USA DATOS USUARIO + GUARDA EN DB PERMANENTEMENTE EN TABLA knowledge_base + knowledge_files + openai_file_id + TRACEABILITY + LOGS):\n';
        await sendToAI();
        debugEl.textContent += el('aiResult').textContent + '\n\n';
        await delay(1000); // 1 segundo delay despuÃ©s de la operaciÃ³n mÃ¡s pesada
        
        // 6. Datos de Knowledge Base
        debugEl.textContent += '6ï¸âƒ£ DATOS DE KNOWLEDGE BASE (GUARDADO REAL EN DB - PERSISTE RESULTADO PERMANENTEMENTE EN TABLA knowledge_base + knowledge_files + openai_file_id + TRACEABILITY + LOGS):\n';
        debugEl.textContent += el('knowledgeBaseData').textContent + '\n\n';
        
        debugEl.textContent += 'âœ… EXTRACCIÃ“N COMPLETA CON ENDPOINT MEJORADO COMPLETADA (AUTO-DETECTA TIPO + USA DATOS USUARIO + GUARDA EN DB PERMANENTEMENTE EN TABLA knowledge_base + knowledge_files + openai_file_id + TRACEABILITY + LOGS)\n';
        
      } catch (error) {
        debugEl.textContent += `âŒ ERROR EN PRUEBAS: ${error.message}\n`;
      } finally {
        // Restaurar botÃ³n y estado
        isProcessing = false;
        updateStatusIndicator();
        startCooldownTimer();
        if (btn) {
          btn.disabled = false;
          btn.textContent = 'ğŸš€ Ejecutar Todas las Pruebas';
        }
      }
    }
    
    function copyDebugInfo() {
      const debugText = el('debugInfo').textContent;
      navigator.clipboard.writeText(debugText).then(() => {
        alert('âœ… Debug info copiado al portapapeles');
      }).catch(() => {
        alert('âŒ Error al copiar');
      });
    }
    
    function clearDebugInfo() {
      el('debugInfo').textContent = '';
    }
  </script>
</body>
</html>
