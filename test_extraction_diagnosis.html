<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagn√≥stico de Herramientas de Extracci√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="static/js/config-portable.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-8">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100 mb-6">
            üîß Diagn√≥stico de Herramientas de Extracci√≥n
        </h1>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
                Problema Identificado
            </h2>
            
            <div class="space-y-4 text-gray-700 dark:text-gray-300">
                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                    <h3 class="font-semibold text-red-800 dark:text-red-200 mb-2">‚ùå Problema Principal:</h3>
                    <p>El bot√≥n "Extraer Contenido" muestra contenido simulado en lugar de extraer texto real del PDF.</p>
                </div>
                
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">üîç Causa Probable:</h3>
                    <p>El servidor no tiene las herramientas necesarias instaladas (<code>pdftotext</code>, <code>shell_exec</code>, etc.)</p>
                </div>
                
                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800 dark:text-green-200 mb-2">‚úÖ Soluci√≥n:</h3>
                    <p>Ejecutar diagn√≥stico para identificar exactamente qu√© herramientas est√°n disponibles y cu√°les faltan.</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
                Ejecutar Diagn√≥stico
            </h2>
            
            <div class="space-y-4">
                <button onclick="runDiagnosis()" 
                        class="w-full px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-semibold">
                    üîç Ejecutar Diagn√≥stico Completo
                </button>
                
                <button onclick="clearResults()" 
                        class="w-full px-6 py-3 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                    üóëÔ∏è Limpiar Resultados
                </button>
            </div>
        </div>
        
        <div id="results" class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 dark:text-gray-100 mb-4">
                Resultados del Diagn√≥stico
            </h2>
            <div id="results-content" class="text-gray-700 dark:text-gray-300">
                Haz clic en "Ejecutar Diagn√≥stico Completo" para comenzar...
            </div>
        </div>
    </div>

    <script>
        // Funci√≥n para mostrar resultados
        function showResult(title, data, success = true) {
            const resultsContent = document.getElementById('results-content');
            const timestamp = new Date().toLocaleString();
            
            const resultHtml = `
                <div class="mb-6 p-4 rounded-lg ${success ? 'bg-green-50 dark:bg-green-900/20' : 'bg-red-50 dark:bg-red-900/20'}">
                    <h3 class="font-semibold ${success ? 'text-green-800 dark:text-green-200' : 'text-red-800 dark:text-red-200'} mb-2">
                        ${success ? '‚úÖ' : '‚ùå'} ${title}
                    </h3>
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-3">${timestamp}</p>
                    <pre class="text-sm bg-white dark:bg-gray-800 p-4 rounded border overflow-x-auto max-h-96">${JSON.stringify(data, null, 2)}</pre>
                </div>
            `;
            
            resultsContent.innerHTML = resultHtml + resultsContent.innerHTML;
        }
        
        // Funci√≥n para limpiar resultados
        function clearResults() {
            document.getElementById('results-content').innerHTML = 'Resultados limpiados...';
        }
        
        // Funci√≥n principal de diagn√≥stico
        async function runDiagnosis() {
            try {
                showResult('Iniciando diagn√≥stico de herramientas de extracci√≥n...', {}, true);
                
                const response = await fetch(ConfigPortable.getApiUrl('diagnose_extraction_tools_safe.php'), {
                    headers: {
                        'Authorization': 'Bearer ' + (localStorage.getItem('auth_token') || 'test-token')
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (data.ok) {
                    showResult('Diagn√≥stico Completado - An√°lisis Detallado', data.diagnostic, true);
                    
                    // An√°lisis espec√≠fico de recomendaciones
                    if (data.diagnostic.recommendations && data.diagnostic.recommendations.length > 0) {
                        showResult('Recomendaciones del Sistema', {
                            recommendations: data.diagnostic.recommendations,
                            summary: `Se encontraron ${data.diagnostic.recommendations.length} problemas que resolver`
                        }, false);
                    }
                    
                    // An√°lisis de herramientas disponibles
                    const availableTools = data.diagnostic.available_tools;
                    const toolAnalysis = {
                        shell_exec: availableTools.shell_exec?.available ? '‚úÖ Disponible' : '‚ùå No disponible',
                        pdftotext: availableTools.pdftotext?.available ? '‚úÖ Disponible' : '‚ùå No disponible',
                        TCPDF: availableTools.TCPDF?.available ? '‚úÖ Disponible' : '‚ùå No disponible',
                        PHPWord: availableTools.PHPWord?.available ? '‚úÖ Disponible' : '‚ùå No disponible'
                    };
                    
                    showResult('Estado de Herramientas de Extracci√≥n', toolAnalysis, true);
                    
                } else {
                    showResult('Error en Diagn√≥stico', data, false);
                }
                
            } catch (error) {
                showResult('Error de Conexi√≥n', {error: error.message}, false);
            }
        }
        
        // Funci√≥n para mostrar resumen ejecutivo
        function showExecutiveSummary(diagnostic) {
            const summary = {
                'Problema Principal': 'Herramientas de extracci√≥n no disponibles en el servidor',
                'shell_exec': diagnostic.php_config.shell_exec_available ? '‚úÖ Habilitado' : '‚ùå Deshabilitado',
                'pdftotext': diagnostic.available_tools.pdftotext.available ? '‚úÖ Instalado' : '‚ùå No instalado',
                'TCPDF': diagnostic.available_tools.TCPDF.available ? '‚úÖ Disponible' : '‚ùå No disponible',
                'Archivos de Conocimiento': diagnostic.knowledge_files.length + ' archivos encontrados',
                'Recomendaciones': diagnostic.recommendations.length + ' acciones requeridas'
            };
            
            showResult('Resumen Ejecutivo', summary, true);
        }
    </script>
</body>
</html>
