<!DOCTYPE html>
<html lang="es-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ”¬ AI Diagnostic Tool - CATAI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .content { padding: 30px; }
        .section { 
            margin-bottom: 30px; 
            padding: 25px; 
            border: 2px solid #e0e0e0; 
            border-radius: 10px; 
            background: #fafafa;
        }
        .section h2 { 
            color: #2c3e50; 
            margin-bottom: 20px; 
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #2c3e50; 
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; 
            border-color: #3498db; 
        }
        .btn { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); 
        }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .btn-primary { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }
        .btn-dark { background: linear-gradient(135deg, #343a40 0%, #23272b 100%); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .result { 
            margin-top: 20px; 
            padding: 20px; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .result.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .result.warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .status { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: 600;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”¬ AI Diagnostic Tool</h1>
            <p>DiagnÃ³stico profesional de extracciÃ³n de contenido con IA</p>
        </div>
        
        <div class="content">
            <!-- SECCIÃ“N 1: CONFIGURACIÃ“N BÃSICA -->
            <div class="section">
                <h2>ğŸ”§ 1. ConfiguraciÃ³n BÃ¡sica</h2>
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label>JWT Token:</label>
                            <input type="text" id="jwtToken" placeholder="Pega tu JWT token aquÃ­">
                        </div>
                        <div class="form-group">
                            <label>File ID (knowledge_files.id):</label>
                            <input type="number" id="fileId" placeholder="Ej: 27" value="27">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>API Base URL:</label>
                            <input type="text" id="apiBase" value="https://cerberogrowthsolutions.com/catai/api" readonly>
                        </div>
                        <div class="form-group">
                            <label>Usuario ID:</label>
                            <input type="text" id="userId" placeholder="Se detectarÃ¡ automÃ¡ticamente" readonly>
                        </div>
                    </div>
                </div>
                <button class="btn btn-info" onclick="validateConfig()">âœ… Validar ConfiguraciÃ³n</button>
                <button class="btn btn-warning" onclick="clearResults()">ğŸ—‘ï¸ Limpiar Resultados</button>
            </div>

            <!-- SECCIÃ“N 2: DIAGNÃ“STICO PASO A PASO -->
            <div class="section">
                <h2>ğŸ” 2. DiagnÃ³stico Paso a Paso</h2>
                <div class="grid">
                    <div>
                        <button class="btn" onclick="testBasicConnectivity()">ğŸŒ Test Conectividad BÃ¡sica</button>
                        <button class="btn" onclick="testAuthentication()">ğŸ” Test AutenticaciÃ³n</button>
                        <button class="btn" onclick="testUserSettings()">âš™ï¸ Test ConfiguraciÃ³n Usuario</button>
                        <button class="btn" onclick="testFileAccess()">ğŸ“ Test Acceso Archivo</button>
                    </div>
                    <div>
                        <button class="btn" onclick="testApiKey()">ğŸ”‘ Test API Key</button>
                        <button class="btn" onclick="testAiProvider()">ğŸ¤– Test Proveedor IA</button>
                        <button class="btn" onclick="testFileContent()">ğŸ“„ Test Contenido Archivo</button>
                        <button class="btn" id="test-runop-btn">âš¡ Test runOp()</button>
                        <button class="btn" id="list-ai-resources-btn">ğŸ“‹ Listar IA Resources</button>
                        <button class="btn" id="upload-to-ai-btn">â¬†ï¸ Subir a IA</button>
                        <button class="btn" id="test-extract-btn">ğŸ§ª Test ExtracciÃ³n IA</button>
                        <button class="btn" id="test-provider-debug-btn">ğŸ” Test Provider Debug</button>
                        <button class="btn" id="test-runop-direct-btn">âš¡ Test runOp Directo</button>
                        <button class="btn" id="debug-ops-json-btn">ğŸ”§ Debug ops_json</button>
                        <button class="btn" id="add-vs-get-btn">â• AÃ±adir vs.get</button>
                        <button class="btn" id="restore-vs-get-btn">ğŸ”§ Restaurar vs.get</button>
                        <button class="btn" id="fix-vs-get-btn">ğŸ”§ Fix vs.get</button>
                        <button class="btn" id="test-api-key-btn">ğŸ”‘ Test API Key</button>
                        <button class="btn" id="debug-api-key-btn">ğŸ› Debug API Key</button>
                        <button class="btn" id="debug-vs-store-btn">ğŸ” Debug vs.store.get</button>
                        <button class="btn" id="check-ops-btn">ğŸ“‹ Check Available Ops</button>
                        <button class="btn" id="test-var-replacement-btn">ğŸ”§ Test Variable Replacement</button>
                        <button class="btn" id="debug-header-replacement-btn">ğŸ” Debug Header Replacement</button>
                        <button class="btn" onclick="syncOpenAIFiles()">ğŸ”„ Sincronizar con OpenAI</button>
                        <button class="btn" onclick="testAuthSimple()">ğŸ” Test Auth Simple</button>
                        <button class="btn" onclick="viewLogs()">ğŸ“‹ Ver Logs</button>
                        <button class="btn" onclick="testVSConnectivity()">ğŸ”— Test VS Conectividad</button>
                        <button class="btn" onclick="checkVSFiles()">ğŸ” Verificar VS Files</button>
                        <button class="btn" onclick="cleanDuplicateFiles()">ğŸ§¹ Limpiar Duplicados</button>
                        <button class="btn" onclick="listAIResourcesNoVS()">ğŸ“‹ Archivos del Vector Store</button>
                        <input type="text" id="fileIdToDelete" placeholder="File ID a borrar (ej: file-abc123)" style="width: 300px; padding: 8px; margin: 5px;">
                        <button class="btn" onclick="deleteFileFromAI()">ğŸ—‘ï¸ Borrar File de IA</button>
                        <button class="btn" onclick="extractSummaryFromVS()">ğŸ“ Extraer Resumen del VS</button>
                        <button class="btn" onclick="cleanOrphanedFiles()">ğŸ—‘ï¸ Limpiar Archivos HuÃ©rfanos</button>
                        <button class="btn" onclick="runFullDiagnostic()">ğŸš€ DiagnÃ³stico Completo</button>
                    </div>
                </div>
            </div>

            <!-- SECCIÃ“N 3: EXTRACCIÃ“N DE IA -->
            <div class="section">
                <h2>ğŸ¤– 3. ExtracciÃ³n de IA</h2>
                <div class="form-group">
                    <label>Proveedor de IA:</label>
                    <select id="aiProvider">
                        <option value="auto">Auto (usar configuraciÃ³n del usuario)</option>
                        <option value="gemini">Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Modelo:</label>
                    <input type="text" id="aiModel" placeholder="Se detectarÃ¡ automÃ¡ticamente" readonly>
                </div>
                <button class="btn btn-success" onclick="extractWithAI()">ğŸš€ Extraer Contenido con IA</button>
                <button class="btn btn-success" onclick="extractWithAIVSNew()">ğŸ§ª Probar ai_extract_file_vs</button>
                <button class="btn btn-info" onclick="extractWithAIVSClean()">ğŸ§¹ Probar ai_extract_clean</button>
                <button class="btn btn-success" onclick="extractWithAIVSSimple()">âœ¨ Probar ai_extract_simple</button>
                <button class="btn btn-warning" onclick="testSimpleDebug()">ğŸ” Test Simple Debug</button>
                <button class="btn btn-primary" onclick="extractWithAIVSCorrect()">âœ… Probar ai_extract_correct</button>
                <button class="btn btn-success" onclick="extractWithAIFinal()">ğŸ¯ Extraer con IA Final</button>
                <button class="btn btn-primary" onclick="simulateRealButton()">ğŸ¯ SimulaciÃ³n BotÃ³n Real</button>
                <button class="btn btn-info" onclick="testDataStructures()">ğŸ” Test Estructuras</button>
                <button class="btn btn-secondary" onclick="testSimpleEndpoint()">ğŸ§ª Probar Endpoint Simple</button>
                <button class="btn btn-secondary" onclick="testDebugEndpoint()">ğŸ” Probar Endpoint Debug</button>
                <button class="btn btn-secondary" onclick="testFileInfo()">ğŸ“ Test Info Archivo</button>
                <button class="btn btn-dark" onclick="checkUserPrompt()">ğŸ“ Verificar Prompt</button>
                <button class="btn btn-warning" onclick="testAiConnection()">ğŸ”— Test ConexiÃ³n IA</button>
            </div>

            <!-- SECCIÃ“N 4: RESULTADOS -->
            <div class="section">
                <h2>ğŸ“Š 4. Resultados del DiagnÃ³stico</h2>
                <div id="results"></div>
            </div>
        </div>

        <!-- Nueva SecciÃ³n: Pruebas de API Keys -->
        <div class="section">
            <h2>ğŸ§ª Pruebas de API Keys - Sistema GenÃ©rico</h2>
            <p>Esta secciÃ³n permite probar el sistema genÃ©rico de prueba de API keys usando configuraciÃ³n declarativa desde la base de datos.</p>
            
            <div class="form-group">
                <label for="api-provider-type">Tipo de Proveedor:</label>
                <select id="api-provider-type" class="form-input">
                    <option value="data">Datos Financieros</option>
                    <option value="ai">IA</option>
                    <option value="news">Noticias</option>
                    <option value="trade">Trade</option>
                </select>
            </div>
            
            <div class="button-group">
                <button id="test-auth" class="btn btn-warning">ğŸ” Probar AutenticaciÃ³n</button>
                <button id="load-api-providers" class="btn btn-primary">ğŸ“‹ Cargar Proveedores con Claves</button>
                <button id="debug-load-providers" class="btn btn-warning">ğŸ› Debug Cargar Proveedores</button>
                <button id="setup-openai" class="btn btn-info">âš™ï¸ Configurar OpenAI</button>
                <button id="setup-data-providers" class="btn btn-info">ğŸ“Š Configurar Datos Financieros</button>
                <button id="setup-news-providers" class="btn btn-info">ğŸ“° Configurar Noticias</button>
                <button id="setup-trade-providers" class="btn btn-info">ğŸ’° Configurar Trade</button>
                <button id="debug-full-test" class="btn btn-danger">ğŸ”¥ Debug Completo</button>
                <button id="clear-api-logs" class="btn btn-secondary">ğŸ—‘ï¸ Limpiar Logs</button>
            </div>

            <!-- Contenedor de proveedores -->
            <div id="api-providers-container" style="margin-top: 20px;">
                <p>Carga los proveedores seleccionando un tipo y haciendo clic en "Cargar Proveedores con Claves".</p>
            </div>

            <!-- Logs de API -->
            <div style="margin-top: 20px;">
                <h3>ğŸ“Š Logs de Debug</h3>
                <div id="api-logs-container" style="background: #f8f9fa; border: 1px solid #dee2e6; border-radius: 5px; padding: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                    <div class="log-entry">
                        <span style="color: #6c757d;">[Sistema]</span>
                        <span style="color: #007bff;">SecciÃ³n de pruebas de API keys lista.</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- SecciÃ³n de Subida de Archivos a IA -->
        <div class="section">
            <h2>ğŸ“ Sistema de Subida de Archivos a IA</h2>
            <p>Sube archivos para procesamiento con IA, obtenciÃ³n de file_id y creaciÃ³n de vector stores.</p>
            
            <div class="form-group">
                <label for="file-input">Seleccionar Archivo:</label>
                <input type="file" id="file-input" accept=".pdf,.txt,.doc,.docx,.csv" class="form-control">
                <small class="text-muted">Tipos permitidos: PDF, TXT, DOC, DOCX, CSV (mÃ¡x. 10MB)</small>
            </div>
            
            <div class="form-group">
                <button id="upload-file-btn" class="btn btn-success">ğŸš€ Subir Archivo</button>
                <button id="list-files-btn" class="btn btn-primary">ğŸ“‹ Listar Archivos</button>
            </div>
            
            <!-- Lista de archivos subidos -->
            <div id="file-list" class="mt-4">
                <p class="text-gray-500">No hay archivos subidos</p>
            </div>
            
            <div id="file-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n global
        let currentConfig = {
            jwtToken: '',
            fileId: 20,
            apiBase: 'https://cerberogrowthsolutions.com/catai/api',
            userId: null,
            aiProvider: 'auto',
            aiModel: null
        };

        // FunciÃ³n para mostrar resultados
        function showResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${title}</strong>\n${content}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // FunciÃ³n para limpiar resultados
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }


        // FunciÃ³n para validar configuraciÃ³n
        function validateConfig() {
            const jwtToken = document.getElementById('jwtToken').value.trim();
            const fileId = document.getElementById('fileId').value;
            
            if (!jwtToken) {
                showResult('âŒ Error de ConfiguraciÃ³n', 'JWT Token es requerido', 'error');
                return false;
            }
            
            if (!fileId) {
                showResult('âŒ Error de ConfiguraciÃ³n', 'File ID es requerido', 'error');
                return false;
            }
            
            // Decodificar JWT para obtener user ID
            try {
                const payload = JSON.parse(atob(jwtToken.split('.')[1]));
                currentConfig.jwtToken = jwtToken;
                currentConfig.fileId = parseInt(fileId);
                currentConfig.userId = payload.id;
                
                document.getElementById('userId').value = currentConfig.userId;
                
                showResult('âœ… ConfiguraciÃ³n VÃ¡lida', 
                    `Usuario ID: ${currentConfig.userId}\nFile ID: ${currentConfig.fileId}\nToken vÃ¡lido hasta: ${new Date(payload.exp * 1000).toLocaleString()}`, 
                    'success');
                
                return true;
            } catch (e) {
                showResult('âŒ Error de ConfiguraciÃ³n', 'JWT Token invÃ¡lido: ' + e.message, 'error');
                return false;
            }
        }

        // FunciÃ³n para hacer requests HTTP
        async function makeRequest(endpoint, method = 'GET', body = null) {
            // Obtener token directamente del input para evitar pÃ©rdida
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!jwtToken) {
                return {
                    ok: false,
                    status: 401,
                    data: { error: 'JWT Token no configurado' },
                    raw: 'JWT Token no configurado'
                };
            }
            
            const url = `${currentConfig.apiBase}/${endpoint}`;
            const options = {
                method: method,
                headers: {
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(url, options);
                const text = await response.text();
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = { error: 'Respuesta no es JSON vÃ¡lido', raw: text };
                }
                
                return {
                    ok: response.ok,
                    status: response.status,
                    data: data,
                    raw: text
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    data: { error: error.message },
                    raw: error.message
                };
            }
        }

        // Test de conectividad bÃ¡sica
        async function testBasicConnectivity() {
            showResult('ğŸŒ Test Conectividad BÃ¡sica', 'Iniciando...', 'info');
            
            const result = await makeRequest('health.php');
            
            if (result.ok) {
                showResult('âœ… Conectividad BÃ¡sica', 
                    `Status: ${result.status}\nRespuesta: ${JSON.stringify(result.data, null, 2)}`, 
                    'success');
            } else {
                showResult('âŒ Error de Conectividad', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de autenticaciÃ³n
        async function testAuthentication() {
            showResult('ğŸ” Test AutenticaciÃ³n', 'Iniciando...', 'info');
            
            const result = await makeRequest('auth_me_safe.php');
            
            if (result.ok) {
                showResult('âœ… AutenticaciÃ³n Exitosa', 
                    `Usuario: ${result.data.email}\nID: ${result.data.id}\nRol: ${result.data.role}`, 
                    'success');
            } else {
                showResult('âŒ Error de AutenticaciÃ³n', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de configuraciÃ³n del usuario
        async function testUserSettings() {
            showResult('âš™ï¸ Test ConfiguraciÃ³n Usuario', 'Iniciando...', 'info');
            
            const result = await makeRequest('settings_get_safe.php');
            
            if (result.ok) {
                const settings = result.data.settings;
                currentConfig.aiProvider = settings.ai_provider || 'auto';
                currentConfig.aiModel = settings.ai_model || 'gpt-4o';
                
                document.getElementById('aiProvider').value = currentConfig.aiProvider;
                document.getElementById('aiModel').value = currentConfig.aiModel;
                
                showResult('âœ… ConfiguraciÃ³n Usuario', 
                    `IA Provider: ${currentConfig.aiProvider}\nModelo: ${currentConfig.aiModel}\nData Provider: ${settings.data_provider || 'N/A'}`, 
                    'success');
            } else {
                showResult('âŒ Error ConfiguraciÃ³n Usuario', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de acceso al archivo
        async function testFileAccess() {
            showResult('ğŸ“ Test Acceso Archivo', 'Iniciando...', 'info');
            
            const result = await makeRequest('test_file_access_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                const pathInfo = data.file_physical.path_components;
                const pathConstruction = data.file_physical.path_construction;
                showResult('âœ… Acceso Archivo', 
                    `File ID: ${data.file.id}\nArchivo: ${data.file.original_filename}\nTipo (DB): ${data.file.file_type}\nMIME (DB): ${data.file.mime_type}\nTamaÃ±o: ${data.file.file_size_mb} MB\n\nCONSTRUCCIÃ“N DEL PATH (PASO A PASO):\n1. ${pathConstruction.step_1}\n2. ${pathConstruction.step_2}\n3. ${pathConstruction.step_3}\n4. ${pathConstruction.step_4}\n\nPATH FINAL:\n${pathConstruction.final_path}\n\nCOMPONENTES DEL PATH:\n- Base: ${pathInfo.base_dir}\n- Uploads: ${pathInfo.uploads_dir}\n- Usuario: ${pathInfo.user_dir}\n- Archivo: ${pathInfo.filename}\n\nExiste fÃ­sicamente: ${data.file_physical.exists ? 'âœ… SÃ­' : 'âŒ No'}\nListo para extracciÃ³n: ${data.ready_for_extraction.can_proceed ? 'âœ… SÃ­' : 'âŒ No'}`, 
                    'success');
            } else {
                showResult('âŒ Error Acceso Archivo', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de API Key con nuevo sistema de cifrado externo
        async function testApiKey() {
            showResult('ğŸ”‘ Test API Key', 'Iniciando test de descifrado con sistema externo...', 'info');
            
            try {
                const result = await makeRequest('test_api_key_decryption_safe.php', 'POST', {});
                
                if (result.ok) {
                    const data = result.data;
                    let output = `ğŸ”‘ RESULTADO TEST DE DESCIFRADO:\n\n`;
                    output += `ğŸ‘¤ USUARIO: ${data.user_info.email} (ID: ${data.user_info.id})\n`;
                    output += `ğŸ¤– IA CONFIGURADA: ${data.ai_configuration.provider} (${data.ai_configuration.model})\n\n`;
                    
                    output += `ğŸ”‘ API KEY PRINCIPAL:\n`;
                    output += `  â€¢ Disponible: ${data.api_key_test.api_key_available ? 'âœ… SÃ' : 'âŒ NO'}\n`;
                    output += `  â€¢ Longitud: ${data.api_key_test.api_key_length} caracteres\n`;
                    output += `  â€¢ Preview: ${data.api_key_test.api_key_preview || 'N/A'}\n`;
                    output += `  â€¢ Inicia con: ${data.api_key_test.api_key_starts_with || 'N/A'}\n\n`;
                    
                    output += `ğŸ” TODOS LOS PROVEEDORES:\n`;
                    for (const [provider, info] of Object.entries(data.all_providers_test)) {
                        output += `  â€¢ ${provider}: ${info.available ? 'âœ…' : 'âŒ'} (${info.length} chars) ${info.preview || ''}\n`;
                    }
                    
                    output += `\nğŸ“Š RESUMEN: ${data.message}`;
                    
                    showResult('âœ… Descifrado API Keys Exitoso', output, 'success');
                } else {
                    showResult('âŒ Error en Descifrado API Keys', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showResult('âŒ Error de ConexiÃ³n', 
                    `Error: ${error.message}`, 
                    'error');
            }
        }

        // Test de proveedor de IA
        async function testAiProvider() {
            showResult('ğŸ¤– Test Proveedor IA', 'Iniciando...', 'info');
            
            const result = await makeRequest('test_file_access_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                showResult('âœ… Proveedor IA', 
                    `Provider: ${data.user_settings.ai_provider}\nModelo: ${data.user_settings.ai_model}\nAPI Key disponible: ${data.api_keys[data.user_settings.ai_provider]?.has_key ? 'âœ… SÃ­' : 'âŒ No'}`, 
                    'success');
            } else {
                showResult('âŒ Error Proveedor IA', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de contenido del archivo y subida automÃ¡tica a IA
        async function testFileContent() {
            showResult('ğŸ“„ Test Contenido Archivo', 'Iniciando...', 'info');
            
            const result = await makeRequest('test_file_access_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                showResult('âœ… Contenido Archivo', 
                    `File ID: ${data.file.id}\nArchivo: ${data.file.original_filename}\nTamaÃ±o: ${data.file_physical.size_mb} MB\nContenido (primeros 200 chars): ${data.file_physical.content_preview.substring(0, 200)}...\n\nEstado en IA: ${data.file.openai_file_id ? 'âœ… Ya subido' : 'âŒ No subido'}`, 
                    'success');
                
                // Si no estÃ¡ en la IA, proceder a subirlo automÃ¡ticamente
                if (!data.file.openai_file_id) {
                    showResult('ğŸ“„ Test Contenido Archivo', 'Archivo no estÃ¡ en la IA. Procediendo a subirlo...', 'info');
                    await uploadFileToAIFromTest(data);
                } else {
                    showResult('ğŸ“„ Test Contenido Archivo', 'Archivo ya estÃ¡ en la IA. No es necesario subirlo.', 'success');
                }
            } else {
                showResult('âŒ Error Contenido Archivo', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // FunciÃ³n auxiliar para subir archivo a IA desde el test
        async function uploadFileToAIFromTest(fileData) {
            try {
                showResult('â¬†ï¸ Subiendo a IA', 'Procesando archivo...', 'info');
                
                const uploadResult = await makeRequest('run_op_safe.php', 'POST', {
                    provider_id: 1, // OpenAI por defecto
                    op: 'vs.upload',
                    params: {
                        file_id: currentConfig.fileId
                    }
                });

                if (!uploadResult.ok) {
                    const errorMsg = uploadResult.data?.error || uploadResult.data?.detail || 'Error desconocido';
                    showResult('âŒ Error Subida IA', `Error: ${errorMsg}`, 'error');
                    return;
                }

                const result = uploadResult.data.result;
                showResult('âœ… Archivo Subido a IA', 
                    `ğŸ“„ File ID: ${result.file_id}\nğŸ“Š Estado: ${result.status}\nğŸ’¾ TamaÃ±o: ${result.bytes ? Math.round(result.bytes / 1024 / 1024 * 100) / 100 + ' MB' : 'N/A'}\nâ±ï¸ Latencia: ${uploadResult.data.latency_ms}ms\n\nEl archivo ahora estÃ¡ disponible en OpenAI para anÃ¡lisis.`, 
                    'success');

                // Actualizar la lista de recursos despuÃ©s del upload
                setTimeout(() => {
                    listAIResources();
                }, 1000);

            } catch (error) {
                showResult('âŒ Error Subida IA', `Error inesperado: ${error.message}`, 'error');
                console.error('Error en uploadFileToAIFromTest:', error);
            }
        }

        // Test de funciÃ³n runOp()
        async function testRunOpFunction() {
            showResult('âš¡ Test runOp()', 'Iniciando prueba de runOp()...', 'info');
            
            try {
                // Paso 1: vs.upload (si el archivo no tiene file_id)
                showResult('âš¡ Test runOp()', 'Paso 1: Verificando file_id...', 'info');
                
                const fileResult = await makeRequest('test_file_access_safe.php', 'POST', {
                    file_id: currentConfig.fileId
                });

                if (!fileResult.ok) {
                    showResult('âš¡ Test runOp()', `âŒ Error obteniendo archivo: ${fileResult.error}`, 'error');
                    return;
                }

                const file = fileResult.data.file;
                let externalFileId = file.openai_file_id;

                // Si no tiene file_id, hacer upload
                if (!externalFileId) {
                    showResult('âš¡ Test runOp()', 'Paso 1: Subiendo archivo a IA...', 'info');
                    
                    const uploadResult = await makeRequest('run_op_safe.php', 'POST', {
                        provider_id: 1, // OpenAI por defecto
                        op: 'vs.upload',
                        params: {
                            file_id: currentConfig.fileId
                        }
                    });

                    if (!uploadResult.ok) {
                        showResult('âš¡ Test runOp()', `âŒ Error en upload: ${uploadResult.error}`, 'error');
                        return;
                    }

                    externalFileId = uploadResult.result.file_id;
                    showResult('âš¡ Test runOp()', `âœ… Upload exitoso. File ID: ${externalFileId}`, 'success');
                } else {
                    showResult('âš¡ Test runOp()', `âœ… Archivo ya tiene file_id: ${externalFileId}`, 'success');
                }

                // Paso 2: vs.create_or_get (vector store)
                showResult('âš¡ Test runOp()', 'Paso 2: Creando/obteniendo vector store...', 'info');
                
                const vsResult = await makeRequest('run_op_safe.php', 'POST', {
                    provider_id: 1,
                    op: 'vs.create_or_get',
                    params: {}
                });

                if (!vsResult.ok) {
                    showResult('âš¡ Test runOp()', `âŒ Error en vector store: ${vsResult.error}`, 'error');
                    return;
                }

                const vsId = vsResult.result.vector_store_id;
                showResult('âš¡ Test runOp()', `âœ… Vector Store: ${vsId} (${vsResult.result.status})`, 'success');

                // Paso 3: vs.analyze (anÃ¡lisis de contenido)
                showResult('âš¡ Test runOp()', 'Paso 3: Analizando contenido...', 'info');
                
                const analyzeResult = await makeRequest('run_op_safe.php', 'POST', {
                    provider_id: 1,
                    op: 'vs.analyze',
                    params: {
                        file_id: currentConfig.fileId,
                        vector_store_id: vsId,
                        prompt: 'Extrae y analiza el contenido de este archivo, identificando los puntos mÃ¡s importantes y proporcionando un resumen estructurado.'
                    }
                });

                if (!analyzeResult.ok) {
                    showResult('âš¡ Test runOp()', `âŒ Error en anÃ¡lisis: ${analyzeResult.error}`, 'error');
                    return;
                }

                const analysis = analyzeResult.result;
                showResult('âš¡ Test runOp()', 
                    `âœ… AnÃ¡lisis completado exitosamente!\n\n` +
                    `ğŸ“Š MÃ©tricas:\n` +
                    `â€¢ Tokens entrada: ${analysis.input_tokens}\n` +
                    `â€¢ Tokens salida: ${analysis.output_tokens}\n` +
                    `â€¢ Total tokens: ${analysis.total_tokens}\n` +
                    `â€¢ Costo: $${analysis.cost_usd.toFixed(6)}\n` +
                    `â€¢ Latencia: ${analyzeResult.latency_ms}ms\n\n` +
                    `ğŸ“ Contenido extraÃ­do:\n${analysis.content.substring(0, 500)}${analysis.content.length > 500 ? '...' : ''}`, 
                    'success');

            } catch (error) {
                showResult('âš¡ Test runOp()', `âŒ Error inesperado: ${error.message}`, 'error');
                console.error('Error en testRunOpFunction:', error);
            }
        }

        // Limpiar archivos duplicados
        async function cleanDuplicateFiles() {
            showResult('ğŸ§¹ Limpiar Duplicados', 'Limpiando archivos duplicados...', 'info');
            
            try {
                const result = await makeRequest('clean_duplicate_files_safe.php', 'POST');
                
                if (result.ok && result.cleanup_result) {
                    const cleanup = result.cleanup_result;
                    showResult('âœ… Limpieza Completada', 
                        `ğŸ§¹ RESULTADOS DE LIMPIEZA:\n\n` +
                        `â€¢ Grupos duplicados encontrados: ${cleanup.total_duplicate_groups}\n` +
                        `â€¢ Archivos eliminados: ${cleanup.files_removed}\n\n` +
                        `${result.message}`, 
                        'success');
                    
                    // Recargar recursos despuÃ©s de limpiar
                    setTimeout(() => {
                        listAIResources();
                    }, 2000);
                } else {
                    showResult('âŒ Error Limpieza', 'No se pudieron limpiar los duplicados', 'error');
                }
            } catch (error) {
                showResult('âŒ Error Limpieza', `Error: ${error.message}`, 'error');
            }
        }

        // Listar archivos del Vector Store del usuario
        async function listAIResourcesNoVS() {
            showResult('ğŸ“‹ Archivos del Vector Store', 'Obteniendo archivos del VS...', 'info');
            try {
                const result = await makeRequest('list_ai_resources_safe.php', 'GET');
                if (result.ok) {
                    let message = `ğŸ“‹ ARCHIVOS DEL VECTOR STORE DEL USUARIO:\n\n`;
                    
                    if (result.vector_stores && result.vector_stores.length > 0) {
                        result.vector_stores.forEach((vs, vsIndex) => {
                            message += `ğŸ—‚ï¸ VECTOR STORE ${vsIndex + 1}: ${vs.name || 'Sin nombre'}\n`;
                            message += `   â€¢ ID: ${vs.external_id}\n`;
                            message += `   â€¢ Proveedor: ${vs.provider}\n`;
                            message += `   â€¢ Estado: ${vs.status}\n`;
                            message += `   â€¢ TamaÃ±o: ${vs.bytes_used_mb} MB\n`;
                            message += `   â€¢ Documentos: ${vs.doc_count}\n\n`;
                            
                            if (vs.vs_files && vs.vs_files.length > 0) {
                                message += `   ğŸ“„ ARCHIVOS EN ESTE VS (${vs.vs_files.length}):\n`;
                                vs.vs_files.forEach((file, fileIndex) => {
                                    message += `   ${fileIndex + 1}. File ID: ${file.file_id}\n`;
                                    message += `      Nombre: ${file.filename}\n\n`;
                                });
                            } else {
                                message += `   ğŸ“„ ARCHIVOS EN ESTE VS: 0\n\n`;
                            }
                        });
                    } else {
                        message += `ğŸ—‚ï¸ VECTOR STORES: 0\nâ€¢ No hay vector stores creados para este usuario\n\n`;
                    }
                    
                    showResult('âœ… Lista Completada', message, 'success');
                } else {
                    showResult('âŒ Error', result.message || 'Error al obtener recursos', 'error');
                }
            } catch (error) {
                showResult('âŒ Error', `Error: ${error.message}`, 'error');
            }
        }

        // Extraer resumen del Vector Store
        async function extractSummaryFromVS() {
            showResult('ğŸ“ Extraer Resumen del VS', 'Extrayendo resumen del Vector Store...', 'info');
            
            try {
                const result = await makeRequest('extract_summary_from_vs_safe.php', 'POST');
                
                if (result.ok) {
                    let message = `ğŸ“ RESUMEN EXTRAÃDO DEL VECTOR STORE:\n\n`;
                    message += `ğŸ—‚ï¸ Vector Store: ${result.vector_store_name}\n`;
                    message += `â€¢ ID: ${result.vector_store_id}\n`;
                    message += `â€¢ Knowledge Base ID: ${result.knowledge_base_id}\n`;
                    message += `â€¢ Assistant ID: ${result.assistant_id}\n\n`;
                    
                    if (result.debug_info) {
                        message += `ğŸ” DEBUG INFO:\n`;
                        message += `â€¢ VS ID: ${result.debug_info.vs_id}\n`;
                        message += `â€¢ Thread ID: ${result.debug_info.thread_id}\n`;
                        message += `â€¢ Run ID: ${result.debug_info.run_id}\n`;
                        message += `â€¢ Mensajes recibidos: ${result.debug_info.messages_count}\n`;
                        message += `â€¢ Prompt usado: ${result.debug_info.prompt_used}\n\n`;
                        
                        if (result.debug_info.extract_config_used) {
                            message += `âš™ï¸ CONFIGURACIÃ“N JSON USADA:\n`;
                            message += JSON.stringify(result.debug_info.extract_config_used, null, 2) + '\n\n';
                        }
                        
                        if (result.debug_info.parameters_sent) {
                            message += `ğŸ“¤ PARÃMETROS ENVIADOS:\n`;
                            message += JSON.stringify(result.debug_info.parameters_sent, null, 2) + '\n\n';
                        }
                    }
                    
                    message += `ğŸ“„ RESUMEN:\n${result.summary}\n\n`;
                    message += `${result.message}`;
                    
                    showResult('âœ… Resumen ExtraÃ­do', message, 'success');
                    
                    setTimeout(() => {
                        listAIResources();
                    }, 2000);
                } else {
                    let errorMessage = result.message || 'No se pudo extraer el resumen';
                    
                    // Si hay informaciÃ³n de debug, mostrarla
                    if (result.full_response) {
                        errorMessage += '\n\nğŸ” INFORMACIÃ“N DE DEBUG:\n';
                        errorMessage += JSON.stringify(result.full_response, null, 2);
                    }
                    
                    showResult('âŒ Error ExtracciÃ³n', errorMessage, 'error');
                }
            } catch (error) {
                showResult('âŒ Error ExtracciÃ³n', `Error: ${error.message}`, 'error');
            }
        }

        // Borrar file de la IA
        async function deleteFileFromAI() {
            const fileId = document.getElementById('fileIdToDelete').value.trim();
            
            if (!fileId) {
                showResult('âŒ Error', 'Debes ingresar un File ID', 'error');
                return;
            }
            
            if (!confirm(`Â¿EstÃ¡s seguro de que quieres borrar el archivo ${fileId} de la IA?`)) {
                return;
            }
            
            showResult('ğŸ—‘ï¸ Borrar File de IA', `Borrando archivo ${fileId} de la IA...`, 'info');
            
            try {
                const result = await makeRequest('delete_file_from_ai_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (result.ok) {
                    showResult('âœ… Archivo Borrado', 
                        `ğŸ—‘ï¸ ARCHIVO BORRADO EXITOSAMENTE:\n\n` +
                        `â€¢ File ID: ${result.file_id}\n` +
                        `â€¢ Nombre: ${result.filename}\n` +
                        `â€¢ Borrado de IA: âœ… SÃ­\n` +
                        `â€¢ Actualizado en DB: ${result.deleted_from_db ? 'âœ… SÃ­' : 'âŒ No'}\n\n` +
                        `${result.message}`, 
                        'success');
                    
                    // Limpiar input
                    document.getElementById('fileIdToDelete').value = '';
                    
                    setTimeout(() => {
                        listAIResources();
                    }, 2000);
                } else {
                    showResult('âŒ Error Borrado', result.message || 'No se pudo borrar el archivo', 'error');
                }
            } catch (error) {
                showResult('âŒ Error Borrado', `Error: ${error.message}`, 'error');
            }
        }

        async function cleanOrphanedFiles() {
            showResult('ğŸ—‘ï¸ Limpiar Archivos HuÃ©rfanos', 'Limpiando archivos huÃ©rfanos...', 'info');
            try {
                const result = await makeRequest('clean_orphaned_files_safe.php', 'POST');
                if (result.ok) {
                    showResult('âœ… Limpieza Completada', 
                        `ğŸ—‘ï¸ RESULTADOS DE LIMPIEZA DE ARCHIVOS HUÃ‰RFANOS:\n\n` +
                        `â€¢ Archivos huÃ©rfanos encontrados: ${result.orphaned_files_found}\n` +
                        `â€¢ Archivos eliminados: ${result.deleted_count}\n\n` +
                        `ğŸ“„ ARCHIVOS ELIMINADOS:\n` +
                        (result.deleted_files && result.deleted_files.length > 0 
                            ? result.deleted_files.map(file => 
                                `â€¢ ${file.filename} (${file.file_id}) - ${file.upload_status}`
                              ).join('\n')
                            : 'â€¢ Ninguno\n') + 
                        `\n${result.message}`, 
                        'success');
                    setTimeout(() => {
                        listAIResources();
                    }, 2000);
                } else {
                    showResult('âŒ Error Limpieza', 'No se pudieron limpiar los archivos huÃ©rfanos', 'error');
                }
            } catch (error) {
                showResult('âŒ Error Limpieza', `Error: ${error.message}`, 'error');
            }
        }

        // Probar autenticaciÃ³n simple
        async function testAuthSimple() {
            showResult('ğŸ” Test Auth Simple', 'Probando autenticaciÃ³n...', 'info');
            
            try {
                const result = await makeRequest('test_auth_simple_safe.php', 'POST');
                
                if (result.ok) {
                    showResult('âœ… AutenticaciÃ³n Exitosa', 
                        `ğŸ” TEST DE AUTENTICACIÃ“N:\n\n` +
                        `â€¢ Usuario: ${result.user?.email || 'N/A'}\n` +
                        `â€¢ ID: ${result.user_id}\n` +
                        `â€¢ Rol: ${result.user?.role || 'N/A'}\n\n` +
                        `${result.message}`, 
                        'success');
                } else {
                    let errorMsg = 'Error en autenticaciÃ³n';
                    if (result.error) {
                        errorMsg += `\nError: ${result.error}`;
                    }
                    if (result.detail) {
                        errorMsg += `\nDetalle: ${result.detail}`;
                    }
                    showResult('âŒ Error AutenticaciÃ³n', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Error AutenticaciÃ³n', `Error: ${error.message}`, 'error');
            }
        }

        // Ver logs del servidor
        async function viewLogs() {
            showResult('ğŸ“‹ Ver Logs', 'Obteniendo logs del servidor...', 'info');
            try {
                const result = await makeRequest('view_logs_safe.php', 'POST');
                if (result.ok) {
                    let message = `ğŸ“‹ LOGS DEL SERVIDOR:\n\n`;
                    
                    if (!result.log_files || Object.keys(result.log_files).length === 0) {
                        message += `â€¢ No se encontraron archivos de log\n\n`;
                    } else {
                        Object.entries(result.log_files).forEach(([filename, logInfo]) => {
                            message += `ğŸ“„ ${filename}:\n`;
                            message += `â€¢ Ruta: ${logInfo.path}\n`;
                            message += `â€¢ TamaÃ±o: ${(logInfo.size / 1024).toFixed(2)} KB\n`;
                            message += `â€¢ Modificado: ${logInfo.modified}\n`;
                            message += `â€¢ LÃ­neas: ${logInfo.lines}\n\n`;
                            
                            if (logInfo.last_50_lines && logInfo.last_50_lines.length > 0) {
                                message += `ğŸ“ ÃšLTIMAS 50 LÃNEAS:\n`;
                                logInfo.last_50_lines.forEach(line => {
                                    if (line.trim()) {
                                        message += `â€¢ ${line}\n`;
                                    }
                                });
                                message += `\n`;
                            }
                        });
                    }
                    
                    message += `${result.message}`;
                    showResult('âœ… Logs Obtenidos', message, 'success');
                } else {
                    showResult('âŒ Error Obteniendo Logs', result.message || 'Error desconocido', 'error');
                }
            } catch (error) {
                showResult('âŒ Error Obteniendo Logs', `Error: ${error.message}`, 'error');
            }
        }

        // Probar conectividad bÃ¡sica con Vector Store
        async function testVSConnectivity() {
            showResult('ğŸ”— Test VS Conectividad', 'Probando conectividad con Vector Store...', 'info');
            
            try {
                const result = await makeRequest('test_vs_connectivity_safe.php', 'POST');
                
                if (result.ok && result.vs_info) {
                    const vs = result.vs_info;
                    showResult('âœ… Conectividad VS Exitosa', 
                        `ğŸ”— CONECTIVIDAD CON VECTOR STORE:\n\n` +
                        `â€¢ VS ID: ${vs.vs_id}\n` +
                        `â€¢ Nombre: ${vs.vs_name}\n` +
                        `â€¢ ID Local: ${vs.local_id}\n` +
                        `â€¢ Estado: ${vs.status}\n` +
                        `â€¢ Bytes usados: ${vs.bytes_used || 'N/A'}\n` +
                        `â€¢ Conteo archivos: ${vs.file_counts ? JSON.stringify(vs.file_counts) : 'N/A'}\n\n` +
                        `${result.message}`, 
                        'success');
                } else {
                    let errorMsg = 'No se pudo conectar con el Vector Store';
                    if (result.error) {
                        errorMsg += `\nError: ${result.error}`;
                    }
                    if (result.detail) {
                        errorMsg += `\nDetalle: ${result.detail}`;
                    }
                    showResult('âŒ Error Conectividad', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Error Conectividad', `Error: ${error.message}`, 'error');
            }
        }

        // Verificar archivos en Vector Store
        async function checkVSFiles() {
            showResult('ğŸ” Verificar VS Files', 'Verificando archivos en Vector Stores...', 'info');
            
            try {
                const result = await makeRequest('check_vs_files_safe.php', 'POST');
                
                if (result.ok && result.vs_check_result) {
                    const check = result.vs_check_result;
                    let message = `ğŸ” VERIFICACIÃ“N DE VECTOR STORES:\n\n`;
                    
                    check.vector_stores.forEach((vs, index) => {
                        message += `ğŸ—‚ï¸ VECTOR STORE ${index + 1}:\n` +
                            `â€¢ ID: ${vs.vs_id}\n` +
                            `â€¢ Nombre: ${vs.vs_name}\n` +
                            `â€¢ Archivos en VS: ${vs.vs_files_count}\n` +
                            `â€¢ Archivos en DB: ${vs.db_files_count}\n`;
                        
                        if (vs.error) {
                            message += `â€¢ âŒ Error: ${vs.error}\n`;
                        } else {
                            message += `â€¢ âœ… Estado: Sincronizado\n`;
                            
                            if (vs.vs_files && vs.vs_files.length > 0) {
                                message += `â€¢ ğŸ“„ Archivos en VS:\n`;
                                vs.vs_files.forEach(file => {
                                    message += `  - ${file.filename} (${file.file_id})\n`;
                                });
                            }
                        }
                        message += `\n`;
                    });
                    
                    message += `${result.message}`;
                    showResult('âœ… VerificaciÃ³n Completada', message, 'success');
                } else {
                    let errorMsg = 'No se pudieron verificar los Vector Stores';
                    if (result.error) {
                        errorMsg += `\nError: ${result.error}`;
                    }
                    if (result.detail) {
                        errorMsg += `\nDetalle: ${result.detail}`;
                    }
                    showResult('âŒ Error VerificaciÃ³n', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Error VerificaciÃ³n', `Error: ${error.message}`, 'error');
            }
        }

        // Sincronizar archivos con OpenAI
        async function syncOpenAIFiles() {
            showResult('ğŸ”„ Sincronizar con OpenAI', 'Sincronizando archivos con OpenAI...', 'info');
            
            try {
                const result = await makeRequest('sync_openai_files_safe.php', 'POST');
                
                if (result.ok && result.sync_result) {
                    const sync = result.sync_result;
                    showResult('âœ… SincronizaciÃ³n Completada', 
                        `ğŸ“Š RESULTADOS DE SINCRONIZACIÃ“N:\n\n` +
                        `â€¢ Total archivos en OpenAI: ${sync.total_openai_files}\n` +
                        `â€¢ Archivos sincronizados: ${sync.synced_files}\n` +
                        `â€¢ Nuevos archivos: ${sync.new_files}\n` +
                        `â€¢ Archivos actualizados: ${sync.updated_files}\n\n` +
                        `${result.message}`, 
                        'success');
                    
                    // Recargar recursos despuÃ©s de sincronizar
                    setTimeout(() => {
                        listAIResources();
                    }, 2000);
                } else {
                    showResult('âŒ Error SincronizaciÃ³n', 'No se pudieron sincronizar los archivos', 'error');
                }
            } catch (error) {
                showResult('âŒ Error SincronizaciÃ³n', `Error: ${error.message}`, 'error');
            }
        }

        // Listar recursos de IA (archivos, vector stores, knowledge base)
        async function listAIResources() {
            showResult('ğŸ“‹ Listar IA Resources', 'Obteniendo recursos de IA...', 'info');
            
            try {
                const result = await makeRequest('list_ai_resources_safe.php', 'GET');
                
                if (!result.ok) {
                    showResult('ğŸ“‹ Listar IA Resources', `âŒ Error: ${result.error}`, 'error');
                    return;
                }

                const data = result.data;
                let output = `ğŸ“Š ESTADÃSTICAS GENERALES:\n`;
                output += `â€¢ Total archivos: ${data.stats.total_files}\n`;
                output += `â€¢ Archivos en IA: ${data.stats.files_in_ai}\n`;
                output += `â€¢ Archivos extraÃ­dos: ${data.stats.files_extracted}\n`;
                output += `â€¢ Costo total: $${data.stats.total_cost_usd}\n`;
                output += `â€¢ Total tokens: ${data.stats.total_tokens}\n\n`;

                // Archivos
                output += `ğŸ“ ARCHIVOS (${data.files.length}):\n`;
                if (data.files.length === 0) {
                    output += `â€¢ No hay archivos subidos\n\n`;
                } else {
                    data.files.forEach((file, index) => {
                        output += `${index + 1}. ${file.filename}\n`;
                        output += `   â€¢ Tipo: ${file.file_type} (${file.file_size_mb} MB)\n`;
                        output += `   â€¢ Estado upload: ${file.upload_status}\n`;
                        output += `   â€¢ Estado extracciÃ³n: ${file.extraction_status}\n`;
                        output += `   â€¢ En IA: ${file.in_ai ? 'âœ… SÃ­' : 'âŒ No'}\n`;
                        if (file.openai_file_id) {
                            output += `   â€¢ File ID: ${file.openai_file_id}\n`;
                        }
                        if (file.vector_store_external_id) {
                            output += `   â€¢ Vector Store: ${file.vector_store_external_id}\n`;
                        }
                        if (file.last_extraction_cost) {
                            output += `   â€¢ Ãšltimo costo: $${file.last_extraction_cost}\n`;
                        }
                        if (file.last_extraction_tokens) {
                            output += `   â€¢ Ãšltimos tokens: ${file.last_extraction_tokens}\n`;
                        }
                        output += `   â€¢ Proveedor: ${file.provider}\n\n`;
                    });
                }

                // Vector Stores
                output += `ğŸ—‚ï¸ VECTOR STORES (${data.vector_stores.length}):\n`;
                if (data.vector_stores.length === 0) {
                    output += `â€¢ No hay vector stores creados\n\n`;
                } else {
                    data.vector_stores.forEach((vs, index) => {
                        output += `${index + 1}. ${vs.name || 'Sin nombre'}\n`;
                        output += `   â€¢ ID: ${vs.external_id}\n`;
                        output += `   â€¢ Proveedor: ${vs.provider}\n`;
                        output += `   â€¢ Estado: ${vs.status}\n`;
                        output += `   â€¢ TamaÃ±o: ${vs.bytes_used_mb} MB\n`;
                        output += `   â€¢ Documentos: ${vs.doc_count}\n`;
                        output += `   â€¢ Archivos en VS: ${vs.vs_files_count || 0}\n`;
                        
                        if (vs.vs_files_error) {
                            output += `   â€¢ âŒ Error consultando VS: ${vs.vs_files_error}\n`;
                        } else if (vs.vs_files && vs.vs_files.length > 0) {
                            output += `   â€¢ ğŸ“„ Archivos en VS:\n`;
                            vs.vs_files.forEach(file => {
                                output += `     - ${file.filename} (${file.file_id})\n`;
                            });
                        }
                        
                        output += `   â€¢ Operaciones disponibles: ${vs.ops_available.join(', ')}\n`;
                        output += `   â€¢ Creado: ${vs.created_at}\n\n`;
                    });
                }

                // Knowledge Base
                output += `ğŸ§  KNOWLEDGE BASE (${data.knowledge_base.length}):\n`;
                if (data.knowledge_base.length === 0) {
                    output += `â€¢ No hay contenido extraÃ­do\n\n`;
                } else {
                    data.knowledge_base.forEach((kb, index) => {
                        output += `${index + 1}. ${kb.title}\n`;
                        output += `   â€¢ Tipo: ${kb.type}\n`;
                        output += `   â€¢ Archivo fuente: ${kb.source_file}\n`;
                        output += `   â€¢ Confianza: ${kb.confidence}\n`;
                        output += `   â€¢ TamaÃ±o contenido: ${kb.content_length} chars\n`;
                        output += `   â€¢ Resumen: ${kb.summary ? kb.summary.substring(0, 100) + '...' : 'N/A'}\n`;
                        output += `   â€¢ Creado: ${kb.created_at}\n\n`;
                    });
                }

                // Agregar secciÃ³n de nombres de archivos del VS
                output += `\nğŸ“„ NOMBRES DE ARCHIVOS EN VECTOR STORES:\n`;
                let totalVSFiles = 0;
                data.vector_stores.forEach((vs, vsIndex) => {
                    if (vs.vs_files && vs.vs_files.length > 0) {
                        output += `\nVector Store ${vsIndex + 1} (${vs.name}):\n`;
                        vs.vs_files.forEach((file, fileIndex) => {
                            totalVSFiles++;
                            output += `  ${fileIndex + 1}. File ID: ${file.file_id}\n`;
                            output += `     Nombre mostrado: ${file.filename}\n`;
                            output += `     Nombre real: ${file.real_filename || 'N/A'}\n`;
                        });
                    }
                });
                
                if (totalVSFiles === 0) {
                    output += `â€¢ No hay archivos en Vector Stores\n`;
                } else {
                    output += `\nâ€¢ Total archivos en VS: ${totalVSFiles}\n`;
                }

                showResult('ğŸ“‹ Listar IA Resources', output, 'success');

            } catch (error) {
                showResult('ğŸ“‹ Listar IA Resources', `âŒ Error inesperado: ${error.message}`, 'error');
                console.error('Error en listAIResources:', error);
            }
        }

        // Subir archivo especÃ­fico a IA (solo upload)
        async function uploadFileToAIOnly() {
            showResult('â¬†ï¸ Subir a IA', 'Iniciando subida a IA...', 'info');
            
            try {
                const result = await makeRequest('run_op_safe.php', 'POST', {
                    provider_id: 1, // OpenAI por defecto
                    op: 'vs.upload',
                    params: {
                        file_id: currentConfig.fileId
                    }
                });

                if (!result.ok) {
                    const errorMsg = result.data?.error || result.data?.detail || 'Error desconocido';
                    showResult('â¬†ï¸ Subir a IA', `âŒ Error: ${errorMsg}`, 'error');
                    return;
                }

                const uploadResult = result.data.result;
                showResult('â¬†ï¸ Subir a IA', 
                    `âœ… Archivo subido exitosamente a la IA!\n\n` +
                    `ğŸ“„ Archivo ID: ${uploadResult.file_id}\n` +
                    `ğŸ“Š Estado: ${uploadResult.status}\n` +
                    `ğŸ’¾ TamaÃ±o: ${uploadResult.bytes ? Math.round(uploadResult.bytes / 1024 / 1024 * 100) / 100 + ' MB' : 'N/A'}\n` +
                    `â±ï¸ Latencia: ${result.data.latency_ms}ms\n\n` +
                    `El archivo ahora estÃ¡ disponible en OpenAI para anÃ¡lisis.`, 
                    'success');

                // Actualizar la lista de archivos despuÃ©s del upload
                setTimeout(() => {
                    listAIResources();
                }, 1000);

            } catch (error) {
                showResult('â¬†ï¸ Subir a IA', `âŒ Error inesperado: ${error.message}`, 'error');
                console.error('Error en uploadFileToAIOnly:', error);
            }
        }

        // Test de extracciÃ³n IA usando el sistema existente
        async function testAIExtraction() {
            showResult('ğŸ§ª Test ExtracciÃ³n IA', 'Probando configuraciÃ³n de extracciÃ³n...', 'info');
            
            // Obtener file_id directamente del input
            const fileId = document.getElementById('fileId').value;
            if (!fileId) {
                showResult('âŒ Error Test ExtracciÃ³n', 'File ID es requerido. Configure el File ID en el input.', 'error');
                return;
            }
            
            try {
                const result = await makeRequest('test_ai_extract_simple_safe.php', 'POST', {
                    file_id: parseInt(fileId)
                });

                if (!result.ok) {
                    const errorMsg = result.data?.error || result.data?.detail || 'Error desconocido';
                    showResult('âŒ Error Test ExtracciÃ³n', `Error: ${errorMsg}`, 'error');
                    return;
                }

                const data = result.data;
                let message = `ğŸ§ª FLUJO COMPLETO DE EXTRACCIÃ“N:\n\n` +
                    `ğŸ‘¤ Usuario: ${data.user.email} (ID: ${data.user.id})\n` +
                    `ğŸ“„ File ID: ${data.file?.id || fileId}\n\n` +
                    `âš™ï¸ CONFIGURACIÃ“N IA:\n` +
                    `â€¢ Proveedor: ${data.settings.ai_provider}\n` +
                    `â€¢ Modelo: ${data.settings.ai_model}\n` +
                    `â€¢ Prompt personalizado: ${data.settings.has_custom_prompt ? 'âœ… SÃ­' : 'âŒ No'}\n\n` +
                    `ğŸ“Š ESTADO DE SINCRONIZACIÃ“N:\n` +
                    `â€¢ Tiene file_id: ${data.sync_status?.has_file_id ? 'âœ… SÃ­' : 'âŒ No'}\n` +
                    `â€¢ Necesita upload: ${data.sync_status?.needs_upload ? 'âœ… SÃ­' : 'âŒ No'}\n` +
                    `â€¢ Problema de sync: ${data.sync_status?.sync_issue ? 'âš ï¸ SÃ­' : 'âœ… No'}\n\n`;
                
                if (data.upload_result) {
                    message += `â¬†ï¸ RESULTADO UPLOAD:\n` +
                        `â€¢ Estado: ${data.upload_result.success ? 'âœ… Exitoso' : 'âŒ Fallido'}\n` +
                        `â€¢ File ID OpenAI: ${data.upload_result.openai_file_id || 'N/A'}\n` +
                        `â€¢ Costo: $${data.upload_result.cost_usd || '0.000000'}\n\n`;
                }
                
                if (data.vector_store_result) {
                    message += `ğŸ—‚ï¸ RESULTADO VECTOR STORE:\n` +
                        `â€¢ Estado: ${data.vector_store_result.success ? 'âœ… Exitoso' : 'âŒ Fallido'}\n` +
                        `â€¢ VS ID: ${data.vector_store_result.vector_store_id || 'N/A'}\n` +
                        `â€¢ AcciÃ³n: ${data.vector_store_result.status || 'N/A'}\n` +
                        `â€¢ Mensaje: ${data.vector_store_result.message || 'N/A'}\n\n`;
                }
                
                if (data.attach_result) {
                    message += `ğŸ“ RESULTADO ADJUNTAR:\n` +
                        `â€¢ Estado: ${data.attach_result.success ? 'âœ… Exitoso' : 'âŒ Fallido'}\n` +
                        `â€¢ Mensaje: ${data.attach_result.message || 'N/A'}\n\n`;
                }
                
                message += `ğŸ¯ PRÃ“XIMOS PASOS: ${data.next_steps?.description || 'N/A'}\n\n` +
                    `ğŸ“Š Estado Final: ${data.message}`;
                
                showResult('âœ… Test ExtracciÃ³n IA', message, 'success');

                // Si se creÃ³ un Vector Store, recargar recursos para mostrarlo
                if (data.vector_store_result?.success) {
                    setTimeout(() => {
                        showResult('ğŸ”„ Recargando recursos...', 'Actualizando lista de Vector Stores...', 'info');
                        listAIResources();
                    }, 2000);
                }

            } catch (error) {
                showResult('âŒ Error Test ExtracciÃ³n', `Error inesperado: ${error.message}`, 'error');
                console.error('Error en testAIExtraction:', error);
            }
        }

        // Test de debug del provider
        async function testProviderDebug() {
            showResult('ğŸ” Test Provider Debug', 'Verificando configuraciÃ³n del proveedor...', 'info');
            
            try {
                const result = await makeRequest('test_provider_debug_safe.php', 'GET');
                
                if (result.ok) {
                    const debug = result.debug;
                    let output = `âœ… Provider Debug Exitoso\n\n`;
                    output += `ğŸ‘¤ Usuario ID: ${debug.user_id}\n`;
                    output += `ğŸ¤– AI Provider: ${debug.ai_provider}\n`;
                    output += `ğŸ§  AI Model: ${debug.ai_model}\n`;
                    output += `ğŸ†” Default Provider ID: ${debug.default_provider_id || 'NULL'}\n`;
                    output += `ğŸ†” Default Model ID: ${debug.default_model_id || 'NULL'}\n\n`;
                    output += `ğŸ“Š Provider Info:\n`;
                    output += `â€¢ ID: ${debug.provider.id}\n`;
                    output += `â€¢ Slug: ${debug.provider.slug}\n`;
                    output += `â€¢ Has ops_json: ${debug.provider.has_ops_json ? 'âœ…' : 'âŒ'}\n`;
                    output += `â€¢ ops_json size: ${debug.provider.ops_json_size} chars\n\n`;
                    output += `âš™ï¸ OperaciÃ³n '${debug.operation.name}':\n`;
                    output += `â€¢ Existe: ${debug.operation.exists ? 'âœ…' : 'âŒ'}\n`;
                    
                    if (debug.operation.exists) {
                        output += `â€¢ Config: ${JSON.stringify(debug.operation.config, null, 2)}`;
                    }
                    
                    showResult('âœ… Provider Debug', output, 'success');
                } else {
                    showResult('âŒ Error Provider Debug', result.error || 'Error desconocido', 'error');
                }
            } catch (error) {
                showResult('âŒ Error Provider Debug', `Error inesperado: ${error.message}`, 'error');
                console.error('Error en testProviderDebug:', error);
            }
        }

        // Test directo de runOp
        async function testRunOpDirect() {
            showResult('âš¡ Test runOp Directo', 'Probando llamada directa a runOp...', 'info');
            
            try {
                const result = await makeRequest('test_runop_direct_safe.php', 'GET');
                
                if (result.ok) {
                    const debug = result.debug;
                    let output = `âœ… Test runOp Directo Exitoso\n\n`;
                    output += `ğŸ‘¤ Usuario ID: ${debug.user_id}\n`;
                    output += `ğŸ¤– AI Provider: ${debug.ai_provider}\n`;
                    output += `ğŸ†” Default Provider ID: ${debug.default_provider_id || 'NULL'}\n`;
                    output += `ğŸ†” Final Provider ID: ${debug.final_provider_id}\n`;
                    output += `âš™ï¸ OperaciÃ³n: ${debug.operation}\n`;
                    output += `ğŸ“¡ URL: ${debug.url}\n`;
                    output += `ğŸ“Š HTTP Code: ${debug.http_code}\n\n`;
                    output += `ğŸ“¤ Payload enviado:\n${JSON.stringify(debug.payload, null, 2)}\n\n`;
                    output += `ğŸ“¥ Respuesta recibida:\n${debug.response}`;
                    
                    showResult('âœ… Test runOp Directo', output, 'success');
                } else {
                    showResult('âŒ Error Test runOp Directo', result.error || 'Error desconocido', 'error');
                }
            } catch (error) {
                showResult('âŒ Error Test runOp Directo', `Error inesperado: ${error.message}`, 'error');
                console.error('Error en testRunOpDirect:', error);
            }
        }

        // Test de conexiÃ³n con IA
        async function testAiConnection() {
            showResult('ğŸ”— Test ConexiÃ³n IA', 'Iniciando...', 'info');
            
            const result = await makeRequest('test_file_access_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                const provider = data.user_settings.ai_provider;
                const hasKey = data.api_keys[provider]?.has_key || false;
                
                showResult('âœ… ConexiÃ³n IA', 
                    `Provider: ${provider}\nModelo: ${data.user_settings.ai_model}\nAPI Key: ${hasKey ? 'âœ… Configurada' : 'âŒ No configurada'}\nListo para extracciÃ³n: ${data.ready_for_extraction.can_proceed ? 'âœ… SÃ­' : 'âŒ No'}`, 
                    hasKey ? 'success' : 'warning');
            } else {
                showResult('âŒ Error ConexiÃ³n IA', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        async function testSimpleEndpoint() {
            showResult('ğŸ§ª Test Endpoint Simple', 'Iniciando...', 'info');
            
            try {
                const result = await makeRequest('test_endpoint_simple.php', 'POST', {
                    test: 'data',
                    timestamp: new Date().toISOString()
                });
                
                if (result.ok) {
                    showResult('âœ… Endpoint Simple Funcionando', JSON.stringify(result.data, null, 2), 'success');
                } else {
                    showResult('âŒ Error Endpoint Simple', `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 'error');
                }
            } catch (error) {
                showResult('âŒ Error Endpoint Simple', error.message, 'error');
            }
        }

        // Test de endpoint debug
        async function testDebugEndpoint() {
            showResult('ğŸ” Test Endpoint Debug', 'Probando endpoint debug...', 'info');
            
            try {
                const result = await makeRequest('test_endpoint_debug.php', 'POST', {
                    test: 'debug_data',
                    file_id: document.getElementById('fileId').value || 46,
                    timestamp: new Date().toISOString()
                });
                
                if (result.ok) {
                    showResult('âœ… Test Endpoint Debug', 
                        `Status: ${result.status}\nRespuesta: ${JSON.stringify(result.data, null, 2)}`, 
                        'success');
                } else {
                    showResult('âŒ Test Endpoint Debug', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showResult('âŒ Test Endpoint Debug', `Error: ${error.message}`, 'error');
            }
        }

        // ExtracciÃ³n con IA Final (solo ai_extract_final_safe.php)
        async function extractWithAIFinal() {
            showResult('ğŸ¯ ExtracciÃ³n con IA Final', 'Iniciando extracciÃ³n directa...', 'info');
            
            try {
                const result = await makeRequest('ai_extract_final_safe.php', 'POST', {
                    file_id: currentConfig.fileId,
                    use_generic: true
                });
                
                if (result.ok) {
                    showResult('âœ… ExtracciÃ³n Exitosa', 
                        `Status: ${result.status}\nRespuesta: ${JSON.stringify(result.data, null, 2)}`, 
                        'success');
                } else {
                    showResult('âŒ Error ExtracciÃ³n', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
            } catch (error) {
                showResult('âŒ Error ExtracciÃ³n', `Error: ${error.message}`, 'error');
            }
        }

        // Nuevo: probar endpoint base ai_extract_file_vs.php
        async function extractWithAIVSNew() {
            showResult('ğŸ§ª Probar ai_extract_file_vs', 'Llamando endpoint base...', 'info');
            try {
                const result = await makeRequest('ai_extract_file_vs.php', 'POST', {
                    file_id: currentConfig.fileId
                });
                if (result.ok) {
                    showResult('âœ… ai_extract_file_vs OK', JSON.stringify(result.data, null, 2), 'success');
                } else {
                    showResult('âŒ ai_extract_file_vs Error', `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 'error');
                }
            } catch (e) {
                showResult('âŒ ai_extract_file_vs Error', e.message, 'error');
            }
        }

        async function extractWithAIVSClean() {
            showResult('ğŸ§¹ Probar ai_extract_clean', 'Llamando endpoint limpio...', 'info');
            
            // Mostrar indicador de progreso
            let progressInterval;
            let dots = 0;
            const progressMsg = () => {
                dots = (dots + 1) % 4;
                const dotStr = '.'.repeat(dots);
                showResult('â³ ai_extract_clean Procesando', `Procesando extracciÃ³n${dotStr}`, 'info');
            };
            
            try {
                // Iniciar indicador de progreso
                progressInterval = setInterval(progressMsg, 1000);
                
                const result = await makeRequest('ai_extract_file_vs_clean.php', 'POST', {
                    file_id: currentConfig.fileId
                });
                
                // Detener indicador de progreso
                clearInterval(progressInterval);
                
                if (result.ok) {
                    showResult('âœ… ai_extract_clean OK', JSON.stringify(result.data, null, 2), 'success');
                } else {
                    showResult('âŒ ai_extract_clean Error', `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 'error');
                }
            } catch (e) {
                // Detener indicador de progreso
                clearInterval(progressInterval);
                showResult('âŒ ai_extract_clean Error', e.message, 'error');
            }
        }

        async function extractWithAIVSSimple() {
            showResult('âœ¨ Probar ai_extract_simple', 'Llamando endpoint simple...', 'info');
            
            try {
                const result = await makeRequest('ai_extract_file_vs_simple.php', 'POST', {
                    file_id: currentConfig.fileId
                });
                
                if (result.ok) {
                    if (result.data.status === 'completed') {
                        showResult('âœ… ai_extract_simple Completado', `Resumen extraÃ­do:\n\n${result.data.summary}`, 'success');
                    } else if (result.data.status === 'started') {
                        showResult('â³ ai_extract_simple Iniciado', `Proceso iniciado. ${result.data.message}\n\nRun ID: ${result.data.run_id}`, 'info');
                    } else if (result.data.status === 'existing') {
                        showResult('ğŸ“‹ ai_extract_simple Existente', `Resumen ya existe:\n\n${result.data.summary}`, 'info');
                    } else {
                        showResult('âœ… ai_extract_simple OK', JSON.stringify(result.data, null, 2), 'success');
                    }
                } else {
                    showResult('âŒ ai_extract_simple Error', `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 'error');
                }
            } catch (e) {
                showResult('âŒ ai_extract_simple Error', e.message, 'error');
            }
        }

        async function testSimpleDebug() {
            showResult('ğŸ” Test Simple Debug', 'Probando endpoint de debug...', 'info');
            
            try {
                const result = await makeRequest('test_simple_debug.php', 'POST', {
                    file_id: currentConfig.fileId
                });
                
                if (result.ok) {
                    showResult('âœ… Test Simple Debug OK', JSON.stringify(result.data, null, 2), 'success');
                } else {
                    showResult('âŒ Test Simple Debug Error', `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 'error');
                }
            } catch (e) {
                showResult('âŒ Test Simple Debug Error', e.message, 'error');
            }
        }

        async function extractWithAIVSCorrect() {
            showResult('âœ… Probar ai_extract_correct', 'Llamando endpoint correcto...', 'info');
            
            try {
                const result = await makeRequest('ai_extract_file_vs_correct.php', 'POST', {
                    file_id: currentConfig.fileId
                });
                
                if (result.ok) {
                    if (result.data.status === 'completed') {
                        showResult('âœ… ai_extract_correct Completado', `Resumen extraÃ­do:\n\n${result.data.summary}`, 'success');
                    } else if (result.data.status === 'started') {
                        showResult('â³ ai_extract_correct Iniciado', `Proceso iniciado. ${result.data.message}\n\nRun ID: ${result.data.run_id}`, 'info');
                    } else {
                        showResult('âœ… ai_extract_correct OK', JSON.stringify(result.data, null, 2), 'success');
                    }
                } else {
                    showResult('âŒ ai_extract_correct Error', `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 'error');
                }
            } catch (e) {
                showResult('âŒ ai_extract_correct Error', e.message, 'error');
            }
        }

        // DiagnÃ³stico completo
        async function runFullDiagnostic() {
            showResult('ğŸš€ DiagnÃ³stico Completo', 'Iniciando diagnÃ³stico completo...', 'info');
            
            const tests = [
                { name: 'Conectividad BÃ¡sica', fn: testBasicConnectivity },
                { name: 'AutenticaciÃ³n', fn: testAuthentication },
                { name: 'ConfiguraciÃ³n Usuario', fn: testUserSettings },
                { name: 'Acceso Archivo', fn: testFileAccess },
                { name: 'API Keys', fn: testApiKey },
                { name: 'Proveedor IA', fn: testAiProvider },
                { name: 'Contenido Archivo', fn: testFileContent }
            ];
            
            for (const test of tests) {
                showResult(`ğŸ”„ Ejecutando: ${test.name}`, '...', 'info');
                await test.fn();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa de 1 segundo
            }
            
            showResult('âœ… DiagnÃ³stico Completo', 'Todos los tests han sido ejecutados', 'success');
        }

        // ExtracciÃ³n con IA
        async function extractWithAI() {
            showResult('ğŸ¤– ExtracciÃ³n con IA', 'Iniciando extracciÃ³n...', 'info');
            
            // Primero hacer test simple
            showResult('ğŸ§ª Test ConfiguraciÃ³n IA', 'Verificando configuraciÃ³n...', 'info');
            const testResult = await makeRequest('test_ai_extract_simple_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (!testResult.ok) {
                showResult('âŒ Error Test ConfiguraciÃ³n', 
                    `Status: ${testResult.status}\nError: ${JSON.stringify(testResult.data, null, 2)}`, 
                    'error');
                return;
            }
            
            showResult('âœ… Test ConfiguraciÃ³n IA', 
                `Usuario: ${testResult.data.user.email}\nProvider: ${testResult.data.settings.ai_provider}\nModelo: ${testResult.data.settings.ai_model}\nPrompt: ${testResult.data.prompt_used}\nCustom Prompt: ${testResult.data.settings.has_custom_prompt ? 'SÃ­' : 'No'}`, 
                'success');
            
            // Ahora hacer extracciÃ³n completa
            showResult('ğŸ¤– ExtracciÃ³n Completa', 'Ejecutando extracciÃ³n completa...', 'info');
            const result = await makeRequest('ai_extract_final_safe.php', 'POST', {
                file_id: currentConfig.fileId,
                use_generic: true  // Activar modo genÃ©rico
            });
            
            if (result.ok) {
                const data = result.data;
                let message = `Usuario: ${data.usuario.email}\nArchivo: ${data.archivo.nombre}\nIA: ${data.ia.provider} (${data.ia.modelo})\n\n`;
                
                if (data.mode === 'generic') {
                    message += `ğŸ”§ MODO GENÃ‰RICO ACTIVADO\n`;
                    message += `OperaciÃ³n: ${data.operacion}\n`;
                    message += `MÃ©todo: runOp + ops_json\n\n`;
                } else {
                    message += `ğŸ”§ MODO TRADICIONAL\n`;
                    message += `Tipo: ${data.archivo.tipo}\n`;
                    message += `Latencia: ${data.consulta.latencia_ms}ms\n`;
                    message += `FILE ID: ${data.archivo.openai_file_id || 'N/A'}\n`;
                    message += `ACTION: ${data.archivo.file_action || 'N/A'}\n`;
                    message += `Prompt: ${data.prompt_used ? 'Personalizado' : 'Predeterminado'}\n\n`;
                }
                
                message += `RESUMEN:\n${data.resultado.resumen}\n\n`;
                message += `GUARDADO:\nKnowledge ID: ${data.guardado.knowledge_id}\nStatus: ${data.guardado.status}`;
                
                showResult('âœ… ExtracciÃ³n Exitosa', message, 'success');
            } else {
                showResult('âŒ Error ExtracciÃ³n', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // SimulaciÃ³n completa del botÃ³n real
        async function simulateRealButton() {
            showResult('ğŸ¯ SimulaciÃ³n BotÃ³n Real', 'Iniciando simulaciÃ³n completa del botÃ³n real...', 'info');
            
            if (!validateConfig()) return;
            
            const fileId = currentConfig.fileId;
            
            try {
                // PASO 1: Obtener configuraciÃ³n completa del usuario
                showResult('ğŸ“‹ Paso 1: ConfiguraciÃ³n Usuario', 'Obteniendo configuraciÃ³n completa...', 'info');
                const configResult = await makeRequest('settings_get_safe.php');
                
                if (!configResult.ok) {
                    showResult('âŒ Error ConfiguraciÃ³n', 
                        `Status: ${configResult.status}\nError: ${JSON.stringify(configResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                const userConfig = configResult.data.settings;
                
                // Verificar estructura de configuraciÃ³n
                if (!userConfig) {
                    showResult('âŒ Error ConfiguraciÃ³n', 
                        `No se pudo obtener configuraciÃ³n del usuario:\n${JSON.stringify(configResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                showResult('âœ… ConfiguraciÃ³n Obtenida', 
                    `IA Provider: ${userConfig.ai_provider}\nModelo: ${userConfig.ai_model}\nData Provider: ${userConfig.data_provider}\nPrompt Personalizado: ${userConfig.ai_prompt_ext_conten_file ? 'SÃ­' : 'No'}`, 
                    'success');
                
                // PASO 2: Obtener informaciÃ³n del archivo
                showResult('ğŸ“ Paso 2: InformaciÃ³n Archivo', 'Obteniendo informaciÃ³n del archivo...', 'info');
                const fileResult = await makeRequest('test_file_info_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (!fileResult.ok) {
                    showResult('âŒ Error Archivo', 
                        `Status: ${fileResult.status}\nError: ${JSON.stringify(fileResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                const fileInfo = fileResult.data;
                
                // Verificar estructura de datos
                if (!fileInfo.file_db || !fileInfo.file_physical) {
                    showResult('âŒ Error Estructura', 
                        `Estructura de respuesta inesperada:\n${JSON.stringify(fileInfo, null, 2)}`, 
                        'error');
                    return;
                }
                
                showResult('âœ… Archivo Verificado', 
                    `Archivo: ${fileInfo.file_db.original_filename}\nTipo: ${fileInfo.file_db.file_type}\nTamaÃ±o: ${fileInfo.file_db.file_size_mb} MB\nExiste: ${fileInfo.file_physical.exists ? 'SÃ­' : 'No'}`, 
                    'success');
                
                // PASO 3: Verificar API Keys
                showResult('ğŸ”‘ Paso 3: API Keys', 'Verificando API keys del usuario...', 'info');
                const keysResult = await makeRequest('user_keys_get_safe.php');
                
                if (!keysResult.ok) {
                    showResult('âŒ Error API Keys', 
                        `Status: ${keysResult.status}\nError: ${JSON.stringify(keysResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                const keys = keysResult.data.keys;
                
                // Verificar estructura de API keys
                if (!keys) {
                    showResult('âŒ Error API Keys', 
                        `No se pudo obtener informaciÃ³n de API keys:\n${JSON.stringify(keysResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                const provider = userConfig.ai_provider;
                const hasKey = keys[provider]?.has || false;
                
                showResult('âœ… API Keys Verificadas', 
                    `Provider: ${provider}\nAPI Key: ${hasKey ? 'âœ… Configurada' : 'âŒ No configurada'}\nKeys disponibles: ${Object.keys(keys).filter(k => keys[k].has).join(', ')}`, 
                    hasKey ? 'success' : 'warning');
                
                if (!hasKey) {
                    showResult('âš ï¸ Advertencia', 'No hay API key configurada para el provider seleccionado. La extracciÃ³n puede fallar.', 'warning');
                }
                
                // PASO 4: Ejecutar extracciÃ³n completa
                showResult('ğŸš€ Paso 4: ExtracciÃ³n Completa', 'Ejecutando extracciÃ³n completa con IA...', 'info');
                const extractResult = await makeRequest('ai_extract_final_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (extractResult.ok) {
                    const data = extractResult.data;
                    showResult('ğŸ‰ SIMULACIÃ“N EXITOSA', 
                        `ğŸ¯ SIMULACIÃ“N COMPLETA DEL BOTÃ“N REAL\n\n` +
                        `ğŸ‘¤ USUARIO:\n` +
                        `â€¢ Email: ${data.usuario.email}\n` +
                        `â€¢ ID: ${data.usuario.id}\n\n` +
                        `ğŸ“„ ARCHIVO:\n` +
                        `â€¢ Nombre: ${data.archivo.nombre}\n` +
                        `â€¢ Tipo: ${data.archivo.tipo}\n` +
                        `â€¢ TamaÃ±o: ${data.archivo.tamaÃ±o}\n\n` +
                        `ğŸ¤– IA UTILIZADA:\n` +
                        `â€¢ Provider: ${data.ia.provider}\n` +
                        `â€¢ Modelo: ${data.ia.modelo}\n` +
                        `â€¢ Prompt: ${data.prompt_used ? 'Personalizado' : 'Predeterminado'}\n\n` +
                        `â±ï¸ RENDIMIENTO:\n` +
                        `â€¢ Latencia: ${data.consulta.latencia_ms}ms\n` +
                        `â€¢ Caracteres procesados: ${data.consulta.caracteres_procesados}\n` +
                        `â€¢ HTTP Code: ${data.consulta.http_code}\n\n` +
                        `ğŸ“Š RESULTADO:\n` +
                        `${data.resultado.resumen}\n\n` +
                        `ğŸ’¾ GUARDADO:\n` +
                        `â€¢ Knowledge ID: ${data.guardado.knowledge_id}\n` +
                        `â€¢ Status: ${data.guardado.status}\n\n` +
                        `âœ… ESTA ES EXACTAMENTE LA FUNCIONALIDAD DEL BOTÃ“N REAL`, 
                        'success');
                } else {
                    showResult('âŒ Error ExtracciÃ³n', 
                        `Status: ${extractResult.status}\nError: ${JSON.stringify(extractResult.data, null, 2)}\n\n` +
                        `ğŸ” DIAGNÃ“STICO:\n` +
                        `â€¢ ConfiguraciÃ³n: âœ… OK\n` +
                        `â€¢ Archivo: âœ… OK\n` +
                        `â€¢ API Keys: ${hasKey ? 'âœ… OK' : 'âŒ FALTA'}\n` +
                        `â€¢ ExtracciÃ³n: âŒ FALLO\n\n` +
                        `ğŸ’¡ SOLUCIÃ“N: ${hasKey ? 'Revisar configuraciÃ³n de IA o cambiar provider' : 'Configurar API key para ' + provider}`, 
                        'error');
                }
                
            } catch (error) {
                showResult('âŒ Error SimulaciÃ³n', 
                    `Error inesperado: ${error.message}\n\n` +
                    `ğŸ” Esto indica un problema en el flujo de simulaciÃ³n.`, 
                    'error');
            }
        }

        // Test de estructuras de datos
        async function testDataStructures() {
            showResult('ğŸ” Test Estructuras', 'Verificando estructuras de datos...', 'info');
            
            if (!validateConfig()) return;
            
            const fileId = currentConfig.fileId;
            
            try {
                const result = await makeRequest('test_data_structures_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (result.ok) {
                    const data = result.data;
                    showResult('âœ… Estructuras Verificadas', 
                        `ğŸ” TEST DE ESTRUCTURAS DE DATOS\n\n` +
                        `ğŸ‘¤ USUARIO:\n` +
                        `â€¢ ID: ${data.user.id}\n` +
                        `â€¢ Email: ${data.user.email}\n\n` +
                        `ğŸ“‹ CONFIGURACIÃ“N:\n` +
                        `â€¢ Estructura: ${data.structures.settings.structure}\n` +
                        `â€¢ AI Provider: ${data.structures.settings.data.ai_provider || 'No configurado'}\n` +
                        `â€¢ AI Model: ${data.structures.settings.data.ai_model || 'No configurado'}\n` +
                        `â€¢ Prompt Personalizado: ${data.structures.settings.has_custom_prompt ? 'SÃ­' : 'No'}\n\n` +
                        `ğŸ“ ARCHIVO:\n` +
                        `â€¢ Estructura: ${data.structures.file_db.structure}\n` +
                        `â€¢ Nombre: ${data.structures.file_db.data.original_filename}\n` +
                        `â€¢ Tipo: ${data.structures.file_db.data.file_type}\n` +
                        `â€¢ TamaÃ±o: ${data.structures.file_db.data.file_size} bytes\n\n` +
                        `ğŸ”‘ API KEYS:\n` +
                        `â€¢ Estructura: ${data.structures.api_keys.structure}\n` +
                        `â€¢ Providers con keys: ${data.structures.api_keys.providers_with_keys.join(', ') || 'Ninguno'}\n\n` +
                        `âœ… Todas las estructuras estÃ¡n correctas y listas para la simulaciÃ³n`, 
                        'success');
                } else {
                    showResult('âŒ Error Estructuras', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
                
            } catch (error) {
                showResult('âŒ Error Test', 
                    `Error inesperado: ${error.message}`, 
                    'error');
            }
        }

        // Test de informaciÃ³n de archivo
        async function testFileInfo() {
            showResult('ğŸ“ Test Info Archivo', 'Verificando informaciÃ³n del archivo...', 'info');
            
            if (!validateConfig()) return;
            
            const fileId = currentConfig.fileId;
            
            try {
                const result = await makeRequest('test_file_info_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (result.ok) {
                    const data = result.data;
                    showResult('âœ… Info Archivo Verificada', 
                        `ğŸ“ TEST DE INFORMACIÃ“N DE ARCHIVO\n\n` +
                        `ğŸ‘¤ USUARIO:\n` +
                        `â€¢ ID: ${data.user.id}\n` +
                        `â€¢ Email: ${data.user.email}\n\n` +
                        `ğŸ“„ ARCHIVO (DB):\n` +
                        `â€¢ ID: ${data.file_db.id}\n` +
                        `â€¢ Nombre: ${data.file_db.original_filename}\n` +
                        `â€¢ Archivo almacenado: ${data.file_db.stored_filename}\n` +
                        `â€¢ Tipo: ${data.file_db.file_type}\n` +
                        `â€¢ TamaÃ±o: ${data.file_db.file_size_mb} MB\n\n` +
                        `ğŸ’¾ ARCHIVO FÃSICO:\n` +
                        `â€¢ Ruta: ${data.file_physical.path}\n` +
                        `â€¢ Existe: ${data.file_physical.exists ? 'âœ… SÃ­' : 'âŒ No'}\n` +
                        `â€¢ TamaÃ±o: ${data.file_physical.size_mb} MB\n\n` +
                        `âœ… Estructura correcta para simulaciÃ³n`, 
                        'success');
                } else {
                    showResult('âŒ Error Info Archivo', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
                
            } catch (error) {
                showResult('âŒ Error Test', 
                    `Error inesperado: ${error.message}`, 
                    'error');
            }
        }

        // Verificar prompt del usuario
        async function checkUserPrompt() {
            showResult('ğŸ“ Verificar Prompt', 'Verificando prompt personalizado del usuario...', 'info');
            
            try {
                const result = await makeRequest('check_user_prompt_safe.php', 'GET');
                
                if (result.ok) {
                    const data = result.data;
                    const analysis = data.prompt_analysis;
                    const prompts = data.prompts;
                    
                    let promptDisplay = '';
                    if (analysis.has_custom_prompt) {
                        promptDisplay = `ğŸ“ PROMPT PERSONALIZADO (${analysis.custom_prompt_length} caracteres):\n${prompts.custom}\n\n`;
                    } else {
                        promptDisplay = `ğŸ“ NO HAY PROMPT PERSONALIZADO\n\n`;
                    }
                    
                    promptDisplay += `ğŸ”§ PROMPT PREDETERMINADO (${analysis.default_prompt_length} caracteres):\n${prompts.default}`;
                    
                    showResult('âœ… AnÃ¡lisis de Prompt Completado', 
                        `ğŸ“ VERIFICACIÃ“N DE PROMPTS\n\n` +
                        `ğŸ‘¤ USUARIO:\n` +
                        `â€¢ ID: ${data.user.id}\n` +
                        `â€¢ Email: ${data.user.email}\n\n` +
                        `ğŸ“Š ANÃLISIS:\n` +
                        `â€¢ Tiene prompt personalizado: ${analysis.has_custom_prompt ? 'âœ… SÃ­' : 'âŒ No'}\n` +
                        `â€¢ Fuente del prompt: ${analysis.prompt_source}\n` +
                        `â€¢ Longitud personalizado: ${analysis.custom_prompt_length} caracteres\n` +
                        `â€¢ Longitud predeterminado: ${analysis.default_prompt_length} caracteres\n\n` +
                        `ğŸ“ PROMPTS:\n\n${promptDisplay}`, 
                        'success');
                } else {
                    showResult('âŒ Error VerificaciÃ³n', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
                
            } catch (error) {
                showResult('âŒ Error Test', 
                    `Error inesperado: ${error.message}`, 
                    'error');
            }
        }

        // ========================================
        // FUNCIONES PARA PRUEBAS DE API KEYS
        // ========================================
        
        // Variables globales para API keys
        let currentApiProviders = [];
        let apiLogs = [];

        // FunciÃ³n para agregar logs de API
        function addApiLog(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = { timestamp, level, message, data };
            apiLogs.push(logEntry);
            
            const logsContainer = document.getElementById('api-logs-container');
            const logDiv = document.createElement('div');
            logDiv.className = `log-entry`;
            logDiv.innerHTML = `
                <span style="color: #6c757d;">[${timestamp}]</span>
                <span style="color: ${level === 'error' ? '#dc3545' : level === 'success' ? '#28a745' : '#007bff'};">${message}</span>
            `;
            
            if (data) {
                const dataDiv = document.createElement('div');
                dataDiv.className = 'log-entry';
                dataDiv.style.marginLeft = '20px';
                dataDiv.style.color = '#6c757d';
                dataDiv.textContent = JSON.stringify(data, null, 2);
                logDiv.appendChild(dataDiv);
            }
            
            logsContainer.appendChild(logDiv);
            logsContainer.scrollTop = logsContainer.scrollHeight;
        }

        // FunciÃ³n para limpiar logs de API
        function clearApiLogs() {
            apiLogs = [];
            const logsContainer = document.getElementById('api-logs-container');
            logsContainer.innerHTML = `
                <div class="log-entry">
                    <span style="color: #6c757d;">[Sistema]</span>
                    <span style="color: #007bff;">Logs limpiados.</span>
                </div>
            `;
        }

        // FunciÃ³n para obtener token de autenticaciÃ³n
        function getApiAuthToken() {
            let token = localStorage.getItem('token') || 
                       localStorage.getItem('auth_token') ||
                       sessionStorage.getItem('token') ||
                       sessionStorage.getItem('auth_token');
            
            if (!token && currentConfig.jwtToken) {
                token = currentConfig.jwtToken;
            }
            
            addApiLog('info', `Token obtenido: ${token ? 'SÃ' : 'NO'}`);
            return token;
        }

        // FunciÃ³n API helper para pruebas de API keys
        async function apiRequest(endpoint, options = {}) {
            const url = `${currentConfig.apiBase}/${endpoint}`;
            const token = getApiAuthToken();
            
            if (!token) {
                addApiLog('error', 'No se encontrÃ³ token de autenticaciÃ³n. Configura el JWT token arriba.');
                throw new Error('No hay token de autenticaciÃ³n');
            }
            
            const config = {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                ...options
            };
            
            if (config.body && typeof config.body === 'object') {
                config.body = JSON.stringify(config.body);
            }
            
            addApiLog('info', `Realizando peticiÃ³n a: ${endpoint}`);
            
            try {
                const response = await fetch(url, config);
                const data = await response.json();
                
                addApiLog('info', `Respuesta recibida (${response.status}):`, data);
                return data;
            } catch (error) {
                addApiLog('error', 'Error en peticiÃ³n de red', error);
                throw error;
            }
        }

        // FunciÃ³n para probar autenticaciÃ³n
        async function testAuth() {
            addApiLog('info', 'Probando autenticaciÃ³n...');
            
            try {
                const response = await apiRequest('test_auth_simple_safe.php', {
                    method: 'GET'
                });
                
                if (response.ok) {
                    addApiLog('success', `AutenticaciÃ³n exitosa para: ${response.user?.email || 'usuario'}`);
                    addApiLog('info', `Token: ${response.token_preview}`);
                } else {
                    addApiLog('error', `Error de autenticaciÃ³n: ${response.message || response.error}`);
                }
            } catch (error) {
                addApiLog('error', 'Error probando autenticaciÃ³n', error);
            }
        }

        // FunciÃ³n para configurar OpenAI
        async function setupOpenAI() {
            addApiLog('info', 'Configurando OpenAI con configuraciÃ³n de prueba...');
            
            try {
                const response = await apiRequest('setup_openai_test_config_safe.php', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    addApiLog('success', `âœ… ${response.message}`);
                    addApiLog('info', `Proveedor: ${response.provider_name} (ID: ${response.provider_id})`);
                    addApiLog('info', 'ConfiguraciÃ³n agregada: GET https://api.openai.com/v1/models');
                } else {
                    addApiLog('error', `Error configurando OpenAI: ${response.message}`);
                }
            } catch (error) {
                addApiLog('error', 'Error configurando OpenAI', error);
            }
        }

        // FunciÃ³n para debug completo de testProviderKey
        async function debugFullTest() {
            addApiLog('info', 'Ejecutando debug completo de testProviderKey...');
            
            try {
                const response = await apiRequest('debug_test_provider_key_safe.php', {
                    method: 'POST',
                    body: {
                        provider_type: 'ai',
                        provider_id: 1,
                        project_fields: {}
                    }
                });
                
                if (response.ok) {
                    addApiLog('success', `Debug completo de testProviderKey:`);
                    addApiLog('info', `â€¢ Provider: ${response.debug.provider_row.name}`);
                    addApiLog('info', `â€¢ Config JSON: ${JSON.stringify(response.debug.config_json_parsed)}`);
                    addApiLog('info', `â€¢ API Key Length: ${response.debug.api_key_length}`);
                    addApiLog('info', `â€¢ Test Result: ${JSON.stringify(response.debug.test_result)}`);
                    
                    if (response.debug.test_result && !response.debug.test_result.ok) {
                        addApiLog('error', `âŒ ERROR ENCONTRADO: ${response.debug.test_result.reason}`);
                        addApiLog('info', `Debug info: ${response.debug.test_result.debug}`);
                    }
                } else {
                    addApiLog('error', `Error en debug completo: ${response.message}`);
                }
            } catch (error) {
                addApiLog('error', 'Error en debug completo', error);
            }
        }

        // FunciÃ³n para cargar proveedores con claves
        async function loadApiProviders() {
            const providerType = document.getElementById('api-provider-type').value;
            addApiLog('info', `Cargando proveedores CON CLAVES de tipo: ${providerType}`);
            
            try {
                const response = await apiRequest('get_user_providers_with_keys_safe.php', {
                    method: 'POST',
                    body: {
                        provider_type: providerType
                    }
                });
                
                addApiLog('info', `Respuesta de proveedores con claves recibida`, response);
                
                if (response.ok && response.providers) {
                    currentApiProviders = response.providers;
                    renderApiProviders();
                    addApiLog('success', `Cargados ${currentApiProviders.length} proveedores CON CLAVES`);
                } else {
                    addApiLog('error', 'Error cargando proveedores con claves', response);
                }
            } catch (error) {
                addApiLog('error', 'Error cargando proveedores con claves', error);
            }
        }

        // FunciÃ³n para debug de carga de proveedores
        async function debugLoadProviders() {
            const providerType = document.getElementById('api-provider-type').value;
            addApiLog('info', `ğŸ› Debug cargando proveedores de tipo: ${providerType}`);
            
            try {
                const response = await apiRequest('debug_get_user_providers_with_keys_safe.php', {
                    method: 'POST',
                    body: {
                        provider_type: providerType
                    }
                });
                
                addApiLog('info', `ğŸ› Debug respuesta recibida`, response);
                
                if (response.ok) {
                    addApiLog('success', `âœ… Debug exitoso para ${providerType}`);
                    addApiLog('info', `â€¢ Tabla proveedores: ${response.debug.provider_table} (existe: ${response.debug.provider_table_exists ? 'SÃ' : 'NO'})`);
                    addApiLog('info', `â€¢ Tabla claves: ${response.debug.user_table} (existe: ${response.debug.user_table_exists ? 'SÃ' : 'NO'})`);
                    addApiLog('info', `â€¢ Proveedores disponibles: ${response.debug.provider_count}`);
                    addApiLog('info', `â€¢ Claves del usuario: ${response.debug.user_key_count}`);
                    addApiLog('info', `â€¢ Proveedores con claves: ${response.count}`);
                    
                    if (response.debug.provider_table_structure) {
                        addApiLog('info', `â€¢ Campos tabla proveedores: ${response.debug.provider_table_structure.join(', ')}`);
                    }
                    if (response.debug.user_table_structure) {
                        addApiLog('info', `â€¢ Campos tabla claves: ${response.debug.user_table_structure.join(', ')}`);
                    }
                } else {
                    addApiLog('error', `âŒ Debug fallido: ${response.message}`, response);
                }
            } catch (error) {
                addApiLog('error', 'âŒ Error en debug de carga de proveedores', error);
            }
        }

        // FunciÃ³n para renderizar proveedores
        function renderApiProviders() {
            const container = document.getElementById('api-providers-container');
            
            if (currentApiProviders.length === 0) {
                container.innerHTML = `
                    <div style="background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; padding: 15px; border-radius: 8px;">
                        <h4>ğŸ”‘ Sin Claves Configuradas</h4>
                        <p>No tienes claves API configuradas para este tipo de proveedor.</p>
                    </div>
                `;
                return;
            }
            
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;">';
            
            currentApiProviders.forEach(provider => {
                const config = JSON.parse(provider.config_json || '{}');
                const hasTestConfig = config.test && Object.keys(config.test).length > 0;
                
                html += `
                    <div style="border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; background: white;">
                        <div style="font-weight: 600; margin-bottom: 10px;">${provider.name}</div>
                        <div style="background: #d4edda; padding: 8px; border-radius: 4px; margin-bottom: 10px;">
                            <strong>ğŸ”‘ Clave:</strong> â€¢â€¢â€¢â€¢${provider.last4}<br>
                            <strong>Ambiente:</strong> ${provider.environment || 'live'}
                        </div>
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div style="flex: 1;">
                                <textarea id="api-fields-${provider.id}" style="width: 100%; padding: 8px; border: 1px solid #dee2e6; border-radius: 4px;" rows="2" placeholder='{"resource": "mi-recurso"}'></textarea>
                            </div>
                            <div style="display: flex; gap: 5px;">
                                <button onclick="checkProviderConfig(${provider.id}, '${provider.name}')" 
                                        style="background: #17a2b8; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                    ğŸ” Config
                                </button>
                                <button onclick="debugProviderTest(${provider.id}, '${provider.name}')" 
                                        style="background: #6f42c1; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 0.9rem;">
                                    ğŸ› Debug
                                </button>
                                <button onclick="testApiProvider(${provider.id}, '${provider.name}')" 
                                        style="background: #28a745; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;"
                                        ${!hasTestConfig ? 'disabled' : ''}>
                                    ğŸ§ª Probar
                                </button>
                            </div>
                        </div>
                        <div id="api-result-${provider.id}" style="margin-top: 15px; display: none;"></div>
                    </div>
                `;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        // FunciÃ³n para verificar configuraciÃ³n del proveedor
        async function checkProviderConfig(providerId, providerName) {
            const providerType = document.getElementById('api-provider-type').value;
            addApiLog('info', `Verificando configuraciÃ³n de: ${providerName} (ID: ${providerId})`);
            
            try {
                const response = await apiRequest('check_provider_config_safe.php', {
                    method: 'POST',
                    body: {
                        provider_type: providerType,
                        provider_id: providerId
                    }
                });
                
                if (response.ok) {
                    addApiLog('success', `ConfiguraciÃ³n de ${providerName}:`);
                    addApiLog('info', `â€¢ URL Request: ${response.provider.url_request || 'NO CONFIGURADA'}`);
                    addApiLog('info', `â€¢ Base URL: ${response.provider.base_url || 'NO CONFIGURADA'}`);
                    addApiLog('info', `â€¢ Auth Type: ${response.provider.auth_type || 'NO CONFIGURADA'}`);
                    addApiLog('info', `â€¢ Has Test Config: ${response.has_test_config ? 'SÃ' : 'NO'}`);
                    addApiLog('info', `â€¢ Test Config Keys: ${response.debug.test_config_keys.join(', ') || 'NINGUNA'}`);
                    
                    if (!response.has_test_config) {
                        addApiLog('warning', `âŒ ${providerName} NO tiene configuraciÃ³n de prueba (config_json.test)`);
                        addApiLog('info', 'Esto explica el error "No URL set!"');
                    }
                } else {
                    addApiLog('error', `Error verificando configuraciÃ³n de ${providerName}: ${response.message}`);
                }
            } catch (error) {
                addApiLog('error', `Error verificando configuraciÃ³n de ${providerName}`, error);
            }
        }

        // FunciÃ³n para debug de prueba de proveedor
        async function debugProviderTest(providerId, providerName) {
            const providerType = document.getElementById('api-provider-type').value;
            addApiLog('info', `Debug de prueba para: ${providerName} (ID: ${providerId})`);
            
            try {
                const response = await apiRequest('debug_provider_test_safe.php', {
                    method: 'POST',
                    body: {
                        provider_type: providerType,
                        provider_id: providerId
                    }
                });
                
                if (response.ok) {
                    addApiLog('success', `Debug de ${providerName}:`);
                    addApiLog('info', `â€¢ URL Request: ${response.debug.provider_row.url_request || 'NO CONFIGURADA'}`);
                    addApiLog('info', `â€¢ URL Override: ${response.debug.url_construction.url_override}`);
                    addApiLog('info', `â€¢ Final URL: ${response.debug.url_construction.final_url || 'VACÃA'}`);
                    addApiLog('info', `â€¢ URL Empty: ${response.debug.url_construction.url_empty ? 'SÃ' : 'NO'}`);
                    addApiLog('info', `â€¢ Has URL Override: ${response.debug.has_url_override ? 'SÃ' : 'NO'}`);
                    addApiLog('info', `â€¢ Test Config Keys: ${response.debug.test_config_keys.join(', ') || 'NINGUNA'}`);
                    
                    if (response.debug.url_construction.url_empty) {
                        addApiLog('warning', `âŒ PROBLEMA: La URL final estÃ¡ vacÃ­a - esto causa "No URL set!"`);
                    }
                } else {
                    addApiLog('error', `Error en debug de ${providerName}: ${response.message}`);
                }
            } catch (error) {
                addApiLog('error', `Error en debug de ${providerName}`, error);
            }
        }

        // FunciÃ³n para probar proveedor
        async function testApiProvider(providerId, providerName) {
            const providerType = document.getElementById('api-provider-type').value;
            const fieldsText = document.getElementById(`api-fields-${providerId}`).value;
            
            addApiLog('info', `Probando: ${providerName} (ID: ${providerId})`);
            
            let projectFields = {};
            if (fieldsText.trim()) {
                try {
                    projectFields = JSON.parse(fieldsText);
                } catch (error) {
                    addApiLog('error', 'Error parseando JSON', error);
                    return;
                }
            }
            
            const resultDiv = document.getElementById(`api-result-${providerId}`);
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = '<div>ğŸ”„ Probando...</div>';
            
            try {
                const response = await apiRequest('test_provider_key_safe.php', {
                    method: 'POST',
                    body: {
                        provider_type: providerType,
                        provider_id: providerId,
                        project_fields: projectFields
                    }
                });
                
                if (response.ok) {
                    resultDiv.innerHTML = `<div style="color: green;">âœ… ${providerName}: ConexiÃ³n exitosa</div>`;
                    addApiLog('success', `Prueba exitosa: ${providerName}`);
                } else {
                    resultDiv.innerHTML = `<div style="color: red;">âŒ ${providerName}: ${response.reason || 'Error'}</div>`;
                    addApiLog('error', `Prueba fallida: ${providerName}`);
                }
            } catch (error) {
                resultDiv.innerHTML = `<div style="color: red;">âŒ ${providerName}: Error de conexiÃ³n</div>`;
                addApiLog('error', `Error probando: ${providerName}`, error);
            }
        }

        // FunciÃ³n para configurar proveedores de datos financieros
        async function setupDataProviders() {
            addApiLog('info', 'Configurando proveedores de datos financieros...');
            
            try {
                const response = await apiRequest('setup_data_providers_test_configs_safe.php', {
                    method: 'POST',
                    body: {}
                });
                
                if (response.ok) {
                    addApiLog('success', `âœ… ${response.message}`);
                    addApiLog('info', `â€¢ Proveedores configurados: ${response.updated_count}/${response.total_configs}`);
                    
                    if (response.results && response.results.length > 0) {
                        addApiLog('info', 'Proveedores configurados:');
                        response.results.forEach(result => {
                            if (result.updated) {
                                addApiLog('info', `â€¢ ${result.provider_name} (${result.provider_slug}): ${result.test_config.method} ${result.test_config.url_override}`);
                            }
                        });
                    }
                    
                    if (response.errors && response.errors.length > 0) {
                        addApiLog('warning', 'Errores encontrados:');
                        response.errors.forEach(error => {
                            addApiLog('warning', `â€¢ ${error}`);
                        });
                    }
                } else {
                    addApiLog('error', `Error configurando proveedores: ${response.message || 'Error desconocido'}`);
                }
            } catch (error) {
                addApiLog('error', 'Error configurando proveedores de datos', error);
            }
        }

        // FunciÃ³n para configurar proveedores de noticias
        async function setupNewsProviders() {
            addApiLog('info', 'Configurando proveedores de noticias...');
            
            try {
                const response = await apiRequest('setup_news_providers_test_configs_safe.php', {
                    method: 'POST',
                    body: {}
                });
                
                if (response.ok) {
                    addApiLog('success', `âœ… ${response.message}`);
                    addApiLog('info', `â€¢ Proveedores configurados: ${response.updated_count}/${response.total_configs}`);
                    
                    if (response.results && response.results.length > 0) {
                        addApiLog('info', 'Proveedores configurados:');
                        response.results.forEach(result => {
                            if (result.updated) {
                                addApiLog('info', `â€¢ ${result.provider_name} (${result.provider_slug}): ${result.test_config.method} ${result.test_config.url_override}`);
                            }
                        });
                    }
                    
                    if (response.errors && response.errors.length > 0) {
                        addApiLog('warning', 'Errores encontrados:');
                        response.errors.forEach(error => {
                            addApiLog('warning', `â€¢ ${error}`);
                        });
                    }
                } else {
                    addApiLog('error', `Error configurando proveedores de noticias: ${response.message || 'Error desconocido'}`);
                }
            } catch (error) {
                addApiLog('error', 'Error configurando proveedores de noticias', error);
            }
        }

        // FunciÃ³n para configurar proveedores de trading
        async function setupTradeProviders() {
            addApiLog('info', 'Configurando proveedores de trading...');
            
            try {
                const response = await apiRequest('setup_trade_providers_test_configs_safe.php', {
                    method: 'POST',
                    body: {}
                });
                
                if (response.ok) {
                    addApiLog('success', `âœ… ${response.message}`);
                    addApiLog('info', `â€¢ Proveedores configurados: ${response.updated_count}/${response.total_configs}`);
                    
                    if (response.results && response.results.length > 0) {
                        addApiLog('info', 'Proveedores configurados:');
                        response.results.forEach(result => {
                            if (result.updated) {
                                addApiLog('info', `â€¢ ${result.provider_name} (${result.provider_slug}): ${result.test_config.method} ${result.test_config.url_override}`);
                            }
                        });
                    }
                    
                    if (response.errors && response.errors.length > 0) {
                        addApiLog('warning', 'Errores encontrados:');
                        response.errors.forEach(error => {
                            addApiLog('warning', `â€¢ ${error}`);
                        });
                    }
                } else {
                    addApiLog('error', `Error configurando proveedores de trading: ${response.message || 'Error desconocido'}`);
                }
            } catch (error) {
                addApiLog('error', 'Error configurando proveedores de trading', error);
            }
        }

        // ==================== FUNCIONALIDAD DE SUBIDA DE ARCHIVOS ====================
        
        let uploadedFiles = [];
        
        // Subir archivo usando el sistema existente
        async function uploadFileToAI() {
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];
            
            if (!file) {
                showResult('Error', 'Selecciona un archivo para subir', 'error');
                return;
            }
            
            addApiLog('info', `Iniciando subida de archivo: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`);
            
            const formData = new FormData();
            formData.append('files', file);
            
            try {
                const response = await fetch(apiBase + '/ai_upload_knowledge_safe.php', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getApiAuthToken()
                    },
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    addApiLog('success', `Archivo subido exitosamente: ${result.original_filename}`);
                    addApiLog('info', `File ID: ${result.file_id}`);
                    addApiLog('info', `Archivo almacenado: ${result.stored_filename}`);
                    
                    showResult('âœ… Archivo Subido', `Archivo ${result.original_filename} subido exitosamente. File ID: ${result.file_id}`, 'success');
                    
                    // Actualizar la lista de archivos
                    await listUploadedFiles();
                    
                } else {
                    addApiLog('error', `Error subiendo archivo: ${result.message}`);
                    showResult('Error', `Error subiendo archivo: ${result.message}`, 'error');
                }
                
            } catch (error) {
                addApiLog('error', 'Error en subida de archivo', error);
                showResult('Error', 'Error de conexiÃ³n durante la subida', 'error');
            }
        }
        
        
        // Listar archivos subidos usando el sistema existente
        async function listUploadedFiles() {
            addApiLog('info', 'Obteniendo lista de archivos subidos...');
            
            try {
                const response = await fetch(apiBase + '/ai_knowledge_list_safe.php', {
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + getApiAuthToken()
                    }
                });
                
                const result = await response.json();
                
                if (result.ok) {
                    addApiLog('success', `Encontrados ${result.files ? result.files.length : 0} archivos`);
                    
                    uploadedFiles = result.files || [];
                    updateFileList();
                    
                    showResult('ğŸ“ Archivos Listados', 
                        `Total: ${result.files ? result.files.length : 0} archivos encontrados`, 'info');
                        
                } else {
                    addApiLog('error', `Error obteniendo archivos: ${result.message}`);
                    showResult('Error', `Error obteniendo archivos: ${result.message}`, 'error');
                }
                
            } catch (error) {
                addApiLog('error', 'Error obteniendo lista de archivos', error);
                showResult('Error', 'Error de conexiÃ³n obteniendo archivos', 'error');
            }
        }
        
        // Actualizar lista de archivos en la UI
        function updateFileList() {
            const fileList = document.getElementById('file-list');
            if (!fileList) return;
            
            fileList.innerHTML = '';
            
            if (uploadedFiles.length === 0) {
                fileList.innerHTML = '<p class="text-gray-500">No hay archivos subidos</p>';
                return;
            }
            
            uploadedFiles.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item p-3 border rounded mb-2';
                fileItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-semibold">${file.filename || file.original_filename}</h4>
                            <p class="text-sm text-gray-600">
                                Tipo: ${file.file_type || 'N/A'} | 
                                TamaÃ±o: ${file.file_size_mb || (file.file_size / 1024 / 1024).toFixed(2)} MB | 
                                Estado: ${file.upload_status || 'N/A'}
                            </p>
                            ${file.ai_file_id ? `<p class="text-sm text-blue-600">AI File ID: ${file.ai_file_id}</p>` : ''}
                            ${file.vector_store_id ? `<p class="text-sm text-green-600">Vector Store: ${file.vector_store_id}</p>` : ''}
                        </div>
                        <div class="text-right">
                            <span class="badge ${file.is_processed ? 'success' : 'warning'}">
                                ${file.is_processed ? 'Procesado' : 'Pendiente'}
                            </span>
                            ${file.has_extraction ? '<span class="badge info">ExtraÃ­do</span>' : ''}
                        </div>
                    </div>
                `;
                fileList.appendChild(fileItem);
            });
        }
        
        



        // FunciÃ³n para debug header replacement
        async function debugHeaderReplacement() {
            showResult('ğŸ” Debug Header Replacement', 'Analizando reemplazo de headers...', 'info');
            
            try {
                const response = await makeRequest('debug_header_replacement_safe.php', 'GET');
                
                if (response.ok) {
                    let result = 'âœ… Debug Header Replacement OK\n\n';
                    
                    if (response.debug) {
                        result += `API Key Info:\n`;
                        result += `â€¢ Length: ${response.debug.api_key_length}\n`;
                        result += `â€¢ Prefix: ${response.debug.api_key_prefix}\n`;
                        result += `â€¢ Suffix: ${response.debug.api_key_suffix}\n\n`;
                        
                        result += `Headers Original:\n`;
                        response.debug.headers_original.forEach(header => {
                            result += `â€¢ ${header.name}: ${header.value}\n`;
                        });
                        
                        result += `\nHeaders Processed:\n`;
                        response.debug.headers_processed.forEach(header => {
                            result += `â€¢ ${header}\n`;
                        });
                        
                        result += `\nAvailable Params: ${response.debug.params.join(', ')}`;
                    }
                    
                    showResult('ğŸ” Debug Header Replacement', result, 'success');
                } else {
                    let errorMsg = `Error: ${response.error || 'unknown'}`;
                    if (response.detail) errorMsg += `\nDetail: ${response.detail}`;
                    showResult('âŒ Debug Header Replacement Error', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Debug Header Replacement Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para test variable replacement
        async function testVariableReplacement() {
            showResult('ğŸ”§ Test Variable Replacement', 'Probando reemplazo de variables...', 'info');
            
            try {
                const response = await makeRequest('test_variable_replacement_safe.php', 'GET');
                
                if (response.ok) {
                    let result = 'âœ… Test Variable Replacement OK\n\n';
                    
                    if (response.test_results) {
                        result += `Simple Template Test:\n`;
                        result += `â€¢ Original: ${response.test_results.simple_template.original}\n`;
                        result += `â€¢ Replaced: ${response.test_results.simple_template.replaced}\n`;
                        result += `â€¢ API Key Length: ${response.test_results.simple_template.api_key_length}\n`;
                        result += `â€¢ API Key Prefix: ${response.test_results.simple_template.api_key_prefix}\n`;
                        result += `â€¢ API Key Suffix: ${response.test_results.simple_template.api_key_suffix}\n\n`;
                        
                        result += `Header Template Test:\n`;
                        result += `â€¢ Original: ${response.test_results.header_template.original}\n`;
                        result += `â€¢ Replaced: ${response.test_results.header_template.replaced}\n`;
                        result += `â€¢ Contains {{API_KEY}}: ${response.test_results.header_template.contains_api_key_placeholder}\n`;
                        result += `â€¢ Contains API Key Value: ${response.test_results.header_template.contains_api_key_value}\n\n`;
                        
                        result += `Available Params: ${response.test_results.params.join(', ')}`;
                    }
                    
                    showResult('ğŸ”§ Test Variable Replacement', result, 'success');
                } else {
                    let errorMsg = `Error: ${response.error || 'unknown'}`;
                    if (response.detail) errorMsg += `\nDetail: ${response.detail}`;
                    showResult('âŒ Test Variable Replacement Error', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Test Variable Replacement Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para check available ops
        async function checkAvailableOps() {
            showResult('ğŸ“‹ Check Available Ops', 'Verificando operaciones disponibles...', 'info');
            
            try {
                const response = await makeRequest('check_available_ops_safe.php', 'GET');
                
                if (response.ok) {
                    let result = 'âœ… Check Available Ops OK\n\n';
                    result += `Provider: ${response.provider.name} (${response.provider.slug})\n\n`;
                    result += `Critical Operations Status:\n`;
                    result += `â€¢ vs.store.get: ${response.critical_ops_status['vs.store.get']}\n`;
                    result += `â€¢ vs.files: ${response.critical_ops_status['vs.files']}\n`;
                    result += `â€¢ vs.summarize_from_vs: ${response.critical_ops_status['vs.summarize_from_vs']}\n\n`;
                    result += `Available Operations (${response.operations.total_count}):\n`;
                    result += response.operations.available.join(', ');
                    
                    showResult('ğŸ“‹ Check Available Ops', result, 'success');
                } else {
                    let errorMsg = `Error: ${response.error || 'unknown'}`;
                    if (response.detail) errorMsg += `\nDetail: ${response.detail}`;
                    showResult('âŒ Check Available Ops Error', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Check Available Ops Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para debug vs.store.get
        async function debugVsStore() {
            showResult('ğŸ” Debug vs.store.get', 'Analizando configuraciÃ³n vs.store.get...', 'info');
            
            try {
                const response = await makeRequest('debug_vs_store_get_safe.php', 'GET');
                
                if (response.ok) {
                    let result = 'âœ… Debug vs.store.get OK\n\n';
                    result += `Provider: ${response.provider.name} (${response.provider.slug})\n`;
                    result += `vs.store.get exists: ${response.vs_store_get_exists}\n\n`;
                    
                    if (response.vs_store_get_config) {
                        result += `vs.store.get Config:\n`;
                        result += `â€¢ Method: ${response.vs_store_get_config.method}\n`;
                        result += `â€¢ URL: ${response.vs_store_get_config.url_override}\n`;
                        result += `â€¢ Headers:\n`;
                        if (response.vs_store_get_config.headers) {
                            response.vs_store_get_config.headers.forEach(header => {
                                result += `  - ${header.name}: ${header.value}\n`;
                            });
                        }
                        result += `\nAvailable operations: ${response.available_operations.join(', ')}`;
                    } else {
                        result += `âŒ vs.store.get config not found!`;
                    }
                    
                    showResult('ğŸ” Debug vs.store.get', result, 'success');
                } else {
                    let errorMsg = `Error: ${response.error || 'unknown'}`;
                    if (response.message) errorMsg += `\nMessage: ${response.message}`;
                    if (response.detail) errorMsg += `\nDetail: ${response.detail}`;
                    if (response.debug) errorMsg += `\nDebug: ${JSON.stringify(response.debug, null, 2)}`;
                    showResult('âŒ Debug vs.store.get Error', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Debug vs.store.get Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para debug API key
        async function debugApiKey() {
            showResult('ğŸ› Debug API Key', 'Analizando API key...', 'info');
            
            try {
                const response = await makeRequest('debug_api_key_simple_safe.php', 'GET');
                
                if (response.ok) {
                    let result = 'âœ… Debug API Key OK\n\n';
                    if (response.debug) {
                        result += `Debug Info:\n`;
                        result += `â€¢ User ID: ${response.debug.user_id}\n`;
                        result += `â€¢ Provider ID: ${response.debug.provider_id}\n`;
                        result += `â€¢ Last 4: ${response.debug.last4}\n`;
                        result += `â€¢ Length: ${response.debug.api_key_length}\n`;
                        result += `â€¢ Prefix: ${response.debug.api_key_prefix}\n`;
                        result += `â€¢ Suffix: ${response.debug.api_key_suffix}\n`;
                        result += `â€¢ Valid Format: ${response.debug.is_valid_format}\n`;
                        result += `â€¢ Starts with sk-: ${response.debug.starts_with_sk}`;
                    }
                    
                    showResult('ğŸ› Debug API Key', result, 'success');
                } else {
                    let errorMsg = `Error: ${response.error || 'unknown'}`;
                    if (response.message) errorMsg += `\nMessage: ${response.message}`;
                    if (response.detail) errorMsg += `\nDetail: ${response.detail}`;
                    if (response.debug) errorMsg += `\nDebug: ${JSON.stringify(response.debug, null, 2)}`;
                    showResult('âŒ Debug API Key Error', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Debug API Key Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para test API key
        async function testApiKey() {
            showResult('ğŸ”‘ Test API Key', 'Probando API key...', 'info');
            
            try {
                const response = await makeRequest('test_api_key_safe.php', 'GET');
                
                if (response.ok) {
                    let result = 'âœ… Test API Key OK\n\n';
                    if (response.api_key_info) {
                        result += `API Key Info:\n`;
                        result += `â€¢ Last 4: ${response.api_key_info.last4}\n`;
                        result += `â€¢ Length: ${response.api_key_info.length}\n`;
                        result += `â€¢ Prefix: ${response.api_key_info.prefix}\n`;
                        result += `â€¢ Suffix: ${response.api_key_info.suffix}\n\n`;
                    }
                    if (response.test_result) {
                        result += `Test Result:\n`;
                        result += `â€¢ HTTP Code: ${response.test_result.http_code}\n`;
                        result += `â€¢ Curl Error: ${response.test_result.curl_error || 'None'}\n`;
                        result += `â€¢ Response: ${response.test_result.response_preview}`;
                    }
                    
                    showResult('ğŸ”‘ Test API Key', result, 'success');
                } else {
                    let errorMsg = `Error: ${response.error || 'unknown'}`;
                    if (response.message) errorMsg += `\nMessage: ${response.message}`;
                    if (response.detail) errorMsg += `\nDetail: ${response.detail}`;
                    showResult('âŒ Test API Key Error', errorMsg, 'error');
                }
            } catch (error) {
                showResult('âŒ Test API Key Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para fix operaciÃ³n vs.get
        async function fixVsGetOperation() {
            showResult('ğŸ”§ Fix vs.get', 'AÃ±adiendo operaciÃ³n vs.get para Vector Stores...', 'info');
            
            try {
                const response = await makeRequest('fix_vs_get_operation_safe.php', 'GET');
                
                if (response.ok) {
                    showResult('âœ… Fix vs.get', `OperaciÃ³n aÃ±adida correctamente:\n\n${JSON.stringify(response.added_operation, null, 2)}\n\nNota: ${response.note}`, 'success');
                } else {
                    showResult('âŒ Fix vs.get Error', `Error: ${response.error || 'unknown'}`, 'error');
                }
            } catch (error) {
                showResult('âŒ Fix vs.get Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para restaurar operaciÃ³n vs.get
        async function restoreVsGetOperation() {
            showResult('ğŸ”§ Restaurar vs.get', 'Restaurando operaciÃ³n vs.get para Vector Stores...', 'info');
            
            try {
                const response = await makeRequest('restore_vs_get_operation_safe.php', 'GET');
                
                if (response.ok) {
                    showResult('âœ… Restaurar vs.get', `OperaciÃ³n restaurada correctamente:\n\n${JSON.stringify(response.added_operation, null, 2)}\n\nNota: ${response.note}`, 'success');
                } else {
                    showResult('âŒ Restaurar vs.get Error', `Error: ${response.error || 'unknown'}`, 'error');
                }
            } catch (error) {
                showResult('âŒ Restaurar vs.get Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para aÃ±adir operaciÃ³n vs.get
        async function addVsGetOperation() {
            showResult('â• AÃ±adir vs.get', 'AÃ±adiendo operaciÃ³n vs.get...', 'info');
            
            try {
                const response = await makeRequest('add_vs_get_operation_safe.php', 'GET');
                
                if (response.ok) {
                    showResult('âœ… AÃ±adir vs.get', `OperaciÃ³n aÃ±adida correctamente:\n\n${JSON.stringify(response.added_operation, null, 2)}`, 'success');
                } else {
                    showResult('âŒ AÃ±adir vs.get Error', `Error: ${response.error || 'unknown'}`, 'error');
                }
            } catch (error) {
                showResult('âŒ AÃ±adir vs.get Error', `Error: ${error.message}`, 'error');
            }
        }

        // FunciÃ³n para debug de ops_json
        async function debugOpsJson() {
            showResult('ğŸ”§ Debug ops_json', 'Iniciando...', 'info');
            
            try {
                const response = await makeRequest('debug_ops_json_safe.php', 'GET');
                
                if (response.ok) {
                    let result = 'âœ… Debug ops_json OK\n\n';
                    result += `Proveedor: ${response.provider.name} (${response.provider.slug})\n\n`;
                    
                    if (response.vs_get_config) {
                        result += 'ğŸ“‹ vs.get config:\n';
                        result += JSON.stringify(response.vs_get_config, null, 2) + '\n\n';
                    }
                    
                    if (response.vs_files_config) {
                        result += 'ğŸ“‹ vs.files config:\n';
                        result += JSON.stringify(response.vs_files_config, null, 2) + '\n\n';
                    }
                    
                    result += 'ğŸ“‹ ops_json completo:\n';
                    result += JSON.stringify(response.ops_json, null, 2);
                    
                    showResult('ğŸ”§ Debug ops_json', result, 'success');
                } else {
                    showResult('âŒ Debug ops_json Error', `Error: ${response.error || 'unknown'}`, 'error');
                }
            } catch (error) {
                showResult('âŒ Debug ops_json Error', `Error: ${error.message}`, 'error');
            }
        }

        // InicializaciÃ³n
        document.addEventListener('DOMContentLoaded', function() {
            showResult('ğŸ”¬ AI Diagnostic Tool', 'Herramienta de diagnÃ³stico iniciada. Configura tu JWT token para comenzar.', 'info');
            
            // Event listeners para API keys
            document.getElementById('test-auth').addEventListener('click', testAuth);
            document.getElementById('load-api-providers').addEventListener('click', loadApiProviders);
            document.getElementById('debug-load-providers').addEventListener('click', debugLoadProviders);
            document.getElementById('setup-openai').addEventListener('click', setupOpenAI);
            document.getElementById('setup-data-providers').addEventListener('click', setupDataProviders);
            document.getElementById('setup-news-providers').addEventListener('click', setupNewsProviders);
            document.getElementById('setup-trade-providers').addEventListener('click', setupTradeProviders);
            document.getElementById('debug-full-test').addEventListener('click', debugFullTest);
            document.getElementById('clear-api-logs').addEventListener('click', clearApiLogs);
            
            // Event listeners para funcionalidad de archivos
            if (document.getElementById('upload-file-btn')) {
                document.getElementById('upload-file-btn').addEventListener('click', uploadFileToAI);
            }
            if (document.getElementById('list-files-btn')) {
                document.getElementById('list-files-btn').addEventListener('click', listUploadedFiles);
            }
            if (document.getElementById('test-runop-btn')) {
                document.getElementById('test-runop-btn').addEventListener('click', testRunOpFunction);
            }
            if (document.getElementById('list-ai-resources-btn')) {
                document.getElementById('list-ai-resources-btn').addEventListener('click', listAIResources);
            }
            if (document.getElementById('upload-to-ai-btn')) {
                document.getElementById('upload-to-ai-btn').addEventListener('click', uploadFileToAIOnly);
            }
            if (document.getElementById('test-extract-btn')) {
                document.getElementById('test-extract-btn').addEventListener('click', testAIExtraction);
            }
            if (document.getElementById('test-provider-debug-btn')) {
                document.getElementById('test-provider-debug-btn').addEventListener('click', testProviderDebug);
            }
            if (document.getElementById('test-runop-direct-btn')) {
                document.getElementById('test-runop-direct-btn').addEventListener('click', testRunOpDirect);
            }
            if (document.getElementById('debug-ops-json-btn')) {
                document.getElementById('debug-ops-json-btn').addEventListener('click', debugOpsJson);
            }
            if (document.getElementById('add-vs-get-btn')) {
                document.getElementById('add-vs-get-btn').addEventListener('click', addVsGetOperation);
            }
            if (document.getElementById('restore-vs-get-btn')) {
                document.getElementById('restore-vs-get-btn').addEventListener('click', restoreVsGetOperation);
            }
            if (document.getElementById('fix-vs-get-btn')) {
                document.getElementById('fix-vs-get-btn').addEventListener('click', fixVsGetOperation);
            }
            if (document.getElementById('test-api-key-btn')) {
                document.getElementById('test-api-key-btn').addEventListener('click', testApiKey);
            }
            if (document.getElementById('debug-api-key-btn')) {
                document.getElementById('debug-api-key-btn').addEventListener('click', debugApiKey);
            }
            if (document.getElementById('debug-vs-store-btn')) {
                document.getElementById('debug-vs-store-btn').addEventListener('click', debugVsStore);
            }
            if (document.getElementById('check-ops-btn')) {
                document.getElementById('check-ops-btn').addEventListener('click', checkAvailableOps);
            }
            if (document.getElementById('test-var-replacement-btn')) {
                document.getElementById('test-var-replacement-btn').addEventListener('click', testVariableReplacement);
            }
            if (document.getElementById('debug-header-replacement-btn')) {
                document.getElementById('debug-header-replacement-btn').addEventListener('click', debugHeaderReplacement);
            }
        });
    </script>
</body>
</html>
