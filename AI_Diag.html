<!DOCTYPE html>
<html lang="es-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üî¨ AI Diagnostic Tool - CATAI</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 15px; 
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .header { 
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .header p { opacity: 0.9; font-size: 1.1em; }
        .content { padding: 30px; }
        .section { 
            margin-bottom: 30px; 
            padding: 25px; 
            border: 2px solid #e0e0e0; 
            border-radius: 10px; 
            background: #fafafa;
        }
        .section h2 { 
            color: #2c3e50; 
            margin-bottom: 20px; 
            font-size: 1.5em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        .form-group { margin-bottom: 20px; }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #2c3e50; 
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #ddd; 
            border-radius: 8px; 
            font-size: 14px;
            transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { 
            outline: none; 
            border-color: #3498db; 
        }
        .btn { 
            background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); 
            color: white; 
            border: none; 
            padding: 12px 25px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4); 
        }
        .btn-success { background: linear-gradient(135deg, #27ae60 0%, #229954 100%); }
        .btn-warning { background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%); }
        .btn-primary { background: linear-gradient(135deg, #3498db 0%, #2980b9 100%); }
        .btn-secondary { background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); }
        .btn-dark { background: linear-gradient(135deg, #343a40 0%, #23272b 100%); }
        .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); }
        .btn-info { background: linear-gradient(135deg, #17a2b8 0%, #138496 100%); }
        .result { 
            margin-top: 20px; 
            padding: 20px; 
            border-radius: 8px; 
            font-family: 'Courier New', monospace; 
            font-size: 13px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success { background: #d4edda; border: 1px solid #c3e6cb; color: #155724; }
        .result.error { background: #f8d7da; border: 1px solid #f5c6cb; color: #721c24; }
        .result.info { background: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; }
        .result.warning { background: #fff3cd; border: 1px solid #ffeaa7; color: #856404; }
        .status { 
            display: inline-block; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            font-weight: 600;
            margin-left: 10px;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 20px; 
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
            .header h1 { font-size: 2em; }
            .content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üî¨ AI Diagnostic Tool</h1>
            <p>Diagn√≥stico profesional de extracci√≥n de contenido con IA</p>
        </div>
        
        <div class="content">
            <!-- SECCI√ìN 1: CONFIGURACI√ìN B√ÅSICA -->
            <div class="section">
                <h2>üîß 1. Configuraci√≥n B√°sica</h2>
                <div class="grid">
                    <div>
                        <div class="form-group">
                            <label>JWT Token:</label>
                            <input type="text" id="jwtToken" placeholder="Pega tu JWT token aqu√≠">
                        </div>
                        <div class="form-group">
                            <label>File ID (knowledge_files.id):</label>
                            <input type="number" id="fileId" placeholder="Ej: 20" value="20">
                        </div>
                    </div>
                    <div>
                        <div class="form-group">
                            <label>API Base URL:</label>
                            <input type="text" id="apiBase" value="https://cerberogrowthsolutions.com/catai/api" readonly>
                        </div>
                        <div class="form-group">
                            <label>Usuario ID:</label>
                            <input type="text" id="userId" placeholder="Se detectar√° autom√°ticamente" readonly>
                        </div>
                    </div>
                </div>
                <button class="btn btn-info" onclick="validateConfig()">‚úÖ Validar Configuraci√≥n</button>
                <button class="btn btn-warning" onclick="clearResults()">üóëÔ∏è Limpiar Resultados</button>
            </div>

            <!-- SECCI√ìN 2: DIAGN√ìSTICO PASO A PASO -->
            <div class="section">
                <h2>üîç 2. Diagn√≥stico Paso a Paso</h2>
                <div class="grid">
                    <div>
                        <button class="btn" onclick="testBasicConnectivity()">üåê Test Conectividad B√°sica</button>
                        <button class="btn" onclick="testAuthentication()">üîê Test Autenticaci√≥n</button>
                        <button class="btn" onclick="testUserSettings()">‚öôÔ∏è Test Configuraci√≥n Usuario</button>
                        <button class="btn" onclick="testFileAccess()">üìÅ Test Acceso Archivo</button>
                    </div>
                    <div>
                        <button class="btn" onclick="testApiKey()">üîë Test API Key</button>
                        <button class="btn" onclick="testAiProvider()">ü§ñ Test Proveedor IA</button>
                        <button class="btn" onclick="testFileContent()">üìÑ Test Contenido Archivo</button>
                        <button class="btn" onclick="runFullDiagnostic()">üöÄ Diagn√≥stico Completo</button>
                    </div>
                </div>
            </div>

            <!-- SECCI√ìN 3: EXTRACCI√ìN DE IA -->
            <div class="section">
                <h2>ü§ñ 3. Extracci√≥n de IA</h2>
                <div class="form-group">
                    <label>Proveedor de IA:</label>
                    <select id="aiProvider">
                        <option value="auto">Auto (usar configuraci√≥n del usuario)</option>
                        <option value="gemini">Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Modelo:</label>
                    <input type="text" id="aiModel" placeholder="Se detectar√° autom√°ticamente" readonly>
                </div>
                <button class="btn btn-success" onclick="extractWithAI()">üöÄ Extraer Contenido con IA</button>
                <button class="btn btn-primary" onclick="simulateRealButton()">üéØ Simulaci√≥n Bot√≥n Real</button>
                <button class="btn btn-info" onclick="testDataStructures()">üîç Test Estructuras</button>
                <button class="btn btn-secondary" onclick="testFileInfo()">üìÅ Test Info Archivo</button>
                <button class="btn btn-dark" onclick="checkUserPrompt()">üìù Verificar Prompt</button>
                <button class="btn btn-warning" onclick="testAiConnection()">üîó Test Conexi√≥n IA</button>
            </div>

            <!-- SECCI√ìN 4: RESULTADOS -->
            <div class="section">
                <h2>üìä 4. Resultados del Diagn√≥stico</h2>
                <div id="results"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuraci√≥n global
        let currentConfig = {
            jwtToken: '',
            fileId: 20,
            apiBase: 'https://cerberogrowthsolutions.com/catai/api',
            userId: null,
            aiProvider: 'auto',
            aiModel: null
        };

        // Funci√≥n para mostrar resultados
        function showResult(title, content, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `<strong>${title}</strong>\n${content}`;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        // Funci√≥n para limpiar resultados
        function clearResults() {
            document.getElementById('results').innerHTML = '';
        }

        // Funci√≥n para validar configuraci√≥n
        function validateConfig() {
            const jwtToken = document.getElementById('jwtToken').value.trim();
            const fileId = document.getElementById('fileId').value;
            
            if (!jwtToken) {
                showResult('‚ùå Error de Configuraci√≥n', 'JWT Token es requerido', 'error');
                return false;
            }
            
            if (!fileId) {
                showResult('‚ùå Error de Configuraci√≥n', 'File ID es requerido', 'error');
                return false;
            }
            
            // Decodificar JWT para obtener user ID
            try {
                const payload = JSON.parse(atob(jwtToken.split('.')[1]));
                currentConfig.jwtToken = jwtToken;
                currentConfig.fileId = parseInt(fileId);
                currentConfig.userId = payload.id;
                
                document.getElementById('userId').value = currentConfig.userId;
                
                showResult('‚úÖ Configuraci√≥n V√°lida', 
                    `Usuario ID: ${currentConfig.userId}\nFile ID: ${currentConfig.fileId}\nToken v√°lido hasta: ${new Date(payload.exp * 1000).toLocaleString()}`, 
                    'success');
                return true;
            } catch (e) {
                showResult('‚ùå Error de Configuraci√≥n', 'JWT Token inv√°lido: ' + e.message, 'error');
                return false;
            }
        }

        // Funci√≥n para hacer requests HTTP
        async function makeRequest(endpoint, method = 'GET', body = null) {
            // Obtener token directamente del input para evitar p√©rdida
            const jwtToken = document.getElementById('jwtToken').value.trim();
            
            if (!jwtToken) {
                return {
                    ok: false,
                    status: 401,
                    data: { error: 'JWT Token no configurado' },
                    raw: 'JWT Token no configurado'
                };
            }
            
            const url = `${currentConfig.apiBase}/${endpoint}`;
            const options = {
                method: method,
                headers: {
                    'Authorization': `Bearer ${jwtToken}`,
                    'Content-Type': 'application/json'
                }
            };
            
            if (body) {
                options.body = JSON.stringify(body);
            }
            
            try {
                const response = await fetch(url, options);
                const text = await response.text();
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch (e) {
                    data = { error: 'Respuesta no es JSON v√°lido', raw: text };
                }
                
                return {
                    ok: response.ok,
                    status: response.status,
                    data: data,
                    raw: text
                };
            } catch (error) {
                return {
                    ok: false,
                    status: 0,
                    data: { error: error.message },
                    raw: error.message
                };
            }
        }

        // Test de conectividad b√°sica
        async function testBasicConnectivity() {
            showResult('üåê Test Conectividad B√°sica', 'Iniciando...', 'info');
            
            const result = await makeRequest('health.php');
            
            if (result.ok) {
                showResult('‚úÖ Conectividad B√°sica', 
                    `Status: ${result.status}\nRespuesta: ${JSON.stringify(result.data, null, 2)}`, 
                    'success');
            } else {
                showResult('‚ùå Error de Conectividad', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de autenticaci√≥n
        async function testAuthentication() {
            showResult('üîê Test Autenticaci√≥n', 'Iniciando...', 'info');
            
            const result = await makeRequest('auth_me_safe.php');
            
            if (result.ok) {
                showResult('‚úÖ Autenticaci√≥n Exitosa', 
                    `Usuario: ${result.data.email}\nID: ${result.data.id}\nRol: ${result.data.role}`, 
                    'success');
            } else {
                showResult('‚ùå Error de Autenticaci√≥n', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de configuraci√≥n del usuario
        async function testUserSettings() {
            showResult('‚öôÔ∏è Test Configuraci√≥n Usuario', 'Iniciando...', 'info');
            
            const result = await makeRequest('settings_get_safe.php');
            
            if (result.ok) {
                const settings = result.data.settings;
                currentConfig.aiProvider = settings.ai_provider || 'auto';
                currentConfig.aiModel = settings.ai_model || 'gpt-4o';
                
                document.getElementById('aiProvider').value = currentConfig.aiProvider;
                document.getElementById('aiModel').value = currentConfig.aiModel;
                
                showResult('‚úÖ Configuraci√≥n Usuario', 
                    `IA Provider: ${currentConfig.aiProvider}\nModelo: ${currentConfig.aiModel}\nData Provider: ${settings.data_provider || 'N/A'}`, 
                    'success');
            } else {
                showResult('‚ùå Error Configuraci√≥n Usuario', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de acceso al archivo
        async function testFileAccess() {
            showResult('üìÅ Test Acceso Archivo', 'Iniciando...', 'info');
            
            const result = await makeRequest('test_file_access_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                const pathInfo = data.file_physical.path_components;
                const pathConstruction = data.file_physical.path_construction;
                showResult('‚úÖ Acceso Archivo', 
                    `File ID: ${data.file.id}\nArchivo: ${data.file.original_filename}\nTipo (DB): ${data.file.file_type}\nMIME (DB): ${data.file.mime_type}\nTama√±o: ${data.file.file_size_mb} MB\n\nCONSTRUCCI√ìN DEL PATH (PASO A PASO):\n1. ${pathConstruction.step_1}\n2. ${pathConstruction.step_2}\n3. ${pathConstruction.step_3}\n4. ${pathConstruction.step_4}\n\nPATH FINAL:\n${pathConstruction.final_path}\n\nCOMPONENTES DEL PATH:\n- Base: ${pathInfo.base_dir}\n- Uploads: ${pathInfo.uploads_dir}\n- Usuario: ${pathInfo.user_dir}\n- Archivo: ${pathInfo.filename}\n\nExiste f√≠sicamente: ${data.file_physical.exists ? '‚úÖ S√≠' : '‚ùå No'}\nListo para extracci√≥n: ${data.ready_for_extraction.can_proceed ? '‚úÖ S√≠' : '‚ùå No'}`, 
                    'success');
            } else {
                showResult('‚ùå Error Acceso Archivo', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de API Key
        async function testApiKey() {
            showResult('üîë Test API Key', 'Iniciando...', 'info');
            
            const result = await makeRequest('user_keys_get_safe.php');
            
            if (result.ok) {
                const keys = result.data.keys;
                let keyStatus = '';
                for (const [provider, info] of Object.entries(keys)) {
                    keyStatus += `${provider}: ${info.has ? '‚úÖ Configurada' : '‚ùå No configurada'}\n`;
                }
                
                showResult('‚úÖ Estado API Keys', keyStatus, 'success');
            } else {
                showResult('‚ùå Error API Keys', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de proveedor de IA
        async function testAiProvider() {
            showResult('ü§ñ Test Proveedor IA', 'Iniciando...', 'info');
            
            const result = await makeRequest('test_file_access_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                showResult('‚úÖ Proveedor IA', 
                    `Provider: ${data.user_settings.ai_provider}\nModelo: ${data.user_settings.ai_model}\nAPI Key disponible: ${data.api_keys[data.user_settings.ai_provider]?.has_key ? '‚úÖ S√≠' : '‚ùå No'}`, 
                    'success');
            } else {
                showResult('‚ùå Error Proveedor IA', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de contenido del archivo
        async function testFileContent() {
            showResult('üìÑ Test Contenido Archivo', 'Iniciando...', 'info');
            
            const result = await makeRequest('test_file_access_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                showResult('‚úÖ Contenido Archivo', 
                    `File ID: ${data.file.id}\nArchivo: ${data.file.original_filename}\nTama√±o: ${data.file_physical.size_mb} MB\nContenido (primeros 200 chars): ${data.file_physical.content_preview.substring(0, 200)}...`, 
                    'success');
            } else {
                showResult('‚ùå Error Contenido Archivo', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Test de conexi√≥n con IA
        async function testAiConnection() {
            showResult('üîó Test Conexi√≥n IA', 'Iniciando...', 'info');
            
            const result = await makeRequest('test_file_access_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                const provider = data.user_settings.ai_provider;
                const hasKey = data.api_keys[provider]?.has_key || false;
                
                showResult('‚úÖ Conexi√≥n IA', 
                    `Provider: ${provider}\nModelo: ${data.user_settings.ai_model}\nAPI Key: ${hasKey ? '‚úÖ Configurada' : '‚ùå No configurada'}\nListo para extracci√≥n: ${data.ready_for_extraction.can_proceed ? '‚úÖ S√≠' : '‚ùå No'}`, 
                    hasKey ? 'success' : 'warning');
            } else {
                showResult('‚ùå Error Conexi√≥n IA', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Diagn√≥stico completo
        async function runFullDiagnostic() {
            showResult('üöÄ Diagn√≥stico Completo', 'Iniciando diagn√≥stico completo...', 'info');
            
            const tests = [
                { name: 'Conectividad B√°sica', fn: testBasicConnectivity },
                { name: 'Autenticaci√≥n', fn: testAuthentication },
                { name: 'Configuraci√≥n Usuario', fn: testUserSettings },
                { name: 'Acceso Archivo', fn: testFileAccess },
                { name: 'API Keys', fn: testApiKey },
                { name: 'Proveedor IA', fn: testAiProvider },
                { name: 'Contenido Archivo', fn: testFileContent }
            ];
            
            for (const test of tests) {
                showResult(`üîÑ Ejecutando: ${test.name}`, '...', 'info');
                await test.fn();
                await new Promise(resolve => setTimeout(resolve, 1000)); // Pausa de 1 segundo
            }
            
            showResult('‚úÖ Diagn√≥stico Completo', 'Todos los tests han sido ejecutados', 'success');
        }

        // Extracci√≥n con IA
        async function extractWithAI() {
            showResult('ü§ñ Extracci√≥n con IA', 'Iniciando extracci√≥n...', 'info');
            
            // Primero hacer test simple
            showResult('üß™ Test Configuraci√≥n IA', 'Verificando configuraci√≥n...', 'info');
            const testResult = await makeRequest('test_ai_extract_simple_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (!testResult.ok) {
                showResult('‚ùå Error Test Configuraci√≥n', 
                    `Status: ${testResult.status}\nError: ${JSON.stringify(testResult.data, null, 2)}`, 
                    'error');
                return;
            }
            
            showResult('‚úÖ Test Configuraci√≥n IA', 
                `Usuario: ${testResult.data.user.email}\nProvider: ${testResult.data.settings.ai_provider}\nModelo: ${testResult.data.settings.ai_model}\nPrompt: ${testResult.data.prompt_used}\nCustom Prompt: ${testResult.data.settings.has_custom_prompt ? 'S√≠' : 'No'}`, 
                'success');
            
            // Ahora hacer extracci√≥n completa
            showResult('ü§ñ Extracci√≥n Completa', 'Ejecutando extracci√≥n completa...', 'info');
            const result = await makeRequest('ai_extract_final_safe.php', 'POST', {
                file_id: currentConfig.fileId
            });
            
            if (result.ok) {
                const data = result.data;
                showResult('‚úÖ Extracci√≥n Exitosa',
                    `Usuario: ${data.usuario.email}\nArchivo: ${data.archivo.nombre}\nTipo: ${data.archivo.tipo}\nIA: ${data.ia.provider} (${data.ia.modelo})\nLatencia: ${data.consulta.latencia_ms}ms\n\nOPENAI FILE ID: ${data.archivo.openai_file_id || 'N/A'}\nFILE ACTION: ${data.archivo.file_action || 'N/A'}\n\nPROMPT USADO: ${data.prompt_used ? 'Personalizado' : 'Predeterminado'}\n\nRESUMEN:\n${data.resultado.resumen}\n\nGUARDADO:\nKnowledge ID: ${data.guardado.knowledge_id}\nStatus: ${data.guardado.status}`,
                    'success');
            } else {
                showResult('‚ùå Error Extracci√≥n', 
                    `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                    'error');
            }
        }

        // Simulaci√≥n completa del bot√≥n real
        async function simulateRealButton() {
            showResult('üéØ Simulaci√≥n Bot√≥n Real', 'Iniciando simulaci√≥n completa del bot√≥n real...', 'info');
            
            if (!validateConfig()) return;
            
            const fileId = currentConfig.fileId;
            
            try {
                // PASO 1: Obtener configuraci√≥n completa del usuario
                showResult('üìã Paso 1: Configuraci√≥n Usuario', 'Obteniendo configuraci√≥n completa...', 'info');
                const configResult = await makeRequest('settings_get_safe.php');
                
                if (!configResult.ok) {
                    showResult('‚ùå Error Configuraci√≥n', 
                        `Status: ${configResult.status}\nError: ${JSON.stringify(configResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                const userConfig = configResult.data.settings;
                
                // Verificar estructura de configuraci√≥n
                if (!userConfig) {
                    showResult('‚ùå Error Configuraci√≥n', 
                        `No se pudo obtener configuraci√≥n del usuario:\n${JSON.stringify(configResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                showResult('‚úÖ Configuraci√≥n Obtenida', 
                    `IA Provider: ${userConfig.ai_provider}\nModelo: ${userConfig.ai_model}\nData Provider: ${userConfig.data_provider}\nPrompt Personalizado: ${userConfig.ai_prompt_ext_conten_file ? 'S√≠' : 'No'}`, 
                    'success');
                
                // PASO 2: Obtener informaci√≥n del archivo
                showResult('üìÅ Paso 2: Informaci√≥n Archivo', 'Obteniendo informaci√≥n del archivo...', 'info');
                const fileResult = await makeRequest('test_file_info_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (!fileResult.ok) {
                    showResult('‚ùå Error Archivo', 
                        `Status: ${fileResult.status}\nError: ${JSON.stringify(fileResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                const fileInfo = fileResult.data;
                
                // Verificar estructura de datos
                if (!fileInfo.file_db || !fileInfo.file_physical) {
                    showResult('‚ùå Error Estructura', 
                        `Estructura de respuesta inesperada:\n${JSON.stringify(fileInfo, null, 2)}`, 
                        'error');
                    return;
                }
                
                showResult('‚úÖ Archivo Verificado', 
                    `Archivo: ${fileInfo.file_db.original_filename}\nTipo: ${fileInfo.file_db.file_type}\nTama√±o: ${fileInfo.file_db.file_size_mb} MB\nExiste: ${fileInfo.file_physical.exists ? 'S√≠' : 'No'}`, 
                    'success');
                
                // PASO 3: Verificar API Keys
                showResult('üîë Paso 3: API Keys', 'Verificando API keys del usuario...', 'info');
                const keysResult = await makeRequest('user_keys_get_safe.php');
                
                if (!keysResult.ok) {
                    showResult('‚ùå Error API Keys', 
                        `Status: ${keysResult.status}\nError: ${JSON.stringify(keysResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                const keys = keysResult.data.keys;
                
                // Verificar estructura de API keys
                if (!keys) {
                    showResult('‚ùå Error API Keys', 
                        `No se pudo obtener informaci√≥n de API keys:\n${JSON.stringify(keysResult.data, null, 2)}`, 
                        'error');
                    return;
                }
                
                const provider = userConfig.ai_provider;
                const hasKey = keys[provider]?.has || false;
                
                showResult('‚úÖ API Keys Verificadas', 
                    `Provider: ${provider}\nAPI Key: ${hasKey ? '‚úÖ Configurada' : '‚ùå No configurada'}\nKeys disponibles: ${Object.keys(keys).filter(k => keys[k].has).join(', ')}`, 
                    hasKey ? 'success' : 'warning');
                
                if (!hasKey) {
                    showResult('‚ö†Ô∏è Advertencia', 'No hay API key configurada para el provider seleccionado. La extracci√≥n puede fallar.', 'warning');
                }
                
                // PASO 4: Ejecutar extracci√≥n completa
                showResult('üöÄ Paso 4: Extracci√≥n Completa', 'Ejecutando extracci√≥n completa con IA...', 'info');
                const extractResult = await makeRequest('ai_extract_final_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (extractResult.ok) {
                    const data = extractResult.data;
                    showResult('üéâ SIMULACI√ìN EXITOSA', 
                        `üéØ SIMULACI√ìN COMPLETA DEL BOT√ìN REAL\n\n` +
                        `üë§ USUARIO:\n` +
                        `‚Ä¢ Email: ${data.usuario.email}\n` +
                        `‚Ä¢ ID: ${data.usuario.id}\n\n` +
                        `üìÑ ARCHIVO:\n` +
                        `‚Ä¢ Nombre: ${data.archivo.nombre}\n` +
                        `‚Ä¢ Tipo: ${data.archivo.tipo}\n` +
                        `‚Ä¢ Tama√±o: ${data.archivo.tama√±o}\n\n` +
                        `ü§ñ IA UTILIZADA:\n` +
                        `‚Ä¢ Provider: ${data.ia.provider}\n` +
                        `‚Ä¢ Modelo: ${data.ia.modelo}\n` +
                        `‚Ä¢ Prompt: ${data.prompt_used ? 'Personalizado' : 'Predeterminado'}\n\n` +
                        `‚è±Ô∏è RENDIMIENTO:\n` +
                        `‚Ä¢ Latencia: ${data.consulta.latencia_ms}ms\n` +
                        `‚Ä¢ Caracteres procesados: ${data.consulta.caracteres_procesados}\n` +
                        `‚Ä¢ HTTP Code: ${data.consulta.http_code}\n\n` +
                        `üìä RESULTADO:\n` +
                        `${data.resultado.resumen}\n\n` +
                        `üíæ GUARDADO:\n` +
                        `‚Ä¢ Knowledge ID: ${data.guardado.knowledge_id}\n` +
                        `‚Ä¢ Status: ${data.guardado.status}\n\n` +
                        `‚úÖ ESTA ES EXACTAMENTE LA FUNCIONALIDAD DEL BOT√ìN REAL`, 
                        'success');
                } else {
                    showResult('‚ùå Error Extracci√≥n', 
                        `Status: ${extractResult.status}\nError: ${JSON.stringify(extractResult.data, null, 2)}\n\n` +
                        `üîç DIAGN√ìSTICO:\n` +
                        `‚Ä¢ Configuraci√≥n: ‚úÖ OK\n` +
                        `‚Ä¢ Archivo: ‚úÖ OK\n` +
                        `‚Ä¢ API Keys: ${hasKey ? '‚úÖ OK' : '‚ùå FALTA'}\n` +
                        `‚Ä¢ Extracci√≥n: ‚ùå FALLO\n\n` +
                        `üí° SOLUCI√ìN: ${hasKey ? 'Revisar configuraci√≥n de IA o cambiar provider' : 'Configurar API key para ' + provider}`, 
                        'error');
                }
                
            } catch (error) {
                showResult('‚ùå Error Simulaci√≥n', 
                    `Error inesperado: ${error.message}\n\n` +
                    `üîç Esto indica un problema en el flujo de simulaci√≥n.`, 
                    'error');
            }
        }

        // Test de estructuras de datos
        async function testDataStructures() {
            showResult('üîç Test Estructuras', 'Verificando estructuras de datos...', 'info');
            
            if (!validateConfig()) return;
            
            const fileId = currentConfig.fileId;
            
            try {
                const result = await makeRequest('test_data_structures_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (result.ok) {
                    const data = result.data;
                    showResult('‚úÖ Estructuras Verificadas', 
                        `üîç TEST DE ESTRUCTURAS DE DATOS\n\n` +
                        `üë§ USUARIO:\n` +
                        `‚Ä¢ ID: ${data.user.id}\n` +
                        `‚Ä¢ Email: ${data.user.email}\n\n` +
                        `üìã CONFIGURACI√ìN:\n` +
                        `‚Ä¢ Estructura: ${data.structures.settings.structure}\n` +
                        `‚Ä¢ AI Provider: ${data.structures.settings.data.ai_provider || 'No configurado'}\n` +
                        `‚Ä¢ AI Model: ${data.structures.settings.data.ai_model || 'No configurado'}\n` +
                        `‚Ä¢ Prompt Personalizado: ${data.structures.settings.has_custom_prompt ? 'S√≠' : 'No'}\n\n` +
                        `üìÅ ARCHIVO:\n` +
                        `‚Ä¢ Estructura: ${data.structures.file_db.structure}\n` +
                        `‚Ä¢ Nombre: ${data.structures.file_db.data.original_filename}\n` +
                        `‚Ä¢ Tipo: ${data.structures.file_db.data.file_type}\n` +
                        `‚Ä¢ Tama√±o: ${data.structures.file_db.data.file_size} bytes\n\n` +
                        `üîë API KEYS:\n` +
                        `‚Ä¢ Estructura: ${data.structures.api_keys.structure}\n` +
                        `‚Ä¢ Providers con keys: ${data.structures.api_keys.providers_with_keys.join(', ') || 'Ninguno'}\n\n` +
                        `‚úÖ Todas las estructuras est√°n correctas y listas para la simulaci√≥n`, 
                        'success');
                } else {
                    showResult('‚ùå Error Estructuras', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
                
            } catch (error) {
                showResult('‚ùå Error Test', 
                    `Error inesperado: ${error.message}`, 
                    'error');
            }
        }

        // Test de informaci√≥n de archivo
        async function testFileInfo() {
            showResult('üìÅ Test Info Archivo', 'Verificando informaci√≥n del archivo...', 'info');
            
            if (!validateConfig()) return;
            
            const fileId = currentConfig.fileId;
            
            try {
                const result = await makeRequest('test_file_info_safe.php', 'POST', {
                    file_id: fileId
                });
                
                if (result.ok) {
                    const data = result.data;
                    showResult('‚úÖ Info Archivo Verificada', 
                        `üìÅ TEST DE INFORMACI√ìN DE ARCHIVO\n\n` +
                        `üë§ USUARIO:\n` +
                        `‚Ä¢ ID: ${data.user.id}\n` +
                        `‚Ä¢ Email: ${data.user.email}\n\n` +
                        `üìÑ ARCHIVO (DB):\n` +
                        `‚Ä¢ ID: ${data.file_db.id}\n` +
                        `‚Ä¢ Nombre: ${data.file_db.original_filename}\n` +
                        `‚Ä¢ Archivo almacenado: ${data.file_db.stored_filename}\n` +
                        `‚Ä¢ Tipo: ${data.file_db.file_type}\n` +
                        `‚Ä¢ Tama√±o: ${data.file_db.file_size_mb} MB\n\n` +
                        `üíæ ARCHIVO F√çSICO:\n` +
                        `‚Ä¢ Ruta: ${data.file_physical.path}\n` +
                        `‚Ä¢ Existe: ${data.file_physical.exists ? '‚úÖ S√≠' : '‚ùå No'}\n` +
                        `‚Ä¢ Tama√±o: ${data.file_physical.size_mb} MB\n\n` +
                        `‚úÖ Estructura correcta para simulaci√≥n`, 
                        'success');
                } else {
                    showResult('‚ùå Error Info Archivo', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
                
            } catch (error) {
                showResult('‚ùå Error Test', 
                    `Error inesperado: ${error.message}`, 
                    'error');
            }
        }

        // Verificar prompt del usuario
        async function checkUserPrompt() {
            showResult('üìù Verificar Prompt', 'Verificando prompt personalizado del usuario...', 'info');
            
            try {
                const result = await makeRequest('check_user_prompt_safe.php', 'GET');
                
                if (result.ok) {
                    const data = result.data;
                    const analysis = data.prompt_analysis;
                    const prompts = data.prompts;
                    
                    let promptDisplay = '';
                    if (analysis.has_custom_prompt) {
                        promptDisplay = `üìù PROMPT PERSONALIZADO (${analysis.custom_prompt_length} caracteres):\n${prompts.custom}\n\n`;
                    } else {
                        promptDisplay = `üìù NO HAY PROMPT PERSONALIZADO\n\n`;
                    }
                    
                    promptDisplay += `üîß PROMPT PREDETERMINADO (${analysis.default_prompt_length} caracteres):\n${prompts.default}`;
                    
                    showResult('‚úÖ An√°lisis de Prompt Completado', 
                        `üìù VERIFICACI√ìN DE PROMPTS\n\n` +
                        `üë§ USUARIO:\n` +
                        `‚Ä¢ ID: ${data.user.id}\n` +
                        `‚Ä¢ Email: ${data.user.email}\n\n` +
                        `üìä AN√ÅLISIS:\n` +
                        `‚Ä¢ Tiene prompt personalizado: ${analysis.has_custom_prompt ? '‚úÖ S√≠' : '‚ùå No'}\n` +
                        `‚Ä¢ Fuente del prompt: ${analysis.prompt_source}\n` +
                        `‚Ä¢ Longitud personalizado: ${analysis.custom_prompt_length} caracteres\n` +
                        `‚Ä¢ Longitud predeterminado: ${analysis.default_prompt_length} caracteres\n\n` +
                        `üìù PROMPTS:\n\n${promptDisplay}`, 
                        'success');
                } else {
                    showResult('‚ùå Error Verificaci√≥n', 
                        `Status: ${result.status}\nError: ${JSON.stringify(result.data, null, 2)}`, 
                        'error');
                }
                
            } catch (error) {
                showResult('‚ùå Error Test', 
                    `Error inesperado: ${error.message}`, 
                    'error');
            }
        }

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            showResult('üî¨ AI Diagnostic Tool', 'Herramienta de diagn√≥stico iniciada. Configura tu JWT token y File ID para comenzar.', 'info');
        });
    </script>
</body>
</html>
