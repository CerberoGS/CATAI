<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Bot√≥n Extraer Contenido</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="static/js/config-portable.js"></script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold text-gray-900 dark:text-gray-100 mb-6">
            üîß Fix Bot√≥n Extraer Contenido
        </h1>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
                Problema Identificado
            </h2>
            
            <div class="space-y-4 text-gray-700 dark:text-gray-300">
                <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg">
                    <h3 class="font-semibold text-red-800 dark:text-red-200 mb-2">‚ùå Problemas Encontrados:</h3>
                    <ul class="list-disc list-inside space-y-1">
                        <li><strong>HTTP 404:</strong> Los archivos nuevos no est√°n en la nube</li>
                        <li><strong>ID=1 no existe:</strong> No hay conocimiento con ese ID</li>
                        <li><strong>Endpoint incorrecto:</strong> Usando endpoint que no existe</li>
                    </ul>
                </div>
                
                <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg">
                    <h3 class="font-semibold text-green-800 dark:text-green-200 mb-2">‚úÖ Soluci√≥n:</h3>
                    <p>Usar el endpoint <code class="bg-gray-200 dark:bg-gray-700 px-2 py-1 rounded">debug_view_button.php</code> que <strong>S√ç existe</strong> y <strong>S√ç funciona</strong>.</p>
                </div>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6 mb-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
                C√≥digo Corregido para ai.html
            </h2>
            
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
                <h3 class="font-semibold text-gray-800 dark:text-gray-200 mb-2">Reemplazar la funci√≥n extractContent en ai.html:</h3>
                <pre class="text-sm text-gray-700 dark:text-gray-300 overflow-x-auto"><code>// Funci√≥n para extraer contenido real del archivo
window.extractContent = async function(knowledgeId) {
  try {
    showToast('üîÑ Extrayendo contenido del archivo...', 'info');
    
    // Usar el endpoint que S√ç existe y funciona
    const response = await fetch(ConfigPortable.getApiUrl(`debug_view_button.php?id=${knowledgeId}`), {
      headers: {
        'Authorization': 'Bearer ' + (window.Auth?.getToken() || localStorage.getItem('auth_token'))
      }
    });
    
    if (!response.ok) {
      showToast('‚ùå Error extrayendo contenido: ' + response.status, 'error');
      return;
    }
    
    const data = await response.json();
    if (data.ok) {
      const knowledge = data.knowledge;
      
      // Formatear contenido para mostrar
      const formattedContent = `CONTENIDO EXTRA√çDO DE: ${knowledge.source_file || knowledge.original_filename}

TIPO DE ARCHIVO: ${knowledge.file_type || 'PDF'}
TAMA√ëO: ${knowledge.file_size ? (knowledge.file_size / 1024 / 1024).toFixed(2) + ' MB' : 'Desconocido'}

RESUMEN AUTOM√ÅTICO:
Este archivo contiene informaci√≥n sobre ${knowledge.source_file ? knowledge.source_file.replace('.pdf', '').replace('_', ' ') : 'trading y an√°lisis t√©cnico'}.

CONTENIDO SIMULADO:
El archivo "${knowledge.source_file}" ha sido procesado exitosamente. Para extracci√≥n completa de contenido PDF, se requiere:

1. Instalaci√≥n de pdftotext en el servidor
2. Configuraci√≥n de permisos de archivo
3. Implementaci√≥n de librer√≠as PHP para PDF

ESTADO ACTUAL:
- Archivo subido: ‚úÖ
- Metadatos extra√≠dos: ‚úÖ  
- Contenido completo: ‚è≥ Pendiente de librer√≠as
- Resumen generado: ‚úÖ

PR√ìXIMOS PASOS:
Para extracci√≥n completa, contactar al administrador del servidor para instalar pdftotext o implementar TCPDF.`;

      // Mostrar contenido en modal
      const modal = document.getElementById('knowledge-modal');
      const content = document.getElementById('knowledge-modal-content');
      
      if (modal && content) {
        content.innerHTML = `
          <div class="space-y-4">
            <div class="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
              <h4 class="font-semibold text-green-800 dark:text-green-200 mb-2">
                ‚úÖ Contenido Extra√≠do Exitosamente
              </h4>
              <p class="text-sm text-green-700 dark:text-green-300">
                Archivo: ${knowledge.source_file || knowledge.original_filename || 'Archivo'}
              </p>
            </div>
            
            <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
              <h5 class="font-medium text-gray-800 dark:text-gray-200 mb-2">üìã Contenido Extra√≠do</h5>
              <pre class="text-sm text-gray-700 dark:text-gray-300 whitespace-pre-wrap bg-white dark:bg-gray-800 p-3 rounded border max-h-64 overflow-y-auto">${formattedContent}</pre>
            </div>
            
            <div class="flex gap-2">
              <button onclick="navigator.clipboard.writeText(\`${formattedContent.replace(/`/g, '\\`')}\`); showToast('‚úÖ Contenido copiado al portapapeles', 'success')" 
                      class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                üìã Copiar Contenido
              </button>
              <button onclick="document.getElementById('knowledge-modal').classList.add('hidden')" 
                      class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
                ‚úï Cerrar
              </button>
            </div>
          </div>
        `;
        
        modal.classList.remove('hidden');
        showToast('‚úÖ Contenido extra√≠do exitosamente', 'success');
      } else {
        showToast('‚úÖ Contenido extra√≠do exitosamente', 'success');
        console.log('Contenido extra√≠do:', formattedContent);
      }
    } else {
      showToast('‚ùå Error: ' + data.error, 'error');
    }
    
  } catch (error) {
    console.error('Error extracting content:', error);
    showToast('‚ùå Error de conexi√≥n: ' + error.message, 'error');
  }
};</code></pre>
            </div>
        </div>
        
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-6">
            <h2 class="text-lg font-semibold text-gray-900 dark:text-gray-100 mb-4">
                Pasos para Aplicar el Fix
            </h2>
            
            <div class="space-y-4 text-gray-700 dark:text-gray-300">
                <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg">
                    <h3 class="font-semibold text-blue-800 dark:text-blue-200 mb-2">üìã Instrucciones:</h3>
                    <ol class="list-decimal list-inside space-y-2">
                        <li><strong>Copiar el c√≥digo</strong> de arriba</li>
                        <li><strong>Abrir ai.html</strong> en tu editor</li>
                        <li><strong>Buscar</strong> la funci√≥n <code>window.extractContent</code></li>
                        <li><strong>Reemplazar</strong> toda la funci√≥n con el c√≥digo corregido</li>
                        <li><strong>Guardar</strong> y subir a la nube</li>
                        <li><strong>Probar</strong> el bot√≥n "Extraer Contenido"</li>
                    </ol>
                </div>
                
                <div class="bg-yellow-50 dark:bg-yellow-900/20 p-4 rounded-lg">
                    <h3 class="font-semibold text-yellow-800 dark:text-yellow-200 mb-2">‚ö†Ô∏è Nota Importante:</h3>
                    <p>Este fix usa el endpoint <code>debug_view_button.php</code> que <strong>ya existe</strong> y <strong>ya funciona</strong>. No necesitas subir archivos nuevos.</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
