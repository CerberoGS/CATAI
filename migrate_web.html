<!DOCTYPE html>
<html lang="es-US">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Migraci√≥n IA Comportamental - CATAI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .log-success { color: #059669; }
        .log-error { color: #dc2626; }
        .log-warning { color: #d97706; }
        .log-info { color: #2563eb; }
        .log-section { font-weight: bold; margin-top: 1rem; }
        .log-detail { margin-left: 1rem; font-family: monospace; font-size: 0.875rem; }
    </style>
</head>
<body class="bg-gray-50 dark-mode:bg-gray-900">
    <div class="container mx-auto px-4 py-8">
        <div class="bg-white dark-mode:bg-gray-800 rounded-xl shadow-lg p-6">
            <div class="flex items-center gap-3 mb-6">
                <div class="text-4xl">üöÄ</div>
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 dark-mode:text-gray-100">Migraci√≥n IA Comportamental</h1>
                    <p class="text-gray-600 dark-mode:text-gray-300">Sistema de migraci√≥n seguro para producci√≥n</p>
                </div>
            </div>

            <div class="bg-yellow-50 dark-mode:bg-yellow-900/20 border border-yellow-200 dark-mode:border-yellow-800 rounded-lg p-4 mb-6">
                <div class="flex items-start gap-3">
                    <div class="text-2xl">‚ö†Ô∏è</div>
                    <div>
                        <h3 class="font-semibold text-yellow-800 dark-mode:text-yellow-200">Importante</h3>
                        <p class="text-sm text-yellow-700 dark-mode:text-yellow-300 mt-1">
                            Este archivo es temporal y debe eliminarse despu√©s de la migraci√≥n por seguridad.
                        </p>
                    </div>
                </div>
            </div>

            <div class="space-y-4">
                <button id="start-migration" class="w-full py-3 px-6 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-colors">
                    üöÄ Iniciar Migraci√≥n
                </button>
                
                <button id="diagnostic" class="w-full py-3 px-6 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-colors">
                    üî¨ Diagn√≥stico Completo
                </button>
                
                <button id="verify-tables" class="w-full py-3 px-6 bg-green-600 text-white rounded-lg hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transition-colors">
                    üîç Verificar Tablas
                </button>
                
                <button id="test-endpoints" class="w-full py-3 px-6 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-colors">
                    üß™ Probar Endpoints
                </button>
                
                <button id="fix-foreign-keys" class="w-full py-3 px-6 bg-orange-600 text-white rounded-lg hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-500 focus:ring-offset-2 transition-colors">
                    üîß Corregir Claves For√°neas
                </button>
                
                <button id="direct-migration" class="w-full py-3 px-6 bg-red-600 text-white rounded-lg hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2 transition-colors">
                    ‚ö° Migraci√≥n Directa
                </button>
            </div>

            <div id="migration-log" class="mt-6 bg-gray-900 text-green-400 p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto hidden">
                <div class="log-section">üìã Log de Migraci√≥n</div>
                <div id="log-content"></div>
            </div>

            <div id="migration-status" class="mt-6 hidden">
                <div class="bg-green-50 dark-mode:bg-green-900/20 border border-green-200 dark-mode:border-green-800 rounded-lg p-4">
                    <div class="flex items-center gap-3">
                        <div class="text-2xl">‚úÖ</div>
                        <div>
                            <h3 class="font-semibold text-green-800 dark-mode:text-green-200">Migraci√≥n Completada</h3>
                            <p class="text-sm text-green-700 dark-mode:text-green-300 mt-1">
                                El sistema de IA comportamental est√° listo para usar.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'api';
        
        function log(message, type = 'info') {
            const logContent = document.getElementById('log-content');
            const logContainer = document.getElementById('migration-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            
            logContent.appendChild(logEntry);
            logContainer.classList.remove('hidden');
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        function logSection(title) {
            const logContent = document.getElementById('log-content');
            const section = document.createElement('div');
            section.className = 'log-section';
            section.textContent = title;
            logContent.appendChild(section);
        }

        function logDetail(message) {
            const logContent = document.getElementById('log-content');
            const detail = document.createElement('div');
            detail.className = 'log-detail';
            detail.textContent = message;
            logContent.appendChild(detail);
        }

        async function startMigration() {
            const button = document.getElementById('start-migration');
            button.disabled = true;
            button.textContent = 'üîÑ Migrando...';
            
            logSection('üöÄ Iniciando Migraci√≥n del Sistema de IA Comportamental');
            log('Conectando a la base de datos...', 'info');
            
            try {
                // Paso 1: Verificar conexi√≥n a la base de datos
                log('Verificando conexi√≥n a la base de datos...', 'info');
                const healthResponse = await fetch(`${API_BASE}/db_check.php`);
                const healthData = await healthResponse.json();
                
                if (healthData.ok) {
                    log('‚úÖ Conexi√≥n a la base de datos verificada', 'success');
                } else {
                    log('‚ùå Error de conexi√≥n a la base de datos', 'error');
                    throw new Error('No se pudo conectar a la base de datos');
                }

                // Paso 2: Verificar estado actual de las tablas
                logSection('üîç Verificando Estado Actual de las Tablas');
                const verifyResponse = await fetch(`${API_BASE}/migrate_verify_safe.php`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                    }
                });
                
                const verifyData = await verifyResponse.json();
                
                if (verifyData.tables) {
                    verifyData.tables.forEach(table => {
                        if (table.exists) {
                            log(`‚úÖ ${table.name}: Existe (${table.rows} filas)`, 'success');
                        } else {
                            log(`‚ùå ${table.name}: No existe`, 'error');
                        }
                    });
                }

                // Paso 3: Crear tablas faltantes
                logSection('üìä Creando Tablas Faltantes');
                
                const tables = [
                    'ai_learning_metrics',
                    'ai_behavioral_patterns', 
                    'ai_analysis_history',
                    'ai_learning_events',
                    'ai_behavior_profiles'
                ];

                for (const table of tables) {
                    try {
                        log(`Procesando tabla: ${table}`, 'info');
                        
                        // Crear tabla usando endpoint de migraci√≥n
                        const createResponse = await fetch(`${API_BASE}/migrate_table_safe.php`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                            },
                            body: JSON.stringify({ table_name: table })
                        });
                        
                        const createData = await createResponse.json();
                        
                        if (createData.ok) {
                            log(`‚úÖ Tabla ${table}: ${createData.message} (${createData.rows} filas)`, 'success');
                        } else {
                            log(`‚ö†Ô∏è Tabla ${table}: ${createData.error || createData.message || 'Error desconocido'}`, 'warning');
                        }
                        
                    } catch (error) {
                        log(`‚ùå Error procesando tabla ${table}: ${error.message}`, 'error');
                    }
                }

                // Paso 4: Insertar datos iniciales
                logSection('üîß Insertando Datos Iniciales');
                
                try {
                    const initResponse = await fetch(`${API_BASE}/migrate_init_data_safe.php`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                        }
                    });
                    
                    const initData = await initResponse.json();
                    
                    if (initData.ok) {
                        log('‚úÖ Datos iniciales procesados correctamente', 'success');
                        logDetail(`Usuarios procesados: ${initData.users_processed || 0}`);
                        logDetail(`Total de usuarios: ${initData.total_users || 0}`);
                        
                        if (initData.errors && initData.errors.length > 0) {
                            log('‚ö†Ô∏è Errores encontrados:', 'warning');
                            initData.errors.forEach(error => {
                                logDetail(`- ${error}`, 'warning');
                            });
                        }
                    } else {
                        log('‚ùå Error insertando datos iniciales: ' + (initData.error || initData.message || 'Error desconocido'), 'error');
                    }
                    
                } catch (error) {
                    log('‚ùå Error en datos iniciales: ' + error.message, 'error');
                }

                // Paso 5: Verificaci√≥n final
                logSection('üîç Verificaci√≥n Final');
                await verifyTables();

                logSection('üéâ Migraci√≥n Completada');
                log('El sistema de IA comportamental est√° listo para usar', 'success');
                
                // Mostrar estado de √©xito
                document.getElementById('migration-status').classList.remove('hidden');
                
            } catch (error) {
                log(`üí• Error fatal: ${error.message}`, 'error');
                log('Revisa los logs anteriores para m√°s detalles', 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'üöÄ Iniciar Migraci√≥n';
            }
        }

        async function verifyTables() {
            log('Verificando tablas creadas...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/migrate_verify_safe.php`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                    }
                });
                
                const data = await response.json();
                
                if (data.ok) {
                    log('‚úÖ Verificaci√≥n completada exitosamente', 'success');
                    
                    if (data.tables) {
                        data.tables.forEach(table => {
                            if (table.exists) {
                                log(`‚úÖ ${table.name}: Existe (${table.rows} filas)`, 'success');
                            } else {
                                log(`‚ùå ${table.name}: No existe`, 'error');
                            }
                        });
                    }
                    
                    if (data.structure_ok) {
                        log('‚úÖ Estructura de tablas correcta', 'success');
                    } else {
                        log('‚ö†Ô∏è Estructura de tablas puede tener problemas', 'warning');
                    }
                    
                    if (data.users_with_metrics > 0) {
                        log(`‚úÖ ${data.users_with_metrics} usuarios con m√©tricas`, 'success');
                    }
                    
                    if (data.users_with_profiles > 0) {
                        log(`‚úÖ ${data.users_with_profiles} usuarios con perfiles`, 'success');
                    }
                    
                    if (data.migration_complete) {
                        log('üéâ Migraci√≥n completamente exitosa', 'success');
                    } else {
                        log('‚ö†Ô∏è Migraci√≥n parcialmente exitosa', 'warning');
                    }
                    
                } else {
                    log('‚ùå Error en verificaci√≥n: ' + (data.error || data.message || 'Error desconocido'), 'error');
                    
                    if (data.tables) {
                        data.tables.forEach(table => {
                            if (table.exists) {
                                log(`‚úÖ ${table.name}: Existe (${table.rows} filas)`, 'success');
                            } else {
                                log(`‚ùå ${table.name}: No existe`, 'error');
                            }
                        });
                    }
                }
                
            } catch (error) {
                log('‚ùå Error verificando tablas: ' + error.message, 'error');
            }
        }

        async function testEndpoints() {
            logSection('üß™ Probando Endpoints de IA Comportamental');
            
            const endpoints = [
                'ai_learning_metrics_safe.php',
                'ai_behavioral_patterns_safe.php',
                'ai_analysis_history_safe.php',
                'ai_analysis_save_safe.php'
            ];

            for (const endpoint of endpoints) {
                try {
                    log(`Probando endpoint: ${endpoint}`, 'info');
                    
                    const response = await fetch(`${API_BASE}/${endpoint}`, {
                        headers: {
                            'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        log(`‚úÖ ${endpoint}: Funcionando correctamente`, 'success');
                    } else {
                        log(`‚ùå ${endpoint}: ${data.error || 'Error desconocido'}`, 'error');
                    }
                    
                } catch (error) {
                    log(`‚ùå ${endpoint}: ${error.message}`, 'error');
                }
            }
        }

        async function runDiagnostic() {
            const button = document.getElementById('diagnostic');
            button.disabled = true;
            button.textContent = 'üî¨ Diagnosticando...';
            
            logSection('üî¨ Diagn√≥stico Completo del Sistema');
            log('Ejecutando diagn√≥stico detallado...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/migrate_diagnostic_safe.php`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                    }
                });
                
                const data = await response.json();
                
                if (data.database_connection) {
                    log('‚úÖ Conexi√≥n a la base de datos: OK', 'success');
                } else {
                    log('‚ùå Conexi√≥n a la base de datos: FALLO', 'error');
                }
                
                log(`üìä Total de usuarios: ${data.total_users || 0}`, 'info');
                log(`üë• Usuarios con m√©tricas: ${data.users_with_metrics || 0}`, 'info');
                log(`üë§ Usuarios con perfiles: ${data.users_with_profiles || 0}`, 'info');
                
                logSection('üìã Estado de las Tablas');
                
                if (data.tables_status) {
                    data.tables_status.forEach(table => {
                        if (table.exists) {
                            if (table.structure_ok) {
                                log(`‚úÖ ${table.name}: OK (${table.rows} filas)`, 'success');
                            } else {
                                log(`‚ö†Ô∏è ${table.name}: Existe pero con problemas (${table.rows} filas)`, 'warning');
                                table.errors.forEach(error => {
                                    logDetail(`- ${error}`, 'warning');
                                });
                            }
                        } else {
                            log(`‚ùå ${table.name}: No existe`, 'error');
                            table.errors.forEach(error => {
                                logDetail(`- ${error}`, 'error');
                            });
                        }
                    });
                }
                
                if (data.errors && data.errors.length > 0) {
                    logSection('‚ùå Errores Encontrados');
                    data.errors.forEach(error => {
                        log(`- ${error}`, 'error');
                    });
                }
                
                if (data.recommendations && data.recommendations.length > 0) {
                    logSection('üí° Recomendaciones');
                    data.recommendations.forEach(rec => {
                        log(`- ${rec}`, 'info');
                    });
                }
                
                if (data.migration_status) {
                    logSection('üìà Estado de la Migraci√≥n');
                    log(`Tablas existentes: ${data.migration_status.all_tables_exist ? '‚úÖ' : '‚ùå'}`, 
                        data.migration_status.all_tables_exist ? 'success' : 'error');
                    log(`Estructura correcta: ${data.migration_status.all_structures_ok ? '‚úÖ' : '‚ùå'}`, 
                        data.migration_status.all_structures_ok ? 'success' : 'error');
                    log(`Datos inicializados: ${data.migration_status.data_initialized ? '‚úÖ' : '‚ùå'}`, 
                        data.migration_status.data_initialized ? 'success' : 'error');
                    log(`Listo para usar: ${data.migration_status.ready_for_use ? '‚úÖ' : '‚ùå'}`, 
                        data.migration_status.ready_for_use ? 'success' : 'error');
                }
                
            } catch (error) {
                log(`‚ùå Error en diagn√≥stico: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'üî¨ Diagn√≥stico Completo';
            }
        }

        async function fixForeignKeys() {
            const button = document.getElementById('fix-foreign-keys');
            button.disabled = true;
            button.textContent = 'üîß Corrigiendo...';
            
            logSection('üîß Correcci√≥n de Claves For√°neas');
            log('Analizando estructura de la tabla users...', 'info');
            
            try {
                // Paso 1: Obtener diagn√≥stico de claves for√°neas
                const diagnosticResponse = await fetch(`${API_BASE}/migrate_fix_foreign_keys_safe.php`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                    }
                });
                
                const diagnosticData = await diagnosticResponse.json();
                
                if (diagnosticData.users_table_structure && diagnosticData.users_table_structure.length > 0) {
                    log('‚úÖ Estructura de tabla users obtenida', 'success');
                    
                    if (diagnosticData.id_column_info) {
                        const idCol = diagnosticData.id_column_info;
                        log(`üìã Columna id: ${idCol.Type} ${idCol.Null === 'YES' ? 'NULL' : 'NOT NULL'}`, 'info');
                        log(`üîß Tipo detectado: ${idCol.Type}`, 'info');
                    }
                    
                    if (diagnosticData.recommended_fixes && diagnosticData.recommended_fixes.length > 0) {
                        log('üí° Recomendaciones:', 'info');
                        diagnosticData.recommended_fixes.forEach(fix => {
                            log(`- ${fix}`, 'info');
                        });
                    }
                } else {
                    log('‚ùå No se pudo obtener estructura de tabla users', 'error');
                    return;
                }
                
                // Paso 2: Crear tablas con estructura corregida
                logSection('üìä Creando Tablas con Estructura Corregida');
                
                const tables = [
                    'ai_learning_metrics',
                    'ai_behavioral_patterns', 
                    'ai_analysis_history',
                    'ai_learning_events',
                    'ai_behavior_profiles'
                ];

                for (const table of tables) {
                    try {
                        log(`Creando tabla: ${table}`, 'info');
                        
                        const createResponse = await fetch(`${API_BASE}/migrate_execute_fixed_safe.php`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                            },
                            body: JSON.stringify({ table_name: table })
                        });
                        
                        const createData = await createResponse.json();
                        
                        if (createData.ok) {
                            log(`‚úÖ ${table}: ${createData.message} (${createData.rows} filas)`, 'success');
                            log(`üîß Tipo user_id usado: ${createData.user_id_type}`, 'info');
                        } else {
                            log(`‚ùå ${table}: ${createData.error || createData.message || 'Error desconocido'}`, 'error');
                        }
                        
                    } catch (error) {
                        log(`‚ùå Error creando tabla ${table}: ${error.message}`, 'error');
                    }
                }
                
                // Paso 3: Verificaci√≥n final
                logSection('üîç Verificaci√≥n Final');
                await verifyTables();
                
                logSection('üéâ Correcci√≥n Completada');
                log('Las tablas han sido creadas con la estructura corregida', 'success');
                
            } catch (error) {
                log(`‚ùå Error en correcci√≥n: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = 'üîß Corregir Claves For√°neas';
            }
        }

        async function directMigration() {
            const button = document.getElementById('direct-migration');
            button.disabled = true;
            button.textContent = '‚ö° Migrando...';
            
            logSection('‚ö° Migraci√≥n Directa con Estructura Corregida');
            log('Usando estructura conocida: BIGINT(20) UNSIGNED NOT NULL', 'info');
            
            try {
                // Paso 1: Crear tablas
                log('Creando tablas con estructura corregida...', 'info');
                
                const createResponse = await fetch(`${API_BASE}/migrate_direct_safe.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                    },
                    body: JSON.stringify({ action: 'create_tables' })
                });
                
                const createData = await createResponse.json();
                
                if (createData.results) {
                    createData.results.forEach(result => {
                        if (result.status === 'success') {
                            log(`‚úÖ ${result.table}: ${result.message} (${result.rows} filas)`, 'success');
                        } else {
                            log(`‚ùå ${result.table}: ${result.message}`, 'error');
                        }
                    });
                }
                
                // Paso 2: Insertar datos iniciales
                logSection('üîß Insertando Datos Iniciales');
                
                const initResponse = await fetch(`${API_BASE}/migrate_direct_safe.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('auth_token') || ''}`
                    },
                    body: JSON.stringify({ action: 'insert_initial_data' })
                });
                
                const initData = await initResponse.json();
                
                if (initData.results && initData.results.length > 0) {
                    const result = initData.results[0];
                    if (result.status === 'success') {
                        log(`‚úÖ Datos iniciales: ${result.message}`, 'success');
                        log(`üë• Usuarios procesados: ${result.users_processed}/${result.total_users}`, 'info');
                        
                        if (result.errors && result.errors.length > 0) {
                            log('‚ö†Ô∏è Errores encontrados:', 'warning');
                            result.errors.forEach(error => {
                                log(`- ${error}`, 'warning');
                            });
                        }
                    } else {
                        log(`‚ùå Error en datos iniciales: ${result.message}`, 'error');
                    }
                }
                
                // Paso 3: Verificaci√≥n final
                logSection('üîç Verificaci√≥n Final');
                await verifyTables();
                
                logSection('üéâ Migraci√≥n Directa Completada');
                log('Sistema de IA comportamental listo para usar', 'success');
                
                // Mostrar estado de √©xito
                document.getElementById('migration-status').classList.remove('hidden');
                
            } catch (error) {
                log(`‚ùå Error en migraci√≥n directa: ${error.message}`, 'error');
            } finally {
                button.disabled = false;
                button.textContent = '‚ö° Migraci√≥n Directa';
            }
        }

        // Event listeners
        document.getElementById('start-migration').addEventListener('click', startMigration);
        document.getElementById('diagnostic').addEventListener('click', runDiagnostic);
        document.getElementById('verify-tables').addEventListener('click', verifyTables);
        document.getElementById('test-endpoints').addEventListener('click', testEndpoints);
        document.getElementById('fix-foreign-keys').addEventListener('click', fixForeignKeys);
        document.getElementById('direct-migration').addEventListener('click', directMigration);

        // Verificar autenticaci√≥n al cargar
        window.addEventListener('load', () => {
            const token = localStorage.getItem('auth_token');
            if (!token) {
                log('‚ö†Ô∏è No hay token de autenticaci√≥n. Algunas funciones pueden fallar.', 'warning');
                log('Inicia sesi√≥n en la aplicaci√≥n principal primero.', 'info');
            } else {
                log('‚úÖ Token de autenticaci√≥n encontrado', 'success');
            }
        });
    </script>
</body>
</html>
